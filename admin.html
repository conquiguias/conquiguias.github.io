<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Panel de Administraci√≥n - Sistema de Evaluaciones</title>
  <style>
    /* Estilos para el sistema de evaluaci√≥n */
    .evaluation-creator {
      background: #f8f9fa;
      border: 2px dashed #dee2e6;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
    }

    .evaluation-creator h3 {
      color: #495057;
      margin-bottom: 15px;
    }

    .question-item {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin: 10px 0;
      position: relative;
    }

    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .question-type {
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: bold;
    }

    .multiple-choice { background: #e3f2fd; color: #1976d2; }
    .true-false { background: #f3e5f5; color: #7b1fa2; }

    .option-item {
      display: flex;
      align-items: center;
      margin: 8px 0;
      padding: 8px;
      background: #f8f9fa;
      border-radius: 5px;
    }

    .option-item input[type="text"] {
      flex: 1;
      margin: 0 10px;
      padding: 8px;
      border: 1px solid #ced4da;
      border-radius: 4px;
    }

    .option-item input[type="radio"] {
      margin-right: 10px;
    }

    .btn-add-question, .btn-add-option, .btn-remove {
      padding: 8px 15px;
      margin: 5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-add-question { background: #28a745; color: white; }
    .btn-add-option { background: #17a2b8; color: white; }
    .btn-remove { background: #dc3545; color: white; }

    .preview-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
    }

    .preview-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }

    .exam-question {
      margin: 15px 0;
      padding: 15px;
      border: 1px solid #e9ecef;
      border-radius: 8px;
    }
  </style>
</head>

<body>
  <img src="logo1.png" style="width: 25%;" alt="">
  <h2>Crear nuevo formulario de Asistencia con Evaluaci√≥n</h2>
  
  <form id="crearFormulario">
    <label>ID del formulario (ej. nombre y apellido de instructor):</label><br>
    <input type="text" id="formId" required><br><br>
    
    <label>T√≠tulo: (ej. Especialidad de Flores)</label><br>
    <input type="text" id="titulo" required><br><br>
    
    <input type="hidden" id="fechaCierre">
    
    <!-- Sistema de creaci√≥n de evaluaci√≥n -->
    <div class="evaluation-creator">
      <h3>üìù Crear Evaluaci√≥n para esta Especialidad</h3>
      <div id="questionsContainer">
        <!-- Las preguntas se agregar√°n aqu√≠ din√°micamente -->
      </div>
      
      <button type="button" class="btn-add-question" onclick="addQuestion('multiple')">
        ‚ûï Agregar Pregunta de Opci√≥n M√∫ltiple
      </button>
      <button type="button" class="btn-add-question" onclick="addQuestion('truefalse')">
        ‚ûï Agregar Pregunta Verdadero/Falso
      </button>
      
      <div style="margin-top: 20px;">
        <button type="button" onclick="previewExam()" style="background: #6c757d; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer;">
          üëÅÔ∏è Previsualizar Examen
        </button>
      </div>
    </div>

    <button type="submit">Crear Formulario con Evaluaci√≥n</button>
  </form>

  <p id="mensaje"></p>
  
  <button id="btnLimpiarFormularios">üßπ Limpiar formularios vencidos</button>
  <p id="resultadoLimpieza"></p>

  <h3>üìã Formularios creados:</h3>
  <table id="tablaFormularios" border="1" style="border-collapse: collapse; width: 100%;">
    <thead>
      <tr>
        <th>#</th>
        <th>ID</th>
        <th>T√≠tulo</th>
        <th>Fecha de cierre</th>
        <th>Creado</th>
        <th>Acci√≥n</th>
        <th>Evaluaci√≥n</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- Modal para previsualizar examen -->
  <div id="previewModal" class="preview-modal">
    <div class="preview-content">
      <h3>Previsualizaci√≥n del Examen</h3>
      <div id="previewQuestions"></div>
      <button onclick="closePreview()" style="background: #6c757d; color: white; padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; margin-top: 15px;">
        Cerrar
      </button>
    </div>
  </div>

  <script>
    const baseURL = location.origin;
    let questions = [];

    // Funci√≥n para agregar pregunta
    function addQuestion(type) {
      const questionId = 'q' + Date.now();
      const question = {
        id: questionId,
        type: type,
        text: '',
        options: type === 'multiple' ? 
          [{ id: 'opt1', text: '', correct: false }, { id: 'opt2', text: '', correct: false }] :
          [{ id: 'true', text: 'Verdadero', correct: false }, { id: 'false', text: 'Falso', correct: false }]
      };
      
      questions.push(question);
      renderQuestions();
    }

    // Funci√≥n para renderizar preguntas
    function renderQuestions() {
      const container = document.getElementById('questionsContainer');
      container.innerHTML = '';

      questions.forEach((question, index) => {
        const questionHtml = `
          <div class="question-item">
            <div class="question-header">
              <strong>Pregunta ${index + 1}</strong>
              <span class="question-type ${question.type === 'multiple' ? 'multiple-choice' : 'true-false'}">
                ${question.type === 'multiple' ? 'Opci√≥n M√∫ltiple' : 'Verdadero/Falso'}
              </span>
            </div>
            
            <input type="text" 
                   placeholder="Escribe la pregunta aqu√≠..." 
                   value="${question.text}"
                   onchange="updateQuestionText('${question.id}', this.value)"
                   style="width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #ced4da; border-radius: 4px;">
            
            <div class="options-container">
              ${question.options.map(option => `
                <div class="option-item">
                  <input type="radio" 
                         name="${question.id}" 
                         ${option.correct ? 'checked' : ''}
                         onchange="setCorrectAnswer('${question.id}', '${option.id}')">
                  <input type="text" 
                         value="${option.text}" 
                         ${question.type === 'truefalse' ? 'readonly' : ''}
                         onchange="updateOptionText('${question.id}', '${option.id}', this.value)"
                         style="flex: 1; padding: 5px; border: 1px solid #ced4da; border-radius: 4px;">
                  ${question.type === 'multiple' ? `
                    <button class="btn-remove" onclick="removeOption('${question.id}', '${option.id}')">‚ùå</button>
                  ` : ''}
                </div>
              `).join('')}
            </div>

            ${question.type === 'multiple' ? `
              <button class="btn-add-option" onclick="addOption('${question.id}')">
                ‚ûï Agregar Opci√≥n
              </button>
            ` : ''}
            
            <button class="btn-remove" onclick="removeQuestion('${question.id}')" style="margin-top: 10px;">
              üóëÔ∏è Eliminar Pregunta
            </button>
          </div>
        `;
        container.innerHTML += questionHtml;
      });
    }

    // Funciones para manejar preguntas y opciones
    function updateQuestionText(questionId, text) {
      const question = questions.find(q => q.id === questionId);
      if (question) question.text = text;
    }

    function updateOptionText(questionId, optionId, text) {
      const question = questions.find(q => q.id === questionId);
      if (question) {
        const option = question.options.find(opt => opt.id === optionId);
        if (option) option.text = text;
      }
    }

    function setCorrectAnswer(questionId, optionId) {
      const question = questions.find(q => q.id === questionId);
      if (question) {
        question.options.forEach(option => {
          option.correct = option.id === optionId;
        });
      }
    }

    function addOption(questionId) {
      const question = questions.find(q => q.id === questionId);
      if (question && question.options.length < 4) {
        const newOptionId = 'opt' + (question.options.length + 1);
        question.options.push({ id: newOptionId, text: '', correct: false });
        renderQuestions();
      }
    }

    function removeOption(questionId, optionId) {
      const question = questions.find(q => q.id === questionId);
      if (question && question.options.length > 2) {
        question.options = question.options.filter(opt => opt.id !== optionId);
        renderQuestions();
      }
    }

    function removeQuestion(questionId) {
      questions = questions.filter(q => q.id !== questionId);
      renderQuestions();
    }

    // Previsualizaci√≥n del examen
    function previewExam() {
      const previewContainer = document.getElementById('previewQuestions');
      previewContainer.innerHTML = '';

      if (questions.length === 0) {
        previewContainer.innerHTML = '<p>No hay preguntas para mostrar.</p>';
      } else {
        questions.forEach((question, index) => {
          const questionHtml = `
            <div class="exam-question">
              <p><strong>Pregunta ${index + 1}:</strong> ${question.text || '[Pregunta sin texto]'}</p>
              <div>
                ${question.options.map(option => `
                  <div style="margin: 5px 0;">
                    <input type="radio" name="preview_${question.id}" disabled>
                    <label>${option.text}</label>
                    ${option.correct ? ' ‚úÖ' : ''}
                  </div>
                `).join('')}
              </div>
            </div>
          `;
          previewContainer.innerHTML += questionHtml;
        });
      }

      document.getElementById('previewModal').style.display = 'block';
    }

    function closePreview() {
      document.getElementById('previewModal').style.display = 'none';
    }

    // Validaci√≥n antes de enviar el formulario
    document.getElementById("crearFormulario").addEventListener("submit", function (e) {
      e.preventDefault();

      // Validar que todas las preguntas tengan texto y al menos una respuesta correcta
      let isValid = true;
      let errorMessage = '';

      questions.forEach((question, index) => {
        if (!question.text.trim()) {
          isValid = false;
          errorMessage = `La pregunta ${index + 1} no tiene texto.`;
          return;
        }

        const hasCorrectAnswer = question.options.some(opt => opt.correct);
        if (!hasCorrectAnswer) {
          isValid = false;
          errorMessage = `La pregunta ${index + 1} no tiene una respuesta correcta seleccionada.`;
          return;
        }

        if (question.type === 'multiple') {
          const emptyOptions = question.options.filter(opt => !opt.text.trim());
          if (emptyOptions.length > 0) {
            isValid = false;
            errorMessage = `La pregunta ${index + 1} tiene opciones vac√≠as.`;
            return;
          }
        }
      });

      if (!isValid) {
        alert('‚ùå Error en la evaluaci√≥n: ' + errorMessage);
        return;
      }

      // Continuar con el env√≠o del formulario...
      const rawId = document.getElementById("formId").value.trim();
      const idPalabras = rawId.split(/\s+/).filter(Boolean);
      const formId = idPalabras.map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join("");
      
      document.getElementById("formId").value = formId;
      
      const rawTitulo = document.getElementById("titulo").value.trim();
      const tituloPalabras = rawTitulo.split(/\s+/).filter(Boolean);
      const tituloP = tituloPalabras.map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(" ");
      document.getElementById("titulo").value = tituloP;

      let id = document.getElementById("formId").value.trim();
      let titulo = document.getElementById("titulo").value.trim();
      id = id + "-" + generarIdAlfanumerico();

      function generarIdAlfanumerico() {
        const caracteres = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
        let id = "";
        for (let i = 0; i < 6; i++) {
          id += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
        }
        return id;
      }

      const ahora = new Date();
      const fechaCierre = new Date(ahora.getTime() + 70 * 60 * 1000).toISOString();
      document.getElementById("fechaCierre").value = fechaCierre;

      // Enviar formulario y evaluaci√≥n
      fetch("/api/guardarFormulario", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ 
          id, 
          titulo, 
          fechaCierre: fechaCierre,
          evaluation: questions 
        })
      })
      .then(res => {
        if (!res.ok) throw new Error("No se pudo guardar");
        const enlace = `${baseURL}/formulario.html?id=${encodeURIComponent(id)}`;
        document.getElementById("mensaje").innerHTML = `
          ‚úÖ Formulario con evaluaci√≥n creado con √©xito.<br>
          üëâ <a href="${enlace}" target="_blank">${enlace}</a>
          <br><button onclick="navigator.clipboard.writeText('${enlace}')">üìã Copiar enlace</button>
        `;
        questions = []; // Limpiar preguntas
        renderQuestions();
        cargarFormularios();
      })
      .catch(err => {
        console.error(err);
        document.getElementById("mensaje").textContent = "‚ùå Error al guardar.";
      });
    });

    // El resto del c√≥digo existente (cargarFormularios, limpiar formularios, etc.)
    document.getElementById("btnLimpiarFormularios").addEventListener("click", async () => {
      const pResultado = document.getElementById("resultadoLimpieza");
      pResultado.textContent = "Procesando... ‚è≥";

      try {
        const res = await fetch("/api/limpiarFormulariosVencidos");
        const data = await res.json();

        if (res.ok) {
          pResultado.textContent = `‚úÖ ${data.mensaje}`;
        } else {
          pResultado.textContent = `‚ùå Error: ${data.error}`;
        }
      } catch (err) {
        console.error(err);
        pResultado.textContent = "‚ùå Ocurri√≥ un error inesperado al limpiar.";
      }
    });

    async function cargarFormularios() {
      const tabla = document.querySelector("#tablaFormularios tbody");
      tabla.innerHTML = "<tr><td colspan='7'>Cargando formularios...</td></tr>";

      try {
        const res = await fetch("/api/listarFormularios");
        if (!res.ok) throw new Error("No se pudo cargar");

        const data = await res.json();
        const claves = Object.keys(data);

        if (!claves.length) {
          tabla.innerHTML = "<tr><td colspan='7'>No hay formularios creados.</td></tr>";
          return;
        }

        tabla.innerHTML = "";
        claves.forEach((id, i) => {
          const f = data[id];
          const fila = `
            <tr>
              <td>${i + 1}</td>
              <td>${id}</td>
              <td>${f.titulo}</td>
              <td>${new Date(f.fechaCierre).toLocaleString()}</td>
              <td>${f.creado ? new Date(f.creado).toLocaleString() : '‚Äï'}</td>
              <td>
                <a href="${baseURL}/formulario.html?id=${id}" target="_blank">
                  <button>üëÅ Ver registros</button>
                </a>
                <button onclick="navigator.clipboard.writeText('${baseURL}/formulario.html?id=${id}')">üìã Copiar enlace</button>
              </td>
              <td>
                <button onclick="verEvaluacion('${id}')" style="background: #17a2b8; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                  üìä Ver Evaluaci√≥n
                </button>
              </td>
            </tr>
          `;
          tabla.insertAdjacentHTML("beforeend", fila);
        });
      } catch (e) {
        console.error(e);
        tabla.innerHTML = "<tr><td colspan='7'>‚ùå Error al cargar formularios.</td></tr>";
      }
    }

    // Funci√≥n para ver evaluaci√≥n existente
    async function verEvaluacion(formId) {
      try {
        const res = await fetch(`/api/obtenerEvaluacion?id=${formId}`);
        if (res.ok) {
          const evaluacion = await res.json();
          questions = evaluacion;
          previewExam();
        } else {
          alert('Este formulario no tiene evaluaci√≥n asociada.');
        }
      } catch (error) {
        console.error('Error al obtener evaluaci√≥n:', error);
        alert('Error al cargar la evaluaci√≥n.');
      }
    }

    // Ejecutar cuando cargue la p√°gina
    document.addEventListener("DOMContentLoaded", () => {
      cargarFormularios();
    });
  </script>
</body>
</html>