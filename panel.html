<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Panel del Usuario</title>
  <style>
    /* Reset b√°sico */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* Body y contenedor principal */
    body {
      display: flex;
      height: 100vh;
      background: #eef2f7;
      color: #333;
    }

    /* Men√∫ lateral */
    #sidebar {
      width: 220px;
      background: linear-gradient(180deg, #1976d2, #1565c0);
      color: #fff;
      display: flex;
      flex-direction: column;
      padding: 20px 0;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
    }

    #sidebar h2 {
      text-align: center;
      margin-bottom: 25px;
      font-size: 22px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    #sidebar button {
      padding: 12px 20px;
      margin: 5px 10px;
      border: none;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      color: #fff;
      cursor: pointer;
      text-align: left;
      font-size: 15px;
      transition: background 0.3s, transform 0.2s;
    }

    #sidebar button:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateX(5px);
    }

    #sidebar button.active {
      background: rgba(255, 255, 255, 0.3);
      font-weight: bold;
    }

    #sidebar #logoutBtn {
      margin-top: auto;
      background: #e53935;
    }

    #sidebar #logoutBtn:hover {
      background: #b71c1c;
      transform: translateX(0);
    }

    /* Contenido principal */
    #mainContent {
      flex: 1;
      padding: 25px;
      overflow-y: auto;
    }

    /* Cards */
    .card {
      background: #fff;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
      max-width: 650px;
      margin: 20px auto;
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .card:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
    }

    /* Inputs y selects */
    input,
    select {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
      transition: border 0.3s, box-shadow 0.3s;
    }

    input:focus,
    select:focus {
      border-color: #1976d2;
      box-shadow: 0 0 5px rgba(25, 118, 210, 0.5);
      outline: none;
    }

    /* Botones */
    button.saveBtn,
    button#crearEspecialidad,
    button#subirArchivoBtn {
      background: #1976d2;
      color: #fff;
      cursor: pointer;
      padding: 12px;
      border-radius: 8px;
      border: none;
      font-size: 15px;
      transition: background 0.3s, transform 0.2s;
    }

    button.saveBtn:hover,
    button#crearEspecialidad:hover,
    button#subirArchivoBtn:hover {
      background: #125aa0;
      transform: translateY(-2px);
    }

    /* Bot√≥n eliminar foto */
    #removePhoto {
      background: #e53935;
      margin-top: 5px;
    }

    #removePhoto:hover {
      background: #b71c1c;
      transform: translateY(-2px);
    }

    /* Listas de archivos y especialidades */
    ul {
      list-style: none;
      padding-left: 0;
      margin-top: 10px;
    }

    ul li {
      padding: 10px 12px;
      border-radius: 6px;
      margin-bottom: 6px;
      background: #f4f6f8;
      transition: background 0.3s;
    }

    ul li:hover {
      background: #e0e7f1;
    }

    ul li a {
      text-decoration: none;
      color: #1976d2;
      font-weight: 500;
    }

    ul li a:hover {
      text-decoration: underline;
    }

    /* Encabezados */
    h2,
    h3,
    h4 {
      color: #333;
      margin-bottom: 15px;
    }

    /* Ocultar secciones */
    .hidden {
      display: none;
    }

    .carpeta-item {
      cursor: pointer;
      background: #f3f3f3;
      margin: 6px 0;
      padding: 10px;
      border-radius: 8px;
      transition: background 0.3s;
    }

    .carpeta-item:hover {
      background: #dce8ff;
    }

    .archivo-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #f8f9fa;
      padding: 8px 12px;
      border-radius: 6px;
      margin: 5px 0;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .archivo-item a {
      color: #007bff;
      text-decoration: none;
      font-weight: 500;
    }

    .archivo-item a:hover {
      text-decoration: underline;
    }

    .delete-btn {
      border: none;
      background: transparent;
      font-size: 18px;
      cursor: pointer;
      color: #e74c3c;
      transition: transform 0.2s;
    }

    .delete-btn:hover {
      transform: scale(1.2);
    }

    /* üîπ Fondo del visor */
    #pdfViewerModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    /* üîπ Contenedor del visor */
    .pdf-viewer-content {
      position: relative;
      width: 90%;
      height: 90%;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
      animation: fadeIn 0.3s ease;
    }

    /* üîπ Bot√≥n de cerrar */
    .cerrar-pdf {
      position: absolute;
      top: 10px;
      right: 15px;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      font-size: 18px;
      cursor: pointer;
      z-index: 10;
      transition: background 0.3s;
    }

    .cerrar-pdf:hover {
      background: #c0392b;
    }

    /* üîπ PDF dentro del visor */
    .pdf-viewer-content iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* üîπ Animaci√≥n */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    #ordenContainer {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #ordenSelect {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }

    /* üîπ Fondo del modal */
    #mensajeModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    /* üîπ Caja del mensaje */
    .mensaje-content {
      background: #fff;
      padding: 25px 30px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.25);
      text-align: center;
      width: 90%;
      max-width: 400px;
      animation: fadeIn 0.25s ease;
    }

    .mensaje-content h3 {
      margin-bottom: 12px;
      color: #1976d2;
    }

    .mensaje-content p {
      margin-bottom: 20px;
      color: #333;
    }

    /* üîπ Botones */
    #mensajeBotones {
      display: flex;
      justify-content: center;
      gap: 15px;
    }

    #mensajeBotones button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 15px;
      transition: transform 0.2s, background 0.3s;
    }

    #mensajeAceptar {
      background: #1976d2;
      color: white;
    }

    #mensajeCancelar {
      background: #e53935;
      color: white;
    }

    #mensajeBotones button:hover {
      transform: scale(1.05);
    }

    .hiddenX {
      display: none !important;
    }

    /* Niveles en filas de 3 */
    .niveles {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .nivel {
      flex: 1;
      padding: 12px;
      background: #1976d2;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .nivel:hover {
      transform: scale(1.05);
    }

    /* Carpetas tipo Windows */
    .secciones-conquistadores {
      list-style: none;
      padding-left: 0;
    }

    .seccion-item {
      margin: 6px 0;
    }

    .seccion-titulo {
      display: flex;
      align-items: center;
      padding: 10px;
      background: #f3f3f3;
      border-radius: 4px;
      cursor: pointer;
      border: 1px solid #ccc;
      transition: background 0.2s;
    }

    .seccion-titulo::before {
      content: "üìÅ";
      margin-right: 8px;
    }

    .seccion-titulo.abierto::before {
      content: "üìÇ";
    }

    .seccion-titulo:hover {
      background: #dce8ff;
    }

    .seccion-contenido {
      padding: 10px 20px;
      margin-top: 4px;
      border-left: 4px solid #1976d2;
      background: #fff;
      border-radius: 0 4px 4px 0;
    }

    /* Estilos para la secci√≥n de certificaciones */
    /* Estilos espec√≠ficos para la secci√≥n de certificaciones */
    .card-certificaciones {
      max-width: none !important;
      width: calc(100% - 20px) !important;
      margin: 10px !important;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
      background: #fff;
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .card-certificaciones:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
    }

    #certificacionesSection {
      width: 100%;
      padding: 0;
    }

    #certificacionesContadores {
      background: #e8f4fd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
    }

    #certificacionesContadores p {
      margin: 5px 0;
      font-weight: bold;
      color: #2c3e50;
    }

    #certificacionesContadores span {
      color: #e74c3c;
      font-size: 18px;
    }

    #tablaCertificaciones {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    #tablaCertificaciones thead {
      background: #34495e;
      color: white;
    }

    #tablaCertificaciones th {
      padding: 12px 15px;
      text-align: left;
      font-weight: 600;
    }

    #tablaCertificaciones tbody tr {
      border-bottom: 1px solid #ddd;
      transition: background-color 0.3s ease;
    }

    #tablaCertificaciones tbody tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    #tablaCertificaciones tbody tr:hover {
      background-color: #e8f4fd;
    }

    #tablaCertificaciones td {
      padding: 10px 15px;
    }

    .estado-completado {
      color: #27ae60;
      font-weight: bold;
    }

    .estado-pendiente {
      color: #e67e22;
      font-weight: bold;
    }

    .estado-incompleto {
      color: #e74c3c;
      font-weight: bold;
    }

    .calificacion-aprobada {
      color: #27ae60;
      font-weight: bold;
    }

    .calificacion-reprobada {
      color: #e74c3c;
      font-weight: bold;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Header fijo con informaci√≥n del usuario */
    #userHeader {
      position: fixed;
      top: 20px;
      right: 30px;
      display: flex;
      align-items: center;
      gap: 15px;
      background: rgba(255, 255, 255, 0.95);
      padding: 10px 20px;
      border-radius: 50px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      z-index: 100;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    #userHeader img {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #1976d2;
    }

    #userHeader span {
      font-weight: 600;
      color: #2c3e50;
      font-size: 16px;
    }

    /* Ajustar el contenido principal para el header fijo */
    #mainContent {
      flex: 1;
      padding: 25px;
      overflow-y: auto;
      position: relative;
    }
  </style>
</head>

<body>

  <!-- Men√∫ lateral -->
  <div id="sidebar">
    <h2></h2>
    <button id="menuInicio" class="active">Inicio</button>
    <button id="menuClubes">Clubes</button>
    <button id="menuCertificaciones">Certificaciones</button>
    <button id="menuEspecialidades">Especialidades Storage</button>
    <button id="menuPerfil">Perfil</button>
    <button id="logoutBtn">Cerrar sesi√≥n</button>
  </div>

  <!-- Contenido principal -->
  <div id="mainContent">
    <!-- Header fijo con informaci√≥n del usuario -->
    <div id="userHeader">
      <img id="headerUserPhoto" src="https://dummyimage.com/45x45/ccc/fff">
      <span id="headerUserName">Cargando...</span>
    </div>

    <!-- Inicio -->
    <div id="inicioSection" class="card">
      <h2>Bienvenido</h2>
      <p>Selecciona una opci√≥n del men√∫ para comenzar.</p>
    </div>

    <!-- Secci√≥n Clubes -->
    <div id="clubesSection" class="card hidden">
      <h2>Clubes</h2>

      <!-- Botones de clubes -->
      <div id="clubesContainer" style="display:flex; gap:10px; margin-bottom:15px;">
        <button class="clubBtn" data-club="aventureros">Club de Aventureros</button>
        <button class="clubBtn" data-club="conquistadores">Club de Conquistadores</button>
        <button class="clubBtn" data-club="guias">Club de Gu√≠as Mayores</button>
      </div>

      <!-- Panel de contenido de clubes -->
      <div id="clubesPanel">
        <!-- Aqu√≠ se ir√°n agregando las carpetas y secciones din√°micamente -->
      </div>
    </div>



    <!-- Especialidades Storage -->
    <div id="especialidadesSection" class="card hidden">
      <h2>Mi Almacenamiento Leyenda De Especialidades</h2>
      <!--
      <input type="text" id="nombreEspecialidad" placeholder="Nombre de la especialidad">
      <button id="crearEspecialidad">Crear Carpeta</button>-->


      <h4>Carpetas existentes:</h4>
      <ul id="listaEspecialidades"></ul>
      <div id="archivosContainer" class="hidden">
        <h3 id="especialidadActual">Especialidad:</h3>
        <button id="cerrarEspecialidad">Cerrar carpeta</button>
        <input type="file" id="subirArchivo" accept=".pdf, .jpg, .jpeg, .png">
        <button id="subirArchivoBtn">Subir Archivo</button>

        <div>
          <label for="ordenArchivos">Ordenar por:</label>
          <select id="ordenArchivos">
            <option value="nombreDesc">Nombre ‚Üì</option>
            <option value="nombreAsc">Nombre ‚Üë</option>
            <option value="fechaDesc">Fecha ‚Üì</option>
            <option value="fechaAsc">Fecha ‚Üë</option>
            <option value="sizeDesc">Tama√±o ‚Üì</option>
            <option value="sizeAsc">Tama√±o ‚Üë</option>
          </select>
        </div>

        <ul id="listaArchivos"></ul>

      </div>
    </div>

    <!-- Perfil (secci√≥n corregida) -->
    <div id="perfilSection" class="card hidden">
      <h1>Editar Informaci√≥n</h1>
      <form id="editForm">
        <div style="text-align: center; margin-bottom: 20px;">
          <img id="preview" src="https://dummyimage.com/120x120/ccc/fff"
            style="width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 3px solid #1976d2;">
        </div>

        <h3>Actualizar Foto:</h3>
        <input type="file" id="foto" accept="image/*">

        <h3>Datos personales:</h3>

        <!-- Correo (solo lectura) -->
        <div style="margin-bottom: 15px;">
          <label for="correo" style="display: block; margin-bottom: 5px; font-weight: bold;">Correo electr√≥nico:</label>
          <input type="email" id="correo" readonly style="background-color: #f5f5f5; color: #666;">
        </div>

        <input type="text" id="nombre" placeholder="Nombre" required>
        <input type="text" id="apellido" placeholder="Apellido" required>
        <input type="number" id="edad" placeholder="Edad" required>
        <select id="sexo" required>
          <option value="">Seleccionar sexo</option>
          <option value="Masculino">Masculino</option>
          <option value="Femenino">Femenino</option>
          <option value="Otro">Otro</option>
        </select>
        <input type="text" id="pais" placeholder="Pa√≠s" required>

        <button type="submit" class="saveBtn">Guardar cambios</button>
      </form>
    </div>

    <!-- üîπ NUEVA SECCI√ìN: CERTIFICACIONES -->
    <div id="certificacionesSection" class="hidden">
      <div class="card card-certificaciones">
        <h2>üìú Mis Certificaciones de Especialidades</h2>
        <p>Aqu√≠ puedes ver todas las especialidades en las que has participado, validadas con tu correo electr√≥nico.</p>

        <div id="certificacionesLoading" style="text-align: center; padding: 20px;">
          <div class="loading" style="display: inline-block;"></div>
          <p>Cargando tus certificaciones...</p>
        </div>

        <div id="certificacionesContent" style="display: none;">
          <div id="certificacionesContadores">
            <p>Total de especialidades: <span id="totalEspecialidades">0</span></p>
            <p>Especialidades completadas: <span id="especialidadesCompletadas">0</span></p>
          </div>

          <table id="tablaCertificaciones" border="1" style="border-collapse: collapse; width: 100%; margin-top: 20px;">
            <thead>
              <tr>
                <th>#</th>
                <th>Especialidad</th>
                <th>Fecha de Participaci√≥n</th>
                <th>Asistencias Completadas</th>
                <th>Examen Realizado</th>
                <th>Calificaci√≥n</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody id="cuerpoTablaCertificaciones">
              <!-- Las filas se llenar√°n din√°micamente -->
            </tbody>
          </table>

          <div id="sinCertificaciones" style="display: none; text-align: center; padding: 30px; color: #666;">
            <h3>üìù A√∫n no tienes certificaciones</h3>
            <p>Participa en especialidades para ver tus certificaciones aqu√≠.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- üîπ Visor PDF modal -->
    <div id="pdfViewerModal" class="hidden" style="display: none;">
      <div class="pdf-viewer-content">
        <button id="cerrarPDF" class="cerrar-pdf">‚úñ</button>
        <iframe id="pdfFrame" src="" allowfullscreen style="border:none;"></iframe>
      </div>
    </div>

    <!-- üîπ Contenedor general de mensajes -->
    <div id="mensajeModal" class="hiddenX">
      <div class="mensaje-content">
        <h3 id="mensajeTitulo">T√≠tulo</h3>
        <p id="mensajeTexto">Texto del mensaje</p>
        <div id="mensajeBotones">
          <button id="mensajeAceptar">Aceptar</button>
          <button id="mensajeCancelar" class="hiddenX">Cancelar</button>
        </div>
      </div>
    </div>


    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
      import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
      import {
        getStorage, ref, uploadBytes, getDownloadURL, deleteObject, listAll, getMetadata
      } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";

      const firebaseConfig = {
        apiKey: "AIzaSyB1YTwZM8wKlxZ8HhXb7EUse8YyLmcfeS8",
        authDomain: "conquiguias-world-85ccd.firebaseapp.com",
        projectId: "conquiguias-world-85ccd",
        storageBucket: "conquiguias-world-85ccd.firebasestorage.app",
        messagingSenderId: "785222651205",
        appId: "1:785222651205:web:0486c50e9d8af6bf9b022c"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const storage = getStorage(app);

      // Elementos UI
      const inicioNombre = document.getElementById("inicioNombre");
      const inicioFoto = document.getElementById("inicioFoto");
      const perfilSection = document.getElementById("perfilSection");
      const inicioSection = document.getElementById("inicioSection");
      const especialidadesSection = document.getElementById("especialidadesSection");
      const menuInicio = document.getElementById("menuInicio");
      const menuPerfil = document.getElementById("menuPerfil");
      const menuEspecialidades = document.getElementById("menuEspecialidades");
      const menuCertificaciones = document.getElementById("menuCertificaciones");
      const logoutBtn = document.getElementById("logoutBtn");
      const editForm = document.getElementById("editForm");
      const fotoInput = document.getElementById("foto");
      const preview = document.getElementById("preview");
      const removePhotoBtn = document.getElementById("removePhoto");
      const nombreInput = document.getElementById("nombre");
      const apellidoInput = document.getElementById("apellido");
      const edadInput = document.getElementById("edad");
      const sexoInput = document.getElementById("sexo");
      const paisInput = document.getElementById("pais");
      const listaEspecialidades = document.getElementById("listaEspecialidades");
      const archivosContainer = document.getElementById("archivosContainer");
      const especialidadActualH3 = document.getElementById("especialidadActual");
      const subirArchivoInput = document.getElementById("subirArchivo");
      const subirArchivoBtn = document.getElementById("subirArchivoBtn");
      const listaArchivos = document.getElementById("listaArchivos");
      const cerrarEspecialidadBtn = document.getElementById("cerrarEspecialidad");

      // Elementos de Certificaciones
      const certificacionesSection = document.getElementById("certificacionesSection");
      const certificacionesLoading = document.getElementById("certificacionesLoading");
      const certificacionesContent = document.getElementById("certificacionesContent");
      const sinCertificaciones = document.getElementById("sinCertificaciones");
      const cuerpoTablaCertificaciones = document.getElementById("cuerpoTablaCertificaciones");
      const totalEspecialidades = document.getElementById("totalEspecialidades");
      const especialidadesCompletadas = document.getElementById("especialidadesCompletadas");

      let especialidadSeleccionada = "";
      let currentUserId = null;
      let currentPhotoURL = "";
      const placeholderURL = "https://dummyimage.com/120x120/ccc/fff";

      // Variable global para guardar si el usuario puede acceder o no
      let puedeEntrarEspecialidades = false;

      // üîπ Detectar usuario logueado
      // üîπ Detectar usuario logueado
      onAuthStateChanged(auth, async (user) => {
        // üîí Lista de correos permitidos para entrar a Especialidades
        const correosAutorizados = [
          "kendall.torres.17@gmail.com",
          "lunabecky026@gmail.com"
        ];

        // Obtener elementos del header
        const headerUserPhoto = document.getElementById("headerUserPhoto");
        const headerUserName = document.getElementById("headerUserName");

        // Obtener el campo de correo del perfil
        const correoInput = document.getElementById("correo");

        // Dentro del onAuthStateChanged (despu√©s de obtener el usuario)
        if (user) {
          const email = user.email;
          puedeEntrarEspecialidades = correosAutorizados.includes(email);
        }

        if (!user) {
          window.location.href = "index.html";
          return;
        }

        currentUserId = user.uid;

        const docRef = doc(db, "usuarios", currentUserId);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          const data = docSnap.data();
          currentPhotoURL = data.fotoURL || placeholderURL;

          // Actualizar header del usuario
          headerUserPhoto.src = currentPhotoURL;
          headerUserName.textContent = `${data.nombre || ''} ${data.apellido || ''}`;

          // Actualizar los campos del perfil
          nombreInput.value = data.nombre || '';
          apellidoInput.value = data.apellido || '';
          edadInput.value = data.edad || '';
          sexoInput.value = data.sexo || '';
          paisInput.value = data.pais || '';
          preview.src = currentPhotoURL;

          // Establecer el correo (solo lectura)
          correoInput.value = user.email || '';
        }

        cargarEspecialidadesFijas();
      });

      // üîπ Navegaci√≥n
      menuInicio.addEventListener("click", () => mostrarSeccion(inicioSection, menuInicio));
      menuPerfil.addEventListener("click", () => mostrarSeccion(perfilSection, menuPerfil));
      menuCertificaciones.addEventListener("click", () => {
        mostrarSeccion(certificacionesSection, menuCertificaciones);
        cargarCertificaciones();
      });

      // üîπ Men√∫ Especialidades con bloqueo si no es autorizado
      menuEspecialidades.addEventListener("click", () => {
        if (!puedeEntrarEspecialidades) {
          mostrarMensaje("error", "Acceso restringido", "üö´ Solo personal Premium puede ingresar a esta secci√≥n.");
          return;
        }

        mostrarSeccion(especialidadesSection, menuEspecialidades);
        cargarEspecialidadesFijas();
      });

      // üîπ Foto de perfil
      fotoInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = () => preview.src = reader.result;
          reader.readAsDataURL(file);
        }
      });

      // üîπ Guardar perfil (versi√≥n con eliminaci√≥n de foto anterior)
      editForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!currentUserId) return;

        let newPhotoURL = currentPhotoURL;
        const file = fotoInput.files[0];

        try {
          // ‚úÖ Validar tama√±o antes de subir
          if (file && file.size > 1024 * 1024) {
            mostrarMensaje("info", "‚ö†Ô∏è La imagen no debe superar 1 MB.", "");
            return;
          }

          // ‚úÖ Si hay un archivo nuevo, eliminar el anterior
          if (file && currentPhotoURL) {
            try {
              // Buscar y eliminar foto anterior
              const oldRef = ref(storage, currentPhotoURL);
              await deleteObject(oldRef);
              console.log("üóëÔ∏è Foto anterior eliminada del servidor");
            } catch (err) {
              console.warn("‚ö†Ô∏è No se pudo eliminar la foto anterior:", err.message);
            }
          }

          // ‚úÖ Subir la nueva imagen (si existe)
          if (file) {
            const storageRef = ref(storage, `usuarios/${currentUserId}/${file.name}`);
            await uploadBytes(storageRef, file);
            newPhotoURL = await getDownloadURL(storageRef);
          }

          // ‚úÖ Actualizar datos en Firestore
          const docRef = doc(db, "usuarios", currentUserId);
          await updateDoc(docRef, {
            nombre: nombreInput.value,
            apellido: apellidoInput.value,
            edad: edadInput.value,
            sexo: sexoInput.value,
            pais: paisInput.value,
            fotoURL: newPhotoURL
          });

          mostrarMensaje("info", "‚úÖ Informaci√≥n actualizada correctamente.", "", () => {
            window.location.reload();
          });

        } catch (error) {
          console.error(error);
          mostrarMensaje("error", "‚ùå Error al actualizar", "");
        }
      });

      logoutBtn.addEventListener("click", async () => {
        await signOut(auth);
        window.location.href = "index.html";
      });

      ////////////////////////
      // üìÅ ESPECIALIDADES STORAGE
      ////////////////////////
      const especialidadesFijas = ["Especialidades Completadas", "Certificaciones", "Carpeta Gu√≠a Mayor", "Otros"];

      function cargarEspecialidadesFijas() {
        listaEspecialidades.innerHTML = "";
        especialidadesFijas.forEach(nombre => {
          const li = document.createElement("li");
          li.textContent = nombre;
          li.classList.add("carpeta-item");
          listaEspecialidades.appendChild(li);
        });
      }

      listaEspecialidades.addEventListener("click", (e) => {
        if (e.target.tagName !== "LI") return;
        especialidadSeleccionada = e.target.textContent;
        especialidadActualH3.textContent = `üìÇ ${especialidadSeleccionada}`;
        archivosContainer.classList.remove("hidden");
        cargarArchivos(especialidadSeleccionada);
      });

      subirArchivoBtn.addEventListener("click", async () => {
        if (!especialidadSeleccionada || !subirArchivoInput.files[0])
          return mostrarMensaje("info", "Selecciona un archivo v√°lido", "");

        const file = subirArchivoInput.files[0];
        const ext = file.name.split(".").pop().toLowerCase();
        if (!["pdf", "jpg", "jpeg", "png"].includes(ext))
          return mostrarMensaje("error", "‚ùå Solo se permiten archivos PDF o im√°genes (JPG, JPEG, PNG)", "No se aceptan extensiones diferentes que no sean archivos de pdf o im√°genes.");

        const storageRefFile = ref(storage, `usuarios/${currentUserId}/carpetas/${especialidadSeleccionada}/${file.name}`);
        await uploadBytes(storageRefFile, file);
        mostrarMensaje("info", `üìÑ Archivo "${file.name}" subido correctamente`, "");
        subirArchivoInput.value = "";
        cargarArchivos(especialidadSeleccionada);
      });

      async function cargarArchivos(especialidad, orden = "nombreDesc") {
        listaArchivos.innerHTML = "";
        const folderRef = ref(storage, `usuarios/${currentUserId}/carpetas/${especialidad}/`);
        try {
          const result = await listAll(folderRef);
          if (result.items.length === 0) {
            listaArchivos.innerHTML = "<li>No hay archivos a√∫n.</li>";
            return;
          }

          const archivos = [];
          for (const fileRef of result.items) {
            const url = await getDownloadURL(fileRef);
            const meta = await getMetadata(fileRef);

            archivos.push({
              ref: fileRef,
              url,
              nombre: fileRef.name,
              fecha: new Date(meta.timeCreated),
              size: meta.size
            });
          }

          // üîπ Orden seg√∫n selecci√≥n
          switch (orden) {
            case "nombreAsc":
              archivos.sort((a, b) => a.nombre.localeCompare(b.nombre));
              break;
            case "nombreDesc":
              archivos.sort((a, b) => b.nombre.localeCompare(a.nombre));
              break;
            case "fechaAsc":
              archivos.sort((a, b) => a.fecha - b.fecha);
              break;
            case "fechaDesc":
              archivos.sort((a, b) => b.fecha - a.fecha);
              break;
            case "sizeAsc":
              archivos.sort((a, b) => a.size - b.size);
              break;
            case "sizeDesc":
              archivos.sort((a, b) => b.size - a.size);
              break;
          }

          // üîπ Crear elementos en la lista (igual que antes)
          archivos.forEach(file => {
            const li = document.createElement("li");
            li.classList.add("archivo-item");
            li.style.display = "flex";
            li.style.justifyContent = "space-between";
            li.style.alignItems = "center";

            const nombreSpan = document.createElement("span");
            nombreSpan.textContent = file.nombre;
            nombreSpan.classList.add("archivo-link");
            nombreSpan.style.cursor = "pointer";
            nombreSpan.addEventListener("click", () => {
              const ext = file.nombre.split('.').pop().toLowerCase();
              if (ext === "pdf") abrirVisorPDF(file.url);
              else window.open(file.url, "_blank");
            });

            const infoSpan = document.createElement("span");
            infoSpan.textContent = `${file.fecha.toLocaleDateString()} ${file.fecha.toLocaleTimeString()} ‚Ä¢ ${(file.size / 1024).toFixed(2)} KB`;
            infoSpan.style.color = "#555";
            infoSpan.style.fontSize = "13px";

            const eliminarBtn = document.createElement("button");
            eliminarBtn.textContent = "üóëÔ∏è";
            eliminarBtn.classList.add("delete-btn");
            eliminarBtn.addEventListener("click", async () => {
              mostrarMensaje("confirm", "Confirmar eliminaci√≥n", `¬øEliminar "${file.nombre}"?`, async () => {
                await deleteObject(file.ref);
                cargarArchivos(especialidad, orden);
              });

            });

            const infoContainer = document.createElement("div");
            infoContainer.style.display = "flex";
            infoContainer.style.gap = "10px";
            infoContainer.appendChild(infoSpan);
            infoContainer.appendChild(eliminarBtn);

            li.appendChild(nombreSpan);
            li.appendChild(infoContainer);
            listaArchivos.appendChild(li);
          });

        } catch (err) {
          console.error("Error al cargar archivos:", err);
          mostrarMensaje("error", "Error al cargar archivos", "");
        }
      }
      const ordenSelect = document.getElementById("ordenArchivos");

      ordenSelect.addEventListener("change", () => {
        if (especialidadSeleccionada) {
          cargarArchivos(especialidadSeleccionada, ordenSelect.value);
        }
      });

      cerrarEspecialidadBtn.addEventListener("click", () => {
        archivosContainer.classList.add("hidden");
        especialidadSeleccionada = "";
      });

      function mostrarSeccion(seccion, botonActivo) {
        [inicioSection, perfilSection, especialidadesSection, clubesSection, certificacionesSection].forEach(sec => sec.classList.add("hidden"));
        [menuInicio, menuPerfil, menuEspecialidades, menuClubes, menuCertificaciones].forEach(btn => btn.classList.remove("active"));

        seccion.classList.remove("hidden");
        botonActivo.classList.add("active");
      }

      ////////////////////////////////////////////
      // üîπ VISOR PDF
      const pdfViewerModal = document.getElementById("pdfViewerModal");
      const pdfFrame = document.getElementById("pdfFrame");
      const cerrarPDF = document.getElementById("cerrarPDF");

      function abrirVisorPDF(url) {
        pdfFrame.src = url;
        pdfViewerModal.style.display = "flex";
      }

      cerrarPDF.addEventListener("click", () => {
        pdfViewerModal.style.display = "none";
        pdfFrame.src = "";
      });

      pdfViewerModal.addEventListener("click", (e) => {
        if (e.target === pdfViewerModal) {
          pdfViewerModal.style.display = "none";
          pdfFrame.src = "";
        }
      });

      ////////////////////////////////////////
      /**
       * üîπ Mostrar mensaje din√°mico
       * @param {string} tipo - "info" | "error" | "confirm"
       * @param {string} titulo - Texto del t√≠tulo
       * @param {string} mensaje - Texto del cuerpo
       * @param {function} onConfirm - (Opcional) callback si se presiona "Aceptar" en tipo confirm
       */
      function mostrarMensaje(tipo, titulo, mensaje, onConfirm = null) {
        const modal = document.getElementById("mensajeModal");
        const tituloEl = document.getElementById("mensajeTitulo");
        const textoEl = document.getElementById("mensajeTexto");
        const btnAceptar = document.getElementById("mensajeAceptar");
        const btnCancelar = document.getElementById("mensajeCancelar");

        tituloEl.textContent = titulo;
        textoEl.textContent = mensaje;
        modal.classList.remove("hiddenX");

        // Configurar botones
        btnCancelar.classList.toggle("hiddenX", tipo !== "confirm");

        const cerrar = () => {
          modal.classList.add("hiddenX");
          btnAceptar.onclick = null;
          btnCancelar.onclick = null;
        };

        btnAceptar.onclick = () => {
          cerrar();
          if (onConfirm && (tipo === "confirm" || tipo === "info")) onConfirm();
        };

        btnCancelar.onclick = cerrar;
      }

      ////////////////////////////////////////////
      const menuClubes = document.getElementById("menuClubes");
      const clubesSection = document.getElementById("clubesSection");

      menuClubes.addEventListener("click", () => {
        mostrarSeccion(clubesSection, menuClubes);
      });
      ///////////////////////////////////////////

      const clubBtns = document.querySelectorAll(".clubBtn");
      const clubesPanel = document.getElementById("clubesPanel");

      // Datos de cada club
      const clubesData = {
        aventureros: {
          niveles: ["Amigo", "Compa√±ero", "Explorador"],
          carpetas: ["Voto y Ley", "Bandera de Aventureros", "Himno del Club"]
        },
        conquistadores: {
          niveles: ["Amigo", "Compa√±ero", "Explorador", "Orientador", "Viajero", "Gu√≠a"],
          carpetas: [
            "Voto y Ley",
            "Especialidades Ja",
            "Bandera de Conquistadores",
            "Himno del Conquistador",
            "Manual de Nudos",
            "Formularios y Permisos",
            "Manual del Uniforme",
            "Uso del Hacha y Cuchillo",
            "Registros",
            "Gu√≠a para el Director",
            "Gu√≠a R√°pida para el Director del Club de Conquistadores",
            "Logos e Im√°genes",
            "Lista de Especialidades para Cada Nivel Progresivo"
          ]
        },
        guias: {
          niveles: ["Explorador", "Gu√≠a", "Coordinador"],
          carpetas: ["Voto y Ley", "Manual de Gu√≠as", "Registros"]
        }
      };

      // Click en club
      clubBtns.forEach(btn => {
        btn.addEventListener("click", () => {
          const clubKey = btn.dataset.club;

          // Limpiar panel
          clubesPanel.innerHTML = "";

          const clubData = clubesData[clubKey] || { niveles: [], carpetas: [] };

          const clubContainer = document.createElement("div");
          clubContainer.dataset.panel = clubKey;

          // üîπ Niveles
          if (clubData.niveles.length > 0) {
            const nivelesContainer = document.createElement("div");
            nivelesContainer.style.display = "grid";
            nivelesContainer.style.gridTemplateColumns = "repeat(3, 1fr)";
            nivelesContainer.style.gap = "10px";
            nivelesContainer.style.marginBottom = "15px";

            const nivelesContenidoContainer = document.createElement("div");

            clubData.niveles.forEach(nivel => {
              const btnNivel = document.createElement("div");
              btnNivel.classList.add("carpeta-item");
              btnNivel.textContent = nivel;

              const contenido = document.createElement("div");
              contenido.classList.add("hidden");
              contenido.style.marginTop = "5px";
              contenido.textContent = "Contenido de " + nivel;

              btnNivel.addEventListener("click", () => {
                contenido.classList.toggle("hidden");
              });

              nivelesContainer.appendChild(btnNivel);
              nivelesContenidoContainer.appendChild(contenido);
            });

            clubContainer.appendChild(nivelesContainer);
            clubContainer.appendChild(nivelesContenidoContainer);
          }

          // üîπ Carpetas
          if (clubData.carpetas.length > 0) {
            const carpetasContainer = document.createElement("div");
            clubData.carpetas.forEach(carpetaName => {
              const carpeta = document.createElement("div");
              carpeta.classList.add("carpeta-item");
              carpeta.textContent = carpetaName;

              const contenido = document.createElement("div");
              contenido.classList.add("hidden");
              contenido.style.marginLeft = "20px";
              contenido.style.marginBottom = "5px";

              const archivo = document.createElement("div");
              archivo.textContent = "Contenido de " + carpetaName;
              contenido.appendChild(archivo);

              carpeta.addEventListener("click", () => {
                contenido.classList.toggle("hidden");
              });

              carpetasContainer.appendChild(carpeta);
              carpetasContainer.appendChild(contenido);
            });

            clubContainer.appendChild(carpetasContainer);
          }

          clubesPanel.appendChild(clubContainer);
        });
      });

      // üîπ NUEVAS FUNCIONES PARA CERTIFICACIONES - DENTRO DEL M√ìDULO

      // Funci√≥n para cargar las certificaciones del usuario
      // Funci√≥n para cargar las certificaciones del usuario
      async function cargarCertificaciones() {
        // Mostrar loading
        certificacionesLoading.style.display = "block";
        certificacionesContent.style.display = "none";
        sinCertificaciones.style.display = "none";

        try {
          // Obtener el usuario actual
          const user = auth.currentUser;
          if (!user || !user.email) {
            throw new Error("No se pudo obtener la informaci√≥n del usuario");
          }

          const userEmail = user.email;

          // Obtener todos los formularios
          const formulariosRes = await fetch("/api/listarFormularios");
          if (!formulariosRes.ok) {
            throw new Error("No se pudieron cargar los formularios");
          }

          const formularios = await formulariosRes.json();
          const formulariosIds = Object.keys(formularios);

          // Array para almacenar las certificaciones
          const certificaciones = [];

          // Para cada formulario, buscar si el usuario particip√≥
          for (const formularioId of formulariosIds) {
            try {
              const respuestasRes = await fetch(`/api/verRespuestas?id=${formularioId}`);
              if (respuestasRes.ok) {
                const data = await respuestasRes.json();
                const respuestas = data.asistencias || [];
                const examenes = data.examenes || [];
                const fechaFin = data.fechaFin ? new Date(data.fechaFin) : null;
                const hoy = new Date();

                // Buscar respuestas del usuario por correo
                const respuestasUsuario = respuestas.filter(r => r.correo === userEmail);

                if (respuestasUsuario.length > 0) {
                  // Encontrar el examen del usuario si existe
                  const examenUsuario = examenes.find(e => {
                    // Buscar por visitanteId si est√° disponible
                    const respuestaUsuario = respuestasUsuario.find(r => r.visitanteId === e.visitanteId);
                    return respuestaUsuario !== undefined;
                  });

                  // Determinar asistencias
                  const maxAsistencia = Math.max(...respuestasUsuario.map(r => r.asistenciaNumero || 0));
                  const asistenciasCompletadas = maxAsistencia;
                  const examenRealizado = examenUsuario !== undefined;
                  const calificacion = examenRealizado ? examenUsuario.puntaje : null;
                  const aprobado = calificacion >= 70;

                  // üîπ NUEVA L√ìGICA PARA DETERMINAR ESTADO
                  let estado = "";
                  let estadoClase = "";

                  if (fechaFin && hoy > fechaFin) {
                    // TIEMPO TERMINADO
                    if (asistenciasCompletadas >= 3) {
                      if (examenRealizado && aprobado) {
                        estado = "Completado";
                        estadoClase = "estado-completado";
                      } else {
                        estado = "No aplica";
                        estadoClase = "estado-incompleto";
                      }
                    } else {
                      estado = "No aplica";
                      estadoClase = "estado-incompleto";
                    }
                  } else {
                    // TIEMPO EN CURSO
                    if (asistenciasCompletadas >= 3) {
                      if (examenRealizado && aprobado) {
                        estado = "Completado";
                        estadoClase = "estado-completado";
                      } else {
                        estado = "En progreso";
                        estadoClase = "estado-pendiente";
                      }
                    } else {
                      estado = "En progreso";
                      estadoClase = "estado-pendiente";
                    }
                  }

                  // Obtener la fecha m√°s reciente
                  const fechaMasReciente = new Date(Math.max(...respuestasUsuario.map(r => new Date(r.fecha))));

                  certificaciones.push({
                    formularioId: formularioId,
                    titulo: formularios[formularioId].titulo,
                    fecha: fechaMasReciente,
                    asistenciasCompletadas: asistenciasCompletadas,
                    examenRealizado: examenRealizado,
                    calificacion: calificacion,
                    aprobado: aprobado,
                    estado: estado,
                    estadoClase: estadoClase,
                    fechaFin: fechaFin
                  });
                }
              }
            } catch (error) {
              console.error(`Error al cargar respuestas para ${formularioId}:`, error);
            }
          }

          // Actualizar la interfaz con las certificaciones
          actualizarInterfazCertificaciones(certificaciones);

        } catch (error) {
          console.error("Error al cargar certificaciones:", error);
          mostrarMensaje("error", "Error al cargar certificaciones", "No se pudieron cargar tus certificaciones. Intenta nuevamente.");

          // Mostrar estado de error
          certificacionesLoading.style.display = "none";
          sinCertificaciones.style.display = "block";
          sinCertificaciones.innerHTML = `
      <h3>‚ùå Error al cargar certificaciones</h3>
      <p>No se pudieron cargar tus certificaciones. Intenta nuevamente.</p>
    `;
        }
      }

      // Funci√≥n para actualizar la interfaz con las certificaciones
      function actualizarInterfazCertificaciones(certificaciones) {
        // Ocultar loading
        certificacionesLoading.style.display = "none";

        if (certificaciones.length === 0) {
          sinCertificaciones.style.display = "block";
          certificacionesContent.style.display = "none";
          return;
        }

        // Mostrar contenido
        sinCertificaciones.style.display = "none";
        certificacionesContent.style.display = "block";

        // Actualizar contadores
        const completadas = certificaciones.filter(c => c.estado === "Completado").length;
        totalEspecialidades.textContent = certificaciones.length;
        especialidadesCompletadas.textContent = completadas;

        // Limpiar tabla
        cuerpoTablaCertificaciones.innerHTML = "";

        // Ordenar certificaciones por fecha (m√°s reciente primero)
        certificaciones.sort((a, b) => b.fecha - a.fecha);

        // Llenar tabla
        certificaciones.forEach((cert, index) => {
          const fila = document.createElement("tr");

          let calificacionTexto = "No realizado";
          let calificacionClase = "";

          if (cert.examenRealizado) {
            calificacionClase = cert.aprobado ? "calificacion-aprobada" : "calificacion-reprobada";
            calificacionTexto = `${cert.calificacion.toFixed(1)}%`;
          }

          fila.innerHTML = `
      <td>${index + 1}</td>
      <td>${cert.titulo}</td>
      <td>${cert.fecha.toLocaleDateString()}</td>
      <td>${cert.asistenciasCompletadas}/3</td>
      <td>${cert.examenRealizado ? "S√≠" : "No"}</td>
      <td class="${calificacionClase}">${calificacionTexto}</td>
      <td class="${cert.estadoClase}">${cert.estado}</td>
    `;

          cuerpoTablaCertificaciones.appendChild(fila);
        });
      }

    </script>

</body>

</html>