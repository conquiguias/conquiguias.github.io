<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Great+Vibes&family=Montserrat:wght@300;500;700&display=swap"
    rel="stylesheet">

  <title>Panel del Usuario</title>
  <style>
    /* ============================================
   RESET Y VARIABLES PARA MODO NOCHE
   ============================================ */
    :root {
      /* Colores principales modo noche */
      --bg-primary: #0f172a;
      --bg-secondary: #1e293b;
      --bg-card: #1e293b;
      --bg-sidebar: #1e293b;
      --text-primary: #e2e8f0;
      --text-secondary: #94a3b8;
      --accent-color: #3b82f6;
      --accent-hover: #2563eb;
      --danger-color: #ef4444;
      --danger-hover: #dc2626;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --border-color: #334155;
      --shadow-color: rgba(0, 0, 0, 0.3);
      --shadow-light: rgba(0, 0, 0, 0.1);
    }

    /* Reset b√°sico */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* Body y contenedor principal */
    body {
      display: flex;
      height: 100vh;
      background: var(--bg-primary);
      color: var(--text-primary);
    }

    /* ============================================
   MEN√ö LATERAL - MODO NOCHE
   ============================================ */
    #sidebar {
      width: 220px;
      background: var(--bg-sidebar);
      color: var(--text-primary);
      display: flex;
      flex-direction: column;
      padding: 20px 0;
      box-shadow: 2px 0 5px var(--shadow-color);
      border-right: 1px solid var(--border-color);
    }

    #sidebar h2 {
      text-align: center;
      margin-bottom: 25px;
      font-size: 22px;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--text-primary);
    }

    #sidebar button {
      padding: 12px 20px;
      margin: 5px 10px;
      border: none;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
      cursor: pointer;
      text-align: left;
      font-size: 15px;
      transition: background 0.3s, transform 0.2s;
    }

    #sidebar button:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateX(5px);
    }

    #sidebar button.active {
      background: var(--accent-color);
      font-weight: bold;
    }

    #sidebar #logoutBtn {
      margin-top: auto;
      background: var(--danger-color);
    }

    #sidebar #logoutBtn:hover {
      background: var(--danger-hover);
      transform: translateX(0);
    }

    /* ============================================
   CONTENIDO PRINCIPAL - MODO NOCHE
   ============================================ */
    #mainContent {
      flex: 1;
      padding: 25px;
      overflow-y: auto;
      background: var(--bg-primary);
    }

    /* Cards (excepto certificaciones) */
    .card:not(.card-certificaciones) {
      background: var(--bg-card);
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 6px 15px var(--shadow-color);
      max-width: 650px;
      margin: 20px auto;
      transition: transform 0.3s, box-shadow 0.3s;
      border: 1px solid var(--border-color);
    }

    .card:not(.card-certificaciones):hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px var(--shadow-color);
    }

    /* Inputs y selects */
    input,
    select,
    textarea {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      font-size: 14px;
      transition: border 0.3s, box-shadow 0.3s;
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
      outline: none;
    }

    /* Botones */
    button.saveBtn,
    button#crearEspecialidad,
    button#subirArchivoBtn {
      background: var(--accent-color);
      color: var(--text-primary);
      cursor: pointer;
      padding: 12px;
      border-radius: 8px;
      border: none;
      font-size: 15px;
      transition: background 0.3s, transform 0.2s;
    }

    button.saveBtn:hover,
    button#crearEspecialidad:hover,
    button#subirArchivoBtn:hover {
      background: var(--accent-hover);
      transform: translateY(-2px);
    }

    /* Bot√≥n eliminar foto */
    #removePhoto {
      background: var(--danger-color);
      margin-top: 5px;
    }

    #removePhoto:hover {
      background: var(--danger-hover);
      transform: translateY(-2px);
    }

    /* Listas de archivos y especialidades */
    ul {
      list-style: none;
      padding-left: 0;
      margin-top: 10px;
    }

    ul li {
      padding: 10px 12px;
      border-radius: 6px;
      margin-bottom: 6px;
      background: var(--bg-secondary);
      transition: background 0.3s;
    }

    ul li:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    ul li a {
      text-decoration: none;
      color: var(--accent-color);
      font-weight: 500;
    }

    ul li a:hover {
      text-decoration: underline;
    }

    /* Encabezados */
    h2,
    h3,
    h4 {
      color: var(--text-primary);
      margin-bottom: 15px;
    }

    /* Ocultar secciones */
    .hidden {
      display: none;
    }

    .carpeta-item {
      cursor: pointer;
      background: var(--bg-secondary);
      margin: 6px 0;
      padding: 10px;
      border-radius: 8px;
      transition: background 0.3s;
    }

    .carpeta-item:hover {
      background: rgba(59, 130, 246, 0.1);
    }

    .archivo-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--bg-secondary);
      padding: 8px 12px;
      border-radius: 6px;
      margin: 5px 0;
      box-shadow: 0 1px 3px var(--shadow-color);
    }

    .archivo-item a {
      color: var(--accent-color);
      text-decoration: none;
      font-weight: 500;
    }

    .archivo-item a:hover {
      text-decoration: underline;
    }

    .delete-btn {
      border: none;
      background: transparent;
      font-size: 18px;
      cursor: pointer;
      color: var(--danger-color);
      transition: transform 0.2s;
    }

    .delete-btn:hover {
      transform: scale(1.2);
    }

    /* üîπ Fondo del visor */
    #pdfViewerModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    /* üîπ Contenedor del visor */
    .pdf-viewer-content {
      position: relative;
      width: 90%;
      height: 90%;
      background: var(--bg-card);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 15px var(--shadow-color);
      animation: fadeIn 0.3s ease;
    }

    /* üîπ Bot√≥n de cerrar */
    .cerrar-pdf {
      position: absolute;
      top: 10px;
      right: 15px;
      background: var(--danger-color);
      color: white;
      border: none;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      font-size: 18px;
      cursor: pointer;
      z-index: 10;
      transition: background 0.3s;
    }

    .cerrar-pdf:hover {
      background: var(--danger-hover);
    }

    /* üîπ PDF dentro del visor */
    .pdf-viewer-content iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* üîπ Animaci√≥n */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    #ordenContainer {
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #ordenSelect {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      font-size: 14px;
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    /* üîπ Fondo del modal */
    #mensajeModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    /* üîπ Caja del mensaje */
    .mensaje-content {
      background: var(--bg-card);
      padding: 25px 30px;
      border-radius: 12px;
      box-shadow: 0 8px 20px var(--shadow-color);
      text-align: center;
      width: 90%;
      max-width: 400px;
      animation: fadeIn 0.25s ease;
      border: 1px solid var(--border-color);
    }

    .mensaje-content h3 {
      margin-bottom: 12px;
      color: var(--accent-color);
    }

    .mensaje-content p {
      margin-bottom: 20px;
      color: var(--text-primary);
    }

    /* üîπ Botones */
    #mensajeBotones {
      display: flex;
      justify-content: center;
      gap: 15px;
    }

    #mensajeBotones button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 15px;
      transition: transform 0.2s, background 0.3s;
    }

    #mensajeAceptar {
      background: var(--accent-color);
      color: white;
    }

    #mensajeCancelar {
      background: var(--danger-color);
      color: white;
    }

    #mensajeBotones button:hover {
      transform: scale(1.05);
    }

    .hiddenX {
      display: none !important;
    }

    /* Niveles en filas de 3 */
    .niveles {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }

    .nivel {
      flex: 1;
      padding: 12px;
      background: var(--accent-color);
      color: var(--text-primary);
      text-align: center;
      border-radius: 6px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .nivel:hover {
      transform: scale(1.05);
    }

    /* Carpetas tipo Windows */
    .secciones-conquistadores {
      list-style: none;
      padding-left: 0;
    }

    .seccion-item {
      margin: 6px 0;
    }

    .seccion-titulo {
      display: flex;
      align-items: center;
      padding: 10px;
      background: var(--bg-secondary);
      border-radius: 4px;
      cursor: pointer;
      border: 1px solid var(--border-color);
      transition: background 0.2s;
    }

    .seccion-titulo::before {
      content: "üìÅ";
      margin-right: 8px;
    }

    .seccion-titulo.abierto::before {
      content: "üìÇ";
    }

    .seccion-titulo:hover {
      background: rgba(59, 130, 246, 0.1);
    }

    .seccion-contenido {
      padding: 10px 20px;
      margin-top: 4px;
      border-left: 4px solid var(--accent-color);
      background: var(--bg-card);
      border-radius: 0 4px 4px 0;
    }

    /* ============================================
   ESTILOS RED SOCIAL - MODO NOCHE
   ============================================ */

    /* Contenedor de publicaci√≥n */
    #uploadContainer {
      background: var(--bg-card);
      margin-bottom: 20px;
      border-radius: 12px;
      box-shadow: 0 6px 15px var(--shadow-color);
      padding: 20px;
      border: 1px solid var(--border-color);
    }

    /* Cards de publicaciones */
    .post-card {
      background: var(--bg-card);
      border-radius: 12px;
      box-shadow: 0 0 10px var(--shadow-color);
      overflow: hidden;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
    }

    .post-header {
      display: flex;
      align-items: center;
      padding: 15px;
      border-bottom: 1px solid var(--border-color);
    }

    .post-user-img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 12px;
      border: 2px solid var(--accent-color);
    }

    .post-user-name {
      font-weight: bold;
      color: var(--text-primary);
      flex: 1;
    }

    .post-time {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .post-content {
      width: 100%;
    }

    .post-content img,
    .post-content video {
      width: 100%;
      max-height: 400px;
      object-fit: contain;
      background: #000;
    }

    .post-description {
      padding: 15px;
      color: var(--text-primary);
      line-height: 1.4;
      font-size: 14px;
    }

    .post-actions {
      padding: 10px 15px;
      display: flex;
      gap: 10px;
      border-top: 1px solid var(--border-color);
      flex-wrap: nowrap;
      overflow: hidden;
      overflow-x: auto;
    }

    .reaction-btn {
      background: none;
      border: 2px solid transparent;
      border-radius: 20px;
      padding: 6px 12px;
      margin: 2px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 5px;
      color: var(--text-secondary);
    }

    .reaction-btn:hover {
      background-color: rgba(255, 255, 255, 0.05);
      transform: scale(1.05);
    }

    .reaction-btn.active {
      background-color: rgba(59, 130, 246, 0.2);
      border-color: var(--accent-color);
      transform: scale(1.1);
      box-shadow: 0 2px 5px rgba(59, 130, 246, 0.3);
      color: var(--accent-color);
    }

    .reaction-count {
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
      min-width: 20px;
      text-align: center;
    }

    .reaction-btn.active .reaction-count {
      color: var(--accent-color);
      font-weight: bold;
    }

    /* Previsualizaci√≥n */
    #previewContainer img,
    #previewContainer video {
      max-width: 200px;
      max-height: 200px;
      border-radius: 8px;
      margin-top: 10px;
      border: 2px solid var(--accent-color);
    }

    /* Estados de botones */
    .upload-disabled {
      opacity: 0.6 !important;
      cursor: not-allowed !important;
      pointer-events: none !important;
    }

    #uploadBtn:disabled {
      background: #4b5563 !important;
      cursor: not-allowed !important;
      pointer-events: none !important;
      transform: none !important;
    }

    #uploadBtn:disabled:hover {
      background: #4b5563 !important;
      transform: none !important;
    }

    /* Bot√≥n eliminar post */
    .delete-post-btn {
      background: var(--danger-color);
      color: white;
      border: none;
      border-radius: 4px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 12px;
      transition: background 0.3s;
      margin-left: 10px;
    }

    .delete-post-btn:hover {
      background: var(--danger-hover);
    }

    /* Contador regresivo */
    #countdownTimer {
      font-size: 14px;
      background: rgba(251, 191, 36, 0.1);
      padding: 5px 10px;
      border-radius: 4px;
      border: 1px solid rgba(251, 191, 36, 0.3);
      color: var(--warning-color);
    }

    /* Estado vac√≠o del feed */
    .empty-feed {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    .empty-feed h3 {
      margin-bottom: 10px;
      color: var(--text-secondary);
    }

    /* üîß ESTILOS PARA EL PANEL DE ADMINISTRACI√ìN */

    .admin-post-pending {
      border-left: 4px solid var(--warning-color) !important;
      background: rgba(245, 158, 11, 0.05) !important;
    }

    .admin-post-approved {
      border-left: 4px solid var(--success-color) !important;
      background: rgba(16, 185, 129, 0.05) !important;
    }

    .admin-post-rejected {
      border-left: 4px solid var(--danger-color) !important;
      background: rgba(239, 68, 68, 0.05) !important;
    }

    .approve-btn {
      background: var(--success-color) !important;
    }

    .approve-btn:hover {
      background: #0da271 !important;
      transform: translateY(-2px);
    }

    .reject-btn {
      background: var(--danger-color) !important;
    }

    .reject-btn:hover {
      background: var(--danger-hover) !important;
      transform: translateY(-2px);
    }

    .view-user-btn {
      background: var(--accent-color) !important;
    }

    .view-user-btn:hover {
      background: var(--accent-hover) !important;
      transform: translateY(-2px);
    }

    /* Indicador de estado en publicaciones normales */
    .post-status-indicator {
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 12px;
      margin-left: 10px;
    }

    .post-contenedor{
      display: flex;
      position: relative;
      flex-direction: row;
      flex-wrap: nowrap;
      width: 100%;
    }

    .status-pending {
      background: rgba(245, 158, 11, 0.2);
      color: var(--warning-color);
    }

    .status-approved {
      background: rgba(59, 130, 246, 0.2);
      color: var(--accent-color);
    }

    .status-admin {
      background: linear-gradient(135deg, #fbbf24, #f59e0b);
      color: #7c2d12 !important;
      border: 1px solid #fbbf24;
      font-weight: bold;
    }

    /* Estilos para comentarios */
    .post-comments {
      background: var(--bg-secondary);
      border-radius: 0 0 8px 8px;
    }

    /* üîπ ESTILOS PARA SCROLL INFINITO */
    .loading-posts {
      text-align: center;
      padding: 20px;
      color: var(--text-secondary);
    }

    .no-more-posts {
      text-align: center;
      padding: 20px;
      color: var(--text-secondary);
      font-style: italic;
    }

    .scroll-sentinel {
      height: 1px;
      width: 100%;
      background: transparent;
    }

    /* Header fijo con informaci√≥n del usuario */
    #userHeader {
      position: fixed;
      top: 25px;
      right: 30px;
      display: flex;
      align-items: center;
      gap: 15px;
      background: rgba(30, 41, 59, 0.8);
      padding: 10px 20px;
      border-radius: 50px;
      box-shadow: 0 4px 15px var(--shadow-color);
      z-index: 100;
      backdrop-filter: blur(10px);
      border: 1px solid var(--border-color);
    }

    #userHeader img {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--accent-color);
    }

    #userHeader span {
      font-weight: 600;
      color: var(--text-primary);
      font-size: 20px;
    }

    /* ============================================
   ESTILOS DE CERTIFICACIONES (MANTENIDOS ORIGINALES)
   ============================================ */

    /* Estilos espec√≠ficos para la secci√≥n de certificaciones */
    .card-certificaciones {
      max-width: none !important;
      width: calc(100% - 20px) !important;
      margin: 10px !important;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
      background: #fff;
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .card-certificaciones:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
    }

    #certificacionesSection {
      width: 100%;
      padding: 0;
    }

    #certificacionesContadores {
      background: #e8f4fd;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
    }

    #certificacionesContadores p {
      margin: 5px 0;
      font-weight: bold;
      color: #2c3e50;
    }

    #certificacionesContadores span {
      color: #e74c3c;
      font-size: 18px;
    }

    #tablaCertificaciones {
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    #tablaCertificaciones thead {
      background: rgba(59, 130, 246, 0.1);
      color: white;
    }

    #tablaCertificaciones th {
      padding: 12px 15px;
      text-align: left;
      font-weight: 600;
    }

    #tablaCertificaciones tbody tr {
      border-bottom: 1px solid #ddd;
      transition: background-color 0.3s ease;
    }

    #tablaCertificaciones tbody tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    #tablaCertificaciones tbody tr:hover {
      background-color: #e8f4fd;
    }

    #tablaCertificaciones td {
      padding: 10px 15px;
      white-space: nowrap;
    }

    /* üîπ CONTENEDOR DE LA TABLA CON SCROLL HORIZONTAL */
    #certificacionesContent {
      overflow-x: auto;
      max-width: 100%;
      margin-top: 20px;
    }

    .estado-completado {
      color: #27ae60;
      font-weight: bold;
    }

    .estado-pendiente {
      color: #e67e22;
      font-weight: bold;
    }

    .estado-incompleto {
      color: #e74c3c;
      font-weight: bold;
    }

    .calificacion-aprobada {
      color: #27ae60;
      font-weight: bold;
    }

    .calificacion-reprobada {
      color: #e74c3c;
      font-weight: bold;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ============================================
   RESPONSIVE DESIGN - MODO NOCHE
   ============================================ */

    /* üîπ LAPTOP (1024px - 1440px) */
    @media (max-width: 1440px) {
      #mainContent {
        padding: 20px;
      }

      .card:not(.card-certificaciones) {
        max-width: 90%;
        margin: 15px auto;
        padding: 20px;
      }
    }

    /* üîπ TABLET (768px - 1023px) */
    @media (max-width: 1023px) {
      body {
        flex-direction: column;
        height: auto;
        min-height: 100vh;
        padding-top: 120px;
      }

      /* Men√∫ lateral convertido en header fijo */
      #sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: auto;
        flex-direction: row;
        overflow-x: auto;
        padding: 10px 15px;
        box-shadow: 0 2px 5px var(--shadow-color);
        z-index: 1000;
        background: var(--bg-sidebar);
        justify-content: flex-start;
        align-items: center;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
      }

      /* Ocultar t√≠tulo del sidebar */
      #sidebar h2 {
        display: none;
      }

      #sidebar button {
        padding: 10px 15px;
        margin: 0;
        margin-left: 5px;
        margin-right: 5px;
        text-align: center;
        flex-shrink: 0;
        border-radius: 6px;
        font-size: 14px;
        white-space: nowrap;
        transform: none !important;
      }

      #sidebar button:hover {
        transform: none !important;
        background: rgba(255, 255, 255, 0.1);
      }

      /* Bot√≥n de salir fijo a la derecha */
      #sidebar #logoutBtn {
        margin-left: 10px;
        flex-shrink: 0;
        position: sticky;
        right: 0;
        background: var(--danger-color);
      }

      #sidebar #logoutBtn:hover {
        background: var(--danger-hover);
      }

      #mainContent {
        padding: 15px;
        margin-top: 0;
        width: 100%;
      }

      .card:not(.card-certificaciones) {
        max-width: 95%;
        margin: 10px auto;
        padding: 15px;
      }

      /* Header del usuario fijo */
      #userHeader {
        position: fixed;
        top: 60px;
        right: 0;
        left: 0;
        margin: 0;
        padding: 10px 15px;
        border-radius: 0;
        box-shadow: 0 2px 5px var(--shadow-color);
        z-index: 999;
        background: rgba(30, 41, 59, 0.95);
        justify-content: center;
        width: 100%;
      }
    }

    /* üîπ M√ìVIL GRANDE (576px - 767px) */
    @media (max-width: 767px) {
      body {
        padding-top: 110px;
      }

      #mainContent {
        padding: 0px;
        margin-top: 0;
        width: 100%;
      }

      #sidebar {
        padding: 8px 10px;
      }

      #sidebar button {
        padding: 8px 12px;
        font-size: 13px;
      }

      #userHeader {
        top: 50px;
        padding: 8px 10px;
      }

      #userHeader img {
        width: 35px;
        height: 35px;
      }

      #userHeader span {
        font-size: 14px;
      }

      /* Mejorar scroll del men√∫ */
      #sidebar {
        scrollbar-width: thin;
        scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
      }

      #sidebar::-webkit-scrollbar {
        height: 4px;
      }

      #sidebar::-webkit-scrollbar-track {
        background: transparent;
      }

      #sidebar::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        border-radius: 2px;
      }

      .card:not(.card-certificaciones) {
        max-width: 100%;
        margin: 0;
        padding: 15px;
        border-radius: 0px;
      }
    }

    

    /* üîπ M√ìVIL PEQUE√ëO (375px - 575px) */
    @media (max-width: 575px) {
      body {
        padding-top: 100px;
      }

      #mainContent {
        padding: 0px;
        margin-top: 0;
        width: 100%;
      }

      #sidebar {
        padding: 5px 8px;
      }

      #sidebar button {
        padding: 6px 10px;
        font-size: 12px;
      }

      #userHeader {
        top: 40px;
        padding: 5px 8px;
      }

      #userHeader img {
        width: 30px;
        height: 30px;
      }

      #userHeader span {
        font-size: 12px;
      }

      .card:not(.card-certificaciones) {
        max-width: 100%;
        margin: 0;
        padding: 15px;
        border-radius: 0px;
      }
    }

    

    /* üîπ MEJORAS DE SCROLL PARA EL MEN√ö */
    @media (max-width: 1023px) {
      #sidebar {
        overflow-x: auto;
        overflow-y: hidden;
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      #sidebar::-webkit-scrollbar {
        display: none;
      }
    }

    /* ============================================
   ESTILOS DE CERTIFICACIONES - MODO NOCHE
   ============================================ */

/* Estilos espec√≠ficos para la secci√≥n de certificaciones */
.card-certificaciones {
  max-width: none !important;
  width: calc(100% - 20px) !important;
  margin: 10px !important;
  padding: 25px;
  border-radius: 12px;
  box-shadow: 0 6px 15px var(--shadow-color);
  background: var(--bg-card);
  transition: transform 0.3s, box-shadow 0.3s;
  border: 1px solid var(--border-color);
}

.card-certificaciones:hover {
  transform: translateY(-3px);
  box-shadow: 0 10px 20px var(--shadow-color);
}

#certificacionesSection {
  width: 100%;
  padding: 0;
}

#certificacionesContadores {
  background: rgba(59, 130, 246, 0.1);
  border-radius: 8px;
  padding: 15px;
  margin-bottom: 20px;
  display: flex;
  justify-content: space-around;
  flex-wrap: wrap;
  border: 1px solid var(--border-color);
}

#certificacionesContadores p {
  margin: 5px 0;
  font-weight: bold;
  color: var(--text-primary);
}

#certificacionesContadores span {
  color: var(--accent-color);
  font-size: 18px;
}

#tablaCertificaciones {
  background: var(--bg-card);
  border-radius: 8px;
  overflow: hidden;
  box-shadow: 0 4px 6px var(--shadow-color);
  border: 1px solid var(--border-color);
}

#tablaCertificaciones thead {
  background: rgba(59, 130, 246, 0.1);
  color: var(--text-primary);
}

#tablaCertificaciones th {
  padding: 12px 15px;
  text-align: left;
  font-weight: 600;
  border-bottom: 1px solid var(--border-color);
}

#tablaCertificaciones tbody tr {
  border-bottom: 1px solid var(--border-color);
  transition: background-color 0.3s ease;
}

#tablaCertificaciones tbody tr:nth-child(even) {
  background-color: rgba(255, 255, 255, 0.02);
}

#tablaCertificaciones tbody tr:hover {
  background-color: rgba(59, 130, 246, 0.1);
}

#tablaCertificaciones td {
  padding: 10px 15px;
  white-space: nowrap;
  color: var(--text-primary);
}

/* üîπ CONTENEDOR DE LA TABLA CON SCROLL HORIZONTAL */
#certificacionesContent {
  overflow-x: auto;
  max-width: 100%;
  margin-top: 20px;
}

/* üîπ CORRECCI√ìN: MANTENER COLORES ORIGINALES DE ESTADOS */
.estado-completado {
  color: #27ae60 !important; /* Verde original */
  font-weight: bold;
}

.estado-pendiente {
  color: #e67e22 !important; /* Naranja original */
  font-weight: bold;
}

.estado-incompleto {
  color: #e74c3c !important; /* Rojo original */
  font-weight: bold;
}

.calificacion-aprobada {
  color: #27ae60 !important; /* Verde original */
  font-weight: bold;
}

.calificacion-reprobada {
  color: #e74c3c !important; /* Rojo original */
  font-weight: bold;
}

/* ============================================
   ESTILOS PANEL ADMIN - MODO NOCHE
   ============================================ */

/* üîß ESTILOS PARA EL PANEL DE ADMINISTRACI√ìN */
#adminSection {
  background: var(--bg-card);
  border: 1px solid var(--border-color);
}

#adminStats {
  margin-top: 10px;
  background: rgba(59, 130, 246, 0.1);
  border: 1px solid var(--border-color);
}

#adminStats h4 {
  color: var(--text-primary);
}

#adminStats div {
  color: var(--text-primary);
}

/* üîπ CORRECCI√ìN: MANTENER COLORES ORIGINALES EN ESTAD√çSTICAS ADMIN */
#pendingCount {
  color: #ff9800 !important; /* Naranja original */
}

#approvedCount {
  color: #4caf50 !important; /* Verde original */
}

#rejectedCount {
  color: #f44336 !important; /* Rojo original */
}

.admin-post-pending {
  border-left: 4px solid #ff9800 !important; /* Naranja original */
  background: rgba(255, 152, 0, 0.05) !important;
}

.admin-post-approved {
  border-left: 4px solid #4caf50 !important; /* Verde original */
  background: rgba(76, 175, 80, 0.05) !important;
}

.admin-post-rejected {
  border-left: 4px solid #f44336 !important; /* Rojo original */
  background: rgba(244, 67, 54, 0.05) !important;
}

.approve-btn {
  background: #4caf50 !important; /* Verde original */
  color: white !important;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s;
}

.approve-btn:hover {
  background: #45a049 !important; /* Verde hover original */
  transform: translateY(-2px);
}

.reject-btn {
  background: #f44336 !important; /* Rojo original */
  color: white !important;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s;
}

.reject-btn:hover {
  background: #da190b !important; /* Rojo hover original */
  transform: translateY(-2px);
}

.view-user-btn {
  background: #0b7dda !important; /* Azul original */
  color: white !important;
  border: none;
  padding: 10px 20px;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s;
}

.view-user-btn:hover {
  background: #0a6fc2 !important; /* Azul hover original */
  transform: translateY(-2px);
}

/* Estados en publicaciones normales */
.post-status-indicator {
  font-size: 12px;
  padding: 2px 8px;
  border-radius: 12px;
  margin-left: 10px;
}

.status-pending {
  background: rgba(255, 152, 0, 0.2); /* Naranja transl√∫cido */
  color: #ff9800 !important; /* Naranja original */
}

.status-approved {
  background: rgba(76, 175, 80, 0.2); /* Verde transl√∫cido */
  color: #4caf50 !important; /* Verde original */
}

.status-admin {
  background: linear-gradient(135deg, #ffd700, #ffed4e);
  color: #8b6914 !important;
  border: 1px solid #ffd700;
  font-weight: bold;
}

/* Secci√≥n de comentarios en modo oscuro */
.post-comments {
  background: var(--bg-secondary);
  border-radius: 0 0 8px 8px;
  border-top: 1px solid var(--border-color);
}

/* Texto en secci√≥n admin */
#adminSection h2,
#adminSection p {
  color: var(--text-primary);
}

#noPendingPosts h3,
#noPendingPosts p {
  color: var(--text-primary);
}

/* Botones de acci√≥n en posts del admin */
.admin-post-actions {
  background: rgba(255, 255, 255, 0.05);
  border-radius: 8px;
  padding: 15px;
  margin: 10px 0;
  border: 1px solid var(--border-color);
}

.admin-post-actions h4 {
  color: var(--text-primary);
  margin-bottom: 10px;
}

/* ============================================
   SCROLL SNAPPING CON EFECTO REBOTE
   ============================================ */

/* Configurar el contenedor principal para scroll snapping */
#mainContent {
    scroll-snap-type: y mandatory;
    scroll-behavior: smooth;
    overflow-y: auto;
}

/* Cada publicaci√≥n ser√° un punto de snap */
.post-card {
    scroll-snap-align: center;
    scroll-snap-stop: always;
    transition: all 0.3s ease;
}

/* Efecto de rebote cuando se activa el snap */
.post-card:focus {
    animation: bounceSnap 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

@keyframes bounceSnap {
    0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7);
    }
    50% {
        transform: scale(1.02);
        box-shadow: 0 0 0 10px rgba(59, 130, 246, 0.3);
    }
    100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
    }
}

/* Indicador visual cuando una publicaci√≥n est√° centrada */
.post-card.snapped {
    /*border: 2px solid var(--accent-color);*/
    animation: gentlePulse 2s infinite;
}

@keyframes gentlePulse {
    0%, 100% {
        box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4);
    }
    50% {
        box-shadow: 0 0 0 5px rgba(59, 130, 246, 0.1);
    }
}
  </style>
</head>

<body>

  <!-- Men√∫ lateral -->
  <div id="sidebar">
    <h2></h2>
    <button id="menuInicio" class="active">Inicio</button>
    <button id="menuClubes">Clubes</button>
    <button id="menuCertificaciones">Certificaciones</button>
    <button id="menuEspecialidades">Especialidades Storage</button>
    <button id="menuPerfil">Perfil</button>
    <button id="menuAdmin" class="hidden">üîß Admin</button>
    <button id="logoutBtn">Cerrar sesi√≥n</button>
  </div>

  <!-- Contenido principal -->
  <div id="mainContent">
    <!-- Header fijo con informaci√≥n del usuario -->
    <div id="userHeader">
      <img id="headerUserPhoto" src="https://dummyimage.com/45x45/ccc/fff">
      <span id="headerUserName">Cargando...</span>
    </div>

    <!-- Inicio - Red Social -->
    <div id="inicioSection" class="card">
      <!-- Contenedor de publicaci√≥n -->
      <div id="uploadContainer" class="card" style="margin-bottom: 20px;">
        <h3>Crear Publicaci√≥n</h3>
        <div id="uploadBox">
          <input type="file" id="fileInput" accept="image/*,video/*"
            style="margin-bottom: 10px; width: 100%; padding: 8px;">
          <textarea id="postDescription" placeholder="Escribe una descripci√≥n..."
            style="width: 100%; padding: 8px; margin-bottom: 10px; border-radius: 6px; border: 1px solid #ccc; font-family: inherit;"></textarea>
          <div id="previewContainer" style="margin-bottom: 10px;"></div>
          <div id="uploadProgress" style="display: none; margin-bottom: 10px;">
            <div style="background: #f0f0f0; border-radius: 10px; height: 20px;">
              <div id="progressBar"
                style="background: #1976d2; height: 100%; border-radius: 10px; width: 0%; transition: width 0.3s;">
              </div>
            </div>
            <span id="progressText" style="font-size: 14px;">0%</span>
          </div>
          <div style="display: flex; align-items: center;">
            <button id="uploadBtn"
              style="padding: 10px 20px; background: #1976d2; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;">Publicar</button>
            <span id="countdownTimer"
              style="margin-left: 15px; color: #ff5722; font-weight: bold; display: none;"></span>
          </div>
        </div>
      </div>

      <!-- Feed de publicaciones -->
      <div id="feed" style="display: flex; flex-direction: column; gap: 20px;"></div>
      <!-- Indicador de carga para scroll infinito -->
      <div id="loadingPosts" class="loading-posts hidden">
        <div class="loading" style="display: inline-block;"></div>
        <p>Cargando m√°s publicaciones...</p>
      </div>

      <!-- Indicador de fin de publicaciones -->
      <div id="noMorePosts" class="no-more-posts hidden">
        <p>No hay m√°s publicaciones para mostrar</p>
      </div>

      <!-- Elemento centinela para detectar scroll -->
      <div id="scrollSentinel" class="scroll-sentinel"></div>
    </div>

    <!-- Secci√≥n Clubes -->
    <div id="clubesSection" class="card hidden">
      <h2>Clubes</h2>

      <!-- Botones de clubes -->
      <div id="clubesContainer" style="display:flex; gap:10px; margin-bottom:15px;">
        <button class="clubBtn" data-club="aventureros">Club de Aventureros</button>
        <button class="clubBtn" data-club="conquistadores">Club de Conquistadores</button>
        <button class="clubBtn" data-club="guias">Club de Gu√≠as Mayores</button>
      </div>

      <!-- Panel de contenido de clubes -->
      <div id="clubesPanel">
        <!-- Aqu√≠ se ir√°n agregando las carpetas y secciones din√°micamente -->
      </div>
    </div>



    <!-- Especialidades Storage -->
    <div id="especialidadesSection" class="card hidden">
      <h2>Mi Almacenamiento Leyenda De Especialidades</h2>
      <!--
      <input type="text" id="nombreEspecialidad" placeholder="Nombre de la especialidad">
      <button id="crearEspecialidad">Crear Carpeta</button>-->


      <h4>Carpetas existentes:</h4>
      <ul id="listaEspecialidades"></ul>
      <div id="archivosContainer" class="hidden">
        <h3 id="especialidadActual">Especialidad:</h3>
        <button id="cerrarEspecialidad">Cerrar carpeta</button>
        <input type="file" id="subirArchivo" accept=".pdf, .jpg, .jpeg, .png">
        <button id="subirArchivoBtn">Subir Archivo</button>

        <div>
          <label for="ordenArchivos">Ordenar por:</label>
          <select id="ordenArchivos">
            <option value="nombreDesc">Nombre ‚Üì</option>
            <option value="nombreAsc">Nombre ‚Üë</option>
            <option value="fechaDesc">Fecha ‚Üì</option>
            <option value="fechaAsc">Fecha ‚Üë</option>
            <option value="sizeDesc">Tama√±o ‚Üì</option>
            <option value="sizeAsc">Tama√±o ‚Üë</option>
          </select>
        </div>

        <ul id="listaArchivos"></ul>

      </div>
    </div>

    <!-- Perfil (secci√≥n corregida) -->
    <div id="perfilSection" class="card hidden">
      <h1>Editar Informaci√≥n</h1>
      <form id="editForm">
        <div style="text-align: center; margin-bottom: 20px;">
          <img id="preview" src="https://dummyimage.com/200x200/ccc/fff"
            style="width: 200px; height: 200px; border-radius: 50%; object-fit: cover; border: 3px solid #1976d2;">
        </div>

        <h3>Actualizar Foto:</h3>
        <input type="file" id="foto" accept="image/*">

        <h3>Datos personales:</h3>

        <!-- Correo (solo lectura) -->
        <div style="margin-bottom: 15px;">
          <label for="correo" style="display: block; margin-bottom: 5px; font-weight: bold;">Correo electr√≥nico:</label>
          <input type="email" id="correo" readonly style="background-color: #f5f5f5; color: #666;">
        </div>

        <input type="text" id="nombre" placeholder="Nombre" required>
        <input type="text" id="apellido" placeholder="Apellido" required>
        <input type="number" id="edad" placeholder="Edad" required>
        <select id="sexo" required>
          <option value="">Seleccionar sexo</option>
          <option value="Masculino">Masculino</option>
          <option value="Femenino">Femenino</option>
          <option value="Otro">Otro</option>
        </select>
        <input type="text" id="pais" placeholder="Pa√≠s" required>

        <button type="submit" class="saveBtn">Guardar cambios</button>
      </form>
    </div>

    <!-- üîπ NUEVA SECCI√ìN: CERTIFICACIONES -->
    <div id="certificacionesSection" class="hidden">
      <div class="card card-certificaciones">
        <h2>üìú Mis Certificaciones de Especialidades</h2>
        <p>Aqu√≠ puedes ver todas las especialidades en las que has participado, validadas con tu correo electr√≥nico.</p>

        <div id="certificacionesLoading" style="text-align: center; padding: 20px;">
          <div class="loading" style="display: inline-block;"></div>
          <p>Cargando tus certificaciones...</p>
        </div>

        <div id="certificacionesContent" style="display: none;">
          <div id="certificacionesContadores">
            <p>Total de especialidades: <span id="totalEspecialidades">0</span></p>
            <p>Especialidades completadas: <span id="especialidadesCompletadas">0</span></p>
          </div>

          <table id="tablaCertificaciones" border="1" style="border-collapse: collapse; width: 100%; margin-top: 20px;">
            <thead>
              <tr>
                <th>#</th>
                <th>Especialidad</th>
                <th>Fecha de Participaci√≥n</th>
                <th>Asistencias Completadas</th>
                <th>Examen Realizado</th>
                <th>Calificaci√≥n</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody id="cuerpoTablaCertificaciones">
              <!-- Las filas se llenar√°n din√°micamente -->
            </tbody>
          </table>

          <div id="sinCertificaciones" style="display: none; text-align: center; padding: 30px; color: #666;">
            <h3>üìù A√∫n no tienes certificaciones</h3>
            <p>Participa en especialidades para ver tus certificaciones aqu√≠.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- üîß SECCI√ìN ADMIN -->
    <div id="adminSection" class="card hidden">
      <h2>üîß Panel de Administraci√≥n</h2>
      <p>Desde aqu√≠ puedes moderar las publicaciones pendientes de aprobaci√≥n.</p>

      <div id="adminStats" style="padding: 15px; border-radius: 8px; margin-bottom: 20px;">
        <h4>üìä Estad√≠sticas de Moderaci√≥n</h4>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
          <div style="text-align: center;">
            <div style="font-size: 24px; color: #ff9800;" id="pendingCount">0</div>
            <div>Pendientes</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 24px; color: #4caf50;" id="approvedCount">0</div>
            <div>Aprobadas</div>
          </div>
          <div style="text-align: center;">
            <div style="font-size: 24px; color: #f44336;" id="rejectedCount">0</div>
            <div>Rechazadas</div>
          </div>
        </div>
      </div>

      <div id="adminLoading" style="text-align: center; padding: 20px; display: none;">
        <div class="loading" style="display: inline-block;"></div>
        <p>Cargando publicaciones pendientes...</p>
      </div>

      <div id="adminPostsContainer">
        <!-- Aqu√≠ se cargar√°n las publicaciones pendientes -->
      </div>

      <div id="noPendingPosts" style="text-align: center; padding: 40px; display: none;">
        <h3>üéâ No hay publicaciones pendientes</h3>
        <p>Todas las publicaciones han sido moderadas.</p>
      </div>
    </div>

    <!-- üîπ Visor PDF modal -->
    <div id="pdfViewerModal" class="hidden" style="display: none;">
      <div class="pdf-viewer-content">
        <button id="cerrarPDF" class="cerrar-pdf">‚úñ</button>
        <iframe id="pdfFrame" src="" allowfullscreen style="border:none;"></iframe>
      </div>
    </div>

    <!-- üîπ Contenedor general de mensajes -->
    <div id="mensajeModal" class="hiddenX">
      <div class="mensaje-content">
        <h3 id="mensajeTitulo">T√≠tulo</h3>
        <p id="mensajeTexto">Texto del mensaje</p>
        <div id="mensajeBotones">
          <button id="mensajeAceptar">Aceptar</button>
          <button id="mensajeCancelar" class="hiddenX">Cancelar</button>
        </div>
      </div>
    </div>


    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
      import {
        getFirestore,
        doc,
        getDoc,
        updateDoc,
        addDoc,
        collection,
        getDocs,
        query,
        orderBy,
        deleteDoc,
        limit,
        setDoc,
        where,
        startAfter
      } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";
      import {
        getStorage, ref, uploadBytes, getDownloadURL, deleteObject, listAll, getMetadata
      } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";

      const firebaseConfig = {
        apiKey: "AIzaSyB1YTwZM8wKlxZ8HhXb7EUse8YyLmcfeS8",
        authDomain: "conquiguias-world-85ccd.firebaseapp.com",
        projectId: "conquiguias-world-85ccd",
        storageBucket: "conquiguias-world-85ccd.firebasestorage.app",
        messagingSenderId: "785222651205",
        appId: "1:785222651205:web:0486c50e9d8af6bf9b022c"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const storage = getStorage(app);

      // Elementos UI
      const inicioNombre = document.getElementById("inicioNombre");
      const inicioFoto = document.getElementById("inicioFoto");
      const perfilSection = document.getElementById("perfilSection");
      const inicioSection = document.getElementById("inicioSection");
      const especialidadesSection = document.getElementById("especialidadesSection");
      const menuInicio = document.getElementById("menuInicio");
      const menuPerfil = document.getElementById("menuPerfil");
      const menuEspecialidades = document.getElementById("menuEspecialidades");
      const menuCertificaciones = document.getElementById("menuCertificaciones");
      const menuAdmin = document.getElementById("menuAdmin");
      const logoutBtn = document.getElementById("logoutBtn");
      const editForm = document.getElementById("editForm");
      const fotoInput = document.getElementById("foto");
      const preview = document.getElementById("preview");
      const removePhotoBtn = document.getElementById("removePhoto");
      const nombreInput = document.getElementById("nombre");
      const apellidoInput = document.getElementById("apellido");
      const edadInput = document.getElementById("edad");
      const sexoInput = document.getElementById("sexo");
      const paisInput = document.getElementById("pais");
      const listaEspecialidades = document.getElementById("listaEspecialidades");
      const archivosContainer = document.getElementById("archivosContainer");
      const especialidadActualH3 = document.getElementById("especialidadActual");
      const subirArchivoInput = document.getElementById("subirArchivo");
      const subirArchivoBtn = document.getElementById("subirArchivoBtn");
      const listaArchivos = document.getElementById("listaArchivos");
      const cerrarEspecialidadBtn = document.getElementById("cerrarEspecialidad");

      // Elementos de Certificaciones
      const certificacionesSection = document.getElementById("certificacionesSection");
      const certificacionesLoading = document.getElementById("certificacionesLoading");
      const certificacionesContent = document.getElementById("certificacionesContent");
      const sinCertificaciones = document.getElementById("sinCertificaciones");
      const cuerpoTablaCertificaciones = document.getElementById("cuerpoTablaCertificaciones");
      const totalEspecialidades = document.getElementById("totalEspecialidades");
      const especialidadesCompletadas = document.getElementById("especialidadesCompletadas");

      let especialidadSeleccionada = "";
      let currentUserId = null;
      let currentPhotoURL = "";
      const placeholderURL = "https://dummyimage.com/120x120/ccc/fff";
      let puedeEntrarEspecialidades = false;
      let isSocialNetworkInitialized = false;
      let postsLoading = false;
      let lastLoadTime = 0;
      let certificacionesCache = null;
      let certificacionesCacheTime = 0;
      const CACHE_DURATION = 5 * 60 * 1000;


      // üîπ Detectar usuario logueado
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          // Usuario NO autenticado - redirigir al login
          console.log("üö´ Acceso denegado: usuario no autenticado");
          window.location.href = "index.html";
          return;
        }
        // üîí VERIFICACI√ìN DE CORREO ELECTR√ìNICO
        if (user && !user.emailVerified) {
          console.log("üö´ Acceso denegado: correo no verificado");

          mostrarMensaje("confirm", "üìß Verificaci√≥n requerida",
            `Hola ${user.displayName || 'usuario'},<br><br>
      <strong>Debes verificar tu correo electr√≥nico antes de acceder al panel.</strong><br><br>
      üì¨ Revisa tu bandeja de entrada y la carpeta de spam.<br>
      ¬øQuieres que te reenviemos el correo de verificaci√≥n?`,
            async () => {
              // Reenviar verificaci√≥n
              try {
                await sendEmailVerification(user);
                mostrarMensaje("info", "üìß Correo reenviado",
                  "Te hemos enviado nuevamente el correo de verificaci√≥n. " +
                  "Revisa tu bandeja de entrada y la carpeta de spam.");
              } catch (error) {
                console.error("Error reenviando verificaci√≥n:", error);
              }

              // Cerrar sesi√≥n y redirigir
              await signOut(auth);
              window.location.href = "index.html";
            },
            () => {
              // Si cancela, igualmente redirigir al login
              signOut(auth).then(() => {
                window.location.href = "index.html";
              });
            }
          );
          return;
        }

        console.log("‚úÖ Usuario verificado, acceso permitido al panel");
        currentUserId = user.uid;

        // Obtener elementos del header
        const headerUserPhoto = document.getElementById("headerUserPhoto");
        const headerUserName = document.getElementById("headerUserName");

        // Obtener el campo de correo del perfil
        const correoInput = document.getElementById("correo");

        // Dentro del onAuthStateChanged (despu√©s de obtener el usuario)
        if (user) {
          // Obtener lista de admins desde el backend
          const adminEmails = await getAdminEmails();
          const email = user.email;
          puedeEntrarEspecialidades = adminEmails.includes(email);
          isAdmin = adminEmails.includes(email); // Tambi√©n para el panel admin
        }

        // Configurar panel admin si es administrador
        if (isAdmin) {
          setupAdminSection();
          setupAdminEventListeners();
        }

        currentUserId = user.uid;

        const docRef = doc(db, "usuarios", currentUserId);
        const docSnap = await getDoc(docRef);

        if (docSnap.exists()) {
          const data = docSnap.data();
          currentPhotoURL = data.fotoURL || placeholderURL;

          // Actualizar header del usuario
          headerUserPhoto.src = currentPhotoURL;
          headerUserName.textContent = `${data.nombre || ''} ${data.apellido || ''}`;

          // Actualizar los campos del perfil
          nombreInput.value = data.nombre || '';
          apellidoInput.value = data.apellido || '';
          edadInput.value = data.edad || '';
          sexoInput.value = data.sexo || '';
          paisInput.value = data.pais || '';
          preview.src = currentPhotoURL;

          // Establecer el correo (solo lectura)
          correoInput.value = user.email || '';

          // üîπ INICIALIZAR DATOS DE RED SOCIAL - CORREGIDO
          userData = {
            ...data,
            email: user.email // üî• Asegurar que userData tenga el email
          };

          isAdmin = ADMIN_EMAILS.includes(user.email);
          lastPostTime = data.lastPostTime || null;

          // üîπ INICIALIZAR RED SOCIAL INMEDIATAMENTE SI ESTAMOS EN INICIO
          if (!inicioSection.classList.contains('hidden')) {
            setTimeout(() => {
              initializeSocialNetwork();
            }, 500);
          }
        }

        cargarEspecialidadesFijas();
      });

      // üîπ Navegaci√≥n
      menuInicio.addEventListener("click", () => mostrarSeccion(inicioSection, menuInicio));
      menuPerfil.addEventListener("click", () => mostrarSeccion(perfilSection, menuPerfil));
      menuCertificaciones.addEventListener("click", () => {
        mostrarSeccion(certificacionesSection, menuCertificaciones);
        cargarCertificaciones();
      });

      // üîπ Men√∫ Especialidades con bloqueo si no es autorizado
      menuEspecialidades.addEventListener("click", () => {
        if (!puedeEntrarEspecialidades) {
          mostrarMensaje("error", "Acceso restringido", "üö´ Solo personal Premium puede ingresar a esta secci√≥n.");
          return;
        }

        mostrarSeccion(especialidadesSection, menuEspecialidades);
        cargarEspecialidadesFijas();
      });

      // üîπ Foto de perfil
      fotoInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = () => preview.src = reader.result;
          reader.readAsDataURL(file);
        }
      });

      // üîπ Guardar perfil (versi√≥n con eliminaci√≥n de foto anterior)
      editForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        if (!currentUserId) return;

        let newPhotoURL = currentPhotoURL;
        const file = fotoInput.files[0];

        try {
          // ‚úÖ Validar tama√±o antes de subir
          if (file && file.size > 1024 * 1024) {
            mostrarMensaje("info", "‚ö†Ô∏è La imagen no debe superar 1 MB.", "");
            return;
          }

          // ‚úÖ Si hay un archivo nuevo, eliminar el anterior
          if (file && currentPhotoURL) {
            try {
              // Buscar y eliminar foto anterior
              const oldRef = ref(storage, currentPhotoURL);
              await deleteObject(oldRef);
              console.log("üóëÔ∏è Foto anterior eliminada del servidor");
            } catch (err) {
              console.warn("‚ö†Ô∏è No se pudo eliminar la foto anterior:", err.message);
            }
          }

          // ‚úÖ Subir la nueva imagen (si existe)
          if (file) {
            const storageRef = ref(storage, `usuarios/${currentUserId}/${file.name}`);
            await uploadBytes(storageRef, file);
            newPhotoURL = await getDownloadURL(storageRef);
          }

          // ‚úÖ Actualizar datos en Firestore
          const docRef = doc(db, "usuarios", currentUserId);
          await updateDoc(docRef, {
            nombre: nombreInput.value,
            apellido: apellidoInput.value,
            edad: edadInput.value,
            sexo: sexoInput.value,
            pais: paisInput.value,
            fotoURL: newPhotoURL
          });

          mostrarMensaje("info", "‚úÖ Informaci√≥n actualizada correctamente.", "", () => {
            window.location.reload();
          });

        } catch (error) {
          console.error(error);
          mostrarMensaje("error", "‚ùå Error al actualizar", "");
        }
      });

      logoutBtn.addEventListener("click", async () => {
        await signOut(auth);
        window.location.href = "index.html";
      });

      ////////////////////////
      // üìÅ ESPECIALIDADES STORAGE
      ////////////////////////
      const especialidadesFijas = ["Especialidades Completadas", "Certificaciones", "Carpeta Gu√≠a Mayor", "Otros"];

      function cargarEspecialidadesFijas() {
        listaEspecialidades.innerHTML = "";
        especialidadesFijas.forEach(nombre => {
          const li = document.createElement("li");
          li.textContent = nombre;
          li.classList.add("carpeta-item");
          listaEspecialidades.appendChild(li);
        });
      }

      listaEspecialidades.addEventListener("click", (e) => {
        if (e.target.tagName !== "LI") return;
        especialidadSeleccionada = e.target.textContent;
        especialidadActualH3.textContent = `üìÇ ${especialidadSeleccionada}`;
        archivosContainer.classList.remove("hidden");
        cargarArchivos(especialidadSeleccionada);
      });

      subirArchivoBtn.addEventListener("click", async () => {
        if (!especialidadSeleccionada || !subirArchivoInput.files[0])
          return mostrarMensaje("info", "Selecciona un archivo v√°lido", "");

        const file = subirArchivoInput.files[0];
        const ext = file.name.split(".").pop().toLowerCase();
        if (!["pdf", "jpg", "jpeg", "png"].includes(ext))
          return mostrarMensaje("error", "‚ùå Solo se permiten archivos PDF o im√°genes (JPG, JPEG, PNG)", "No se aceptan extensiones diferentes que no sean archivos de pdf o im√°genes.");

        const storageRefFile = ref(storage, `usuarios/${currentUserId}/carpetas/${especialidadSeleccionada}/${file.name}`);
        await uploadBytes(storageRefFile, file);
        mostrarMensaje("info", `üìÑ Archivo "${file.name}" subido correctamente`, "");
        subirArchivoInput.value = "";
        cargarArchivos(especialidadSeleccionada);
      });

      async function cargarArchivos(especialidad, orden = "nombreDesc") {
        listaArchivos.innerHTML = "";
        const folderRef = ref(storage, `usuarios/${currentUserId}/carpetas/${especialidad}/`);
        try {
          const result = await listAll(folderRef);
          if (result.items.length === 0) {
            listaArchivos.innerHTML = "<li>No hay archivos a√∫n.</li>";
            return;
          }

          const archivos = [];
          for (const fileRef of result.items) {
            const url = await getDownloadURL(fileRef);
            const meta = await getMetadata(fileRef);

            archivos.push({
              ref: fileRef,
              url,
              nombre: fileRef.name,
              fecha: new Date(meta.timeCreated),
              size: meta.size
            });
          }

          // üîπ Orden seg√∫n selecci√≥n
          switch (orden) {
            case "nombreAsc":
              archivos.sort((a, b) => a.nombre.localeCompare(b.nombre));
              break;
            case "nombreDesc":
              archivos.sort((a, b) => b.nombre.localeCompare(a.nombre));
              break;
            case "fechaAsc":
              archivos.sort((a, b) => a.fecha - b.fecha);
              break;
            case "fechaDesc":
              archivos.sort((a, b) => b.fecha - a.fecha);
              break;
            case "sizeAsc":
              archivos.sort((a, b) => a.size - b.size);
              break;
            case "sizeDesc":
              archivos.sort((a, b) => b.size - a.size);
              break;
          }

          // üîπ Crear elementos en la lista (igual que antes)
          archivos.forEach(file => {
            const li = document.createElement("li");
            li.classList.add("archivo-item");
            li.style.display = "flex";
            li.style.justifyContent = "space-between";
            li.style.alignItems = "center";

            const nombreSpan = document.createElement("span");
            nombreSpan.textContent = file.nombre;
            nombreSpan.classList.add("archivo-link");
            nombreSpan.style.cursor = "pointer";
            nombreSpan.addEventListener("click", () => {
              const ext = file.nombre.split('.').pop().toLowerCase();
              if (ext === "pdf") abrirVisorPDF(file.url);
              else window.open(file.url, "_blank");
            });

            const infoSpan = document.createElement("span");
            infoSpan.textContent = `${file.fecha.toLocaleDateString()} ${file.fecha.toLocaleTimeString()} ‚Ä¢ ${(file.size / 1024).toFixed(2)} KB`;
            infoSpan.style.color = "#555";
            infoSpan.style.fontSize = "13px";

            const eliminarBtn = document.createElement("button");
            eliminarBtn.textContent = "üóëÔ∏è";
            eliminarBtn.classList.add("delete-btn");
            eliminarBtn.addEventListener("click", async () => {
              mostrarMensaje("confirm", "Confirmar eliminaci√≥n", `¬øEliminar "${file.nombre}"?`, async () => {
                await deleteObject(file.ref);
                cargarArchivos(especialidad, orden);
              });

            });

            const infoContainer = document.createElement("div");
            infoContainer.style.display = "flex";
            infoContainer.style.gap = "10px";
            infoContainer.appendChild(infoSpan);
            infoContainer.appendChild(eliminarBtn);

            li.appendChild(nombreSpan);
            li.appendChild(infoContainer);
            listaArchivos.appendChild(li);
          });

        } catch (err) {
          console.error("Error al cargar archivos:", err);
          mostrarMensaje("error", "Error al cargar archivos", "");
        }
      }
      const ordenSelect = document.getElementById("ordenArchivos");

      ordenSelect.addEventListener("change", () => {
        if (especialidadSeleccionada) {
          cargarArchivos(especialidadSeleccionada, ordenSelect.value);
        }
      });

      cerrarEspecialidadBtn.addEventListener("click", () => {
        archivosContainer.classList.add("hidden");
        especialidadSeleccionada = "";
      });

      function mostrarSeccion(seccion, botonActivo) {
        pausarTodosLosVideos();
        [inicioSection, perfilSection, especialidadesSection, clubesSection, certificacionesSection, adminSection].forEach(sec => sec.classList.add("hidden"));
        [menuInicio, menuPerfil, menuEspecialidades, menuClubes, menuCertificaciones, menuAdmin].forEach(btn => btn.classList.remove("active"));

        seccion.classList.remove("hidden");
        botonActivo.classList.add("active");
      }

      ////////////////////////////////////////////
      // üîπ VISOR PDF
      const pdfViewerModal = document.getElementById("pdfViewerModal");
      const pdfFrame = document.getElementById("pdfFrame");
      const cerrarPDF = document.getElementById("cerrarPDF");

      function abrirVisorPDF(url) {
        pdfFrame.src = url;
        pdfViewerModal.style.display = "flex";
      }

      // üîπ MODIFICAR EL CIERRE DEL MODAL PARA LIMPIAR EL CONTENIDO
      cerrarPDF.addEventListener('click', () => {
        pdfViewerModal.style.display = "none";
        pdfFrame.src = "";

        // Ocultar y limpiar el contenedor de certificaci√≥n
        const certContainer = document.getElementById('certificacionContainer');
        if (certContainer) {
          certContainer.style.display = 'none';
          certContainer.innerHTML = '';
        }

        // Mostrar el iframe nuevamente
        pdfFrame.style.display = 'block';
      });

      pdfViewerModal.addEventListener('click', (e) => {
        if (e.target === pdfViewerModal) {
          pdfViewerModal.style.display = "none";
          pdfFrame.src = "";

          // Ocultar y limpiar el contenedor de certificaci√≥n
          const certContainer = document.getElementById('certificacionContainer');
          if (certContainer) {
            certContainer.style.display = 'none';
            certContainer.innerHTML = '';
          }

          // Mostrar el iframe nuevamente
          pdfFrame.style.display = 'block';
        }
      });

      ////////////////////////////////////////
      /**
       * üîπ Mostrar mensaje din√°mico
       * @param {string} tipo - "info" | "error" | "confirm"
       * @param {string} titulo - Texto del t√≠tulo
       * @param {string} mensaje - Texto del cuerpo
       * @param {function} onConfirm - (Opcional) callback si se presiona "Aceptar" en tipo confirm
       */
      function mostrarMensaje(tipo, titulo, mensaje, onConfirm = null) {
        const modal = document.getElementById("mensajeModal");
        const tituloEl = document.getElementById("mensajeTitulo");
        const textoEl = document.getElementById("mensajeTexto");
        const btnAceptar = document.getElementById("mensajeAceptar");
        const btnCancelar = document.getElementById("mensajeCancelar");

        tituloEl.textContent = titulo;
        textoEl.textContent = mensaje;
        modal.classList.remove("hiddenX");

        // Configurar botones
        btnCancelar.classList.toggle("hiddenX", tipo !== "confirm");

        const cerrar = () => {
          modal.classList.add("hiddenX");
          btnAceptar.onclick = null;
          btnCancelar.onclick = null;
        };

        btnAceptar.onclick = () => {
          cerrar();
          if (onConfirm && (tipo === "confirm" || tipo === "info")) onConfirm();
        };

        btnCancelar.onclick = cerrar;
      }

      ////////////////////////////////////////////
      const menuClubes = document.getElementById("menuClubes");
      const clubesSection = document.getElementById("clubesSection");

      menuClubes.addEventListener("click", () => {
        mostrarSeccion(clubesSection, menuClubes);
      });
      ///////////////////////////////////////////

      const clubBtns = document.querySelectorAll(".clubBtn");
      const clubesPanel = document.getElementById("clubesPanel");

      // Datos de cada club
      const clubesData = {
        aventureros: {
          niveles: ["Amigo", "Compa√±ero", "Explorador"],
          carpetas: ["Voto y Ley", "Bandera de Aventureros", "Himno del Club"]
        },
        conquistadores: {
          niveles: ["Amigo", "Compa√±ero", "Explorador", "Orientador", "Viajero", "Gu√≠a"],
          carpetas: [
            "Voto y Ley",
            "Especialidades Ja",
            "Bandera de Conquistadores",
            "Himno del Conquistador",
            "Manual de Nudos",
            "Formularios y Permisos",
            "Manual del Uniforme",
            "Uso del Hacha y Cuchillo",
            "Registros",
            "Gu√≠a para el Director",
            "Gu√≠a R√°pida para el Director del Club de Conquistadores",
            "Logos e Im√°genes",
            "Lista de Especialidades para Cada Nivel Progresivo"
          ]
        },
        guias: {
          niveles: ["Explorador", "Gu√≠a", "Coordinador"],
          carpetas: ["Voto y Ley", "Manual de Gu√≠as", "Registros"]
        }
      };

      // Click en club
      clubBtns.forEach(btn => {
        btn.addEventListener("click", () => {
          const clubKey = btn.dataset.club;

          // Limpiar panel
          clubesPanel.innerHTML = "";

          const clubData = clubesData[clubKey] || { niveles: [], carpetas: [] };

          const clubContainer = document.createElement("div");
          clubContainer.dataset.panel = clubKey;

          // üîπ Niveles
          if (clubData.niveles.length > 0) {
            const nivelesContainer = document.createElement("div");
            nivelesContainer.style.display = "grid";
            nivelesContainer.style.gridTemplateColumns = "repeat(3, 1fr)";
            nivelesContainer.style.gap = "10px";
            nivelesContainer.style.marginBottom = "15px";

            const nivelesContenidoContainer = document.createElement("div");

            clubData.niveles.forEach(nivel => {
              const btnNivel = document.createElement("div");
              btnNivel.classList.add("carpeta-item");
              btnNivel.textContent = nivel;

              const contenido = document.createElement("div");
              contenido.classList.add("hidden");
              contenido.style.marginTop = "5px";
              contenido.textContent = "Contenido de " + nivel;

              btnNivel.addEventListener("click", () => {
                contenido.classList.toggle("hidden");
              });

              nivelesContainer.appendChild(btnNivel);
              nivelesContenidoContainer.appendChild(contenido);
            });

            clubContainer.appendChild(nivelesContainer);
            clubContainer.appendChild(nivelesContenidoContainer);
          }

          // üîπ Carpetas
          if (clubData.carpetas.length > 0) {
            const carpetasContainer = document.createElement("div");
            clubData.carpetas.forEach(carpetaName => {
              const carpeta = document.createElement("div");
              carpeta.classList.add("carpeta-item");
              carpeta.textContent = carpetaName;

              const contenido = document.createElement("div");
              contenido.classList.add("hidden");
              contenido.style.marginLeft = "20px";
              contenido.style.marginBottom = "5px";

              const archivo = document.createElement("div");
              archivo.textContent = "Contenido de " + carpetaName;
              contenido.appendChild(archivo);

              carpeta.addEventListener("click", () => {
                contenido.classList.toggle("hidden");
              });

              carpetasContainer.appendChild(carpeta);
              carpetasContainer.appendChild(contenido);
            });

            clubContainer.appendChild(carpetasContainer);
          }

          clubesPanel.appendChild(clubContainer);
        });
      });

      // üîπ NUEVAS FUNCIONES PARA CERTIFICACIONES - DENTRO DEL M√ìDULO

      // Funci√≥n para cargar las certificaciones del usuario
      // Funci√≥n para cargar las certificaciones del usuario
      // üîπ NUEVAS FUNCIONES PARA CERTIFICACIONES - DENTRO DEL M√ìDULO

      // Funci√≥n para cargar las certificaciones del usuario
      // üîπ NUEVAS FUNCIONES PARA CERTIFICACIONES - DENTRO DEL M√ìDULO

      // Funci√≥n para cargar las certificaciones del usuario
      // üîπ REEMPLAZAR LA FUNCI√ìN cargarCertificaciones CON ESTA VERSI√ìN MEJORADA
async function cargarCertificaciones() {
    agregarLogFirestore('cargarCertificaciones');
    
    // üîí Usar cache si est√° disponible
    const now = Date.now();
    if (certificacionesCache && (now - certificacionesCacheTime < CACHE_DURATION)) {
        console.log('üìö Usando cache de certificaciones');
        actualizarInterfazCertificaciones(certificacionesCache);
        return;
    }

    // Mostrar loading
    certificacionesLoading.style.display = "block";
    certificacionesContent.style.display = "none";
    sinCertificaciones.style.display = "none";

    try {
        // Obtener el usuario actual
        const user = auth.currentUser;
        if (!user || !user.email) {
            throw new Error("No se pudo obtener la informaci√≥n del usuario");
        }

        const userEmail = user.email.toLowerCase().trim();

        // üî• MEJORA: Obtener visitanteId de m√∫ltiples fuentes
        let visitanteId = localStorage.getItem("visitanteId");
        
        // Si no hay visitanteId en localStorage, intentar generarlo
        if (!visitanteId) {
            // Crear un visitanteId basado en el email del usuario
            visitanteId = 'user_' + btoa(userEmail).replace(/[^a-zA-Z0-9]/g, '').substring(0, 16);
            localStorage.setItem("visitanteId", visitanteId);
            console.log('üÜï VisitanteId generado:', visitanteId);
        }

        console.log('üîç Buscando certificaciones para:', {
            email: userEmail,
            visitanteId: visitanteId,
            platform: navigator.userAgent
        });

        // Obtener todos los formularios
        const formulariosRes = await fetch("/api/formulario?action=listarFormularios");
        if (!formulariosRes.ok) {
            throw new Error("No se pudieron cargar los formularios");
        }

        const formularios = await formulariosRes.json();
        const formulariosIds = Object.keys(formularios);

        // Array para almacenar las certificaciones
        const certificaciones = [];

        // Para cada formulario, buscar si el usuario particip√≥
        for (const formularioId of formulariosIds) {
            try {
                const respuestasRes = await fetch(`/api/formulario?action=verRespuestas&id=${formularioId}`);
                if (respuestasRes.ok) {
                    const data = await respuestasRes.json();
                    const respuestas = data.asistencias || [];
                    const examenes = data.examenes || [];

                    // Obtener la fecha de cierre del formulario desde la lista de formularios
                    const fechaCierreFormulario = formularios[formularioId].fechaCierre;
                    const fechaFin = fechaCierreFormulario ? new Date(fechaCierreFormulario) : null;
                    const hoy = new Date();

                    // üî• MEJORA: B√∫squeda m√°s robusta de respuestas del usuario
                    let respuestasUsuario = respuestas.filter(r => {
                        // Buscar por email (case insensitive)
                        const rEmail = (r.correo || '').toLowerCase().trim();
                        const emailMatch = rEmail === userEmail;
                        
                        // Buscar por visitanteId
                        const visitanteMatch = r.visitanteId === visitanteId;
                        
                        // Buscar por userId si existe
                        const userIdMatch = r.userId === currentUserId;
                        
                        return emailMatch || visitanteMatch || userIdMatch;
                    });

                    console.log(`üìã Formulario ${formularioId}:`, {
                        totalRespuestas: respuestas.length,
                        respuestasUsuario: respuestasUsuario.length,
                        criterios: {
                            email: userEmail,
                            visitanteId: visitanteId,
                            userId: currentUserId
                        }
                    });

                    // Si no encontramos respuestas, continuar con el siguiente formulario
                    if (respuestasUsuario.length === 0) {
                        continue;
                    }

                    // Agrupar respuestas por identificador √∫nico (email + visitanteId)
                    const respuestasAgrupadas = {};
                    respuestasUsuario.forEach(respuesta => {
                        const key = respuesta.visitanteId || respuesta.correo || 'unknown';
                        if (!respuestasAgrupadas[key]) {
                            respuestasAgrupadas[key] = [];
                        }
                        respuestasAgrupadas[key].push(respuesta);
                    });

                    // Procesar cada grupo de respuestas
                    for (const [grupoKey, respuestasGrupo] of Object.entries(respuestasAgrupadas)) {
                        // Encontrar el examen del usuario para este grupo
                        const examenUsuario = examenes.find(e => 
                            e.visitanteId === grupoKey || 
                            (e.correo && e.correo.toLowerCase() === userEmail)
                        );

                        // üî• CORRECCI√ìN MEJORADA: Contar asistencias completadas
                        const numerosAsistencia = respuestasGrupo.map(r => parseInt(r.asistenciaNumero) || 0);
                        const asistenciasUnicas = [...new Set(numerosAsistencia)]; // Eliminar duplicados
                        const asistenciasCompletadas = asistenciasUnicas.filter(num => 
                            num >= 1 && num <= 3
                        ).length;

                        const examenRealizado = examenUsuario !== undefined;
                        const calificacion = examenRealizado ? examenUsuario.puntaje : null;
                        const aprobado = examenRealizado ? calificacion >= 70 : false;

                        // üî• NUEVA L√ìGICA MEJORADA PARA DETERMINAR ESTADO
                        let estado = "";
                        let estadoClase = "";

                        if (fechaFin && hoy > fechaFin) {
                            // TIEMPO TERMINADO
                            if (asistenciasCompletadas >= 3) {
                                if (examenRealizado && aprobado) {
                                    estado = "Completado";
                                    estadoClase = "estado-completado";
                                } else {
                                    estado = "Incompleto";
                                    estadoClase = "estado-incompleto";
                                }
                            } else {
                                estado = "No aplica";
                                estadoClase = "estado-incompleto";
                            }
                        } else {
                            // TIEMPO EN CURSO
                            if (asistenciasCompletadas >= 3) {
                                if (examenRealizado && aprobado) {
                                    estado = "Completado";
                                    estadoClase = "estado-completado";
                                } else {
                                    estado = "En progreso";
                                    estadoClase = "estado-pendiente";
                                }
                            } else {
                                estado = "En progreso";
                                estadoClase = "estado-pendiente";
                            }
                        }

                        // Obtener la fecha m√°s reciente
                        const fechaMasReciente = new Date(Math.max(...respuestasGrupo.map(r => new Date(r.fecha))));

                        certificaciones.push({
                            formularioId: formularioId,
                            titulo: formularios[formularioId].titulo,
                            fecha: fechaMasReciente,
                            asistenciasCompletadas: asistenciasCompletadas,
                            examenRealizado: examenRealizado,
                            calificacion: calificacion,
                            aprobado: aprobado,
                            estado: estado,
                            estadoClase: estadoClase,
                            fechaFin: fechaFin,
                            visitanteId: grupoKey,
                            debug: {
                                respuestasCount: respuestasGrupo.length,
                                numerosAsistencia: numerosAsistencia,
                                asistenciasUnicas: asistenciasUnicas
                            }
                        });

                        console.log(`‚úÖ Certificaci√≥n agregada:`, {
                            formulario: formularios[formularioId].titulo,
                            asistenciasCompletadas: asistenciasCompletadas,
                            estado: estado,
                            grupo: grupoKey
                        });
                    }
                }
            } catch (error) {
                console.error(`Error al cargar respuestas para ${formularioId}:`, error);
            }
        }

        // Guardar en cache
        certificacionesCache = certificaciones;
        certificacionesCacheTime = now;
        
        console.log('üìä Certificaciones encontradas:', certificaciones.length);
        
        // Actualizar la interfaz con las certificaciones
        actualizarInterfazCertificaciones(certificaciones);

    } catch (error) {
        console.error("Error al cargar certificaciones:", error);
        mostrarMensaje("error", "Error al cargar certificaciones", "No se pudieron cargar tus certificaciones. Intenta nuevamente.");

        // Mostrar estado de error
        certificacionesLoading.style.display = "none";
        sinCertificaciones.style.display = "block";
        sinCertificaciones.innerHTML = `
            <h3>‚ùå Error al cargar certificaciones</h3>
            <p>No se pudieron cargar tus certificaciones. Intenta nuevamente.</p>
            <button onclick="cargarCertificaciones()" style="margin-top: 10px; padding: 8px 16px; background: var(--accent-color); color: white; border: none; border-radius: 4px; cursor: pointer;">
                Reintentar
            </button>
        `;
    }
}





      // üîπ AGREGAR FUNCIONES AL WINDOW PARA QUE SEAN GLOBALES
      window.verCertificacionCompleta = verCertificacionCompleta;
      window.imprimirExamenCompleto = imprimirExamenCompleto;
      window.mostrarCertificacionCompleta = mostrarCertificacionCompleta;
      window.extraerNombreFirma = extraerNombreFirma;

      // üîπ FUNCIONES PARA CERTIFICACI√ìN COMPLETA
      async function verCertificacionCompleta(formularioId, visitanteId) {
        try {
          // Obtener la evaluaci√≥n (preguntas)
          const resExamen = await fetch(`/api/formulario?action=obtenerEvaluacion&id=${formularioId}`);
          if (!resExamen.ok) {
            throw new Error('No se pudo cargar la evaluaci√≥n');
          }
          const examen = await resExamen.json();

          // Obtener el resultado del examen
          const resResultados = await fetch(`/api/formulario?action=verRespuestas&id=${formularioId}`);
          if (!resResultados.ok) {
            throw new Error('No se pudo cargar los resultados');
          }
          const data = await resResultados.json();
          const resultadosExamen = data.examenes || [];
          const resultado = resultadosExamen.find(e => e.visitanteId === visitanteId);

          if (!resultado) {
            mostrarMensaje("error", "Error", "No se encontraron resultados para este examen.");
            return;
          }

          // Obtener informaci√≥n del formulario para el t√≠tulo
          const resFormulario = await fetch(`/api/formulario?action=obtenerFormulario&id=${formularioId}`);
          if (!resFormulario.ok) {
            throw new Error('No se pudo cargar la informaci√≥n del formulario');
          }
          const formulario = await resFormulario.json();

          // Mostrar en el modal extendido
          mostrarCertificacionCompleta(examen, resultado, formulario, formularioId);

        } catch (error) {
          console.error('Error al cargar certificaci√≥n completa:', error);
          mostrarMensaje("error", "Error", "No se pudo cargar la certificaci√≥n: " + error.message);
        }
      }

      function mostrarCertificacionCompleta(examen, resultado, formulario, formularioId) {
        // Usar el modal del visor PDF pero con contenido personalizado
        const modal = document.getElementById('pdfViewerModal');
        const pdfFrame = document.getElementById('pdfFrame');

        // Ocultar el iframe y mostrar nuestro contenido personalizado
        pdfFrame.style.display = 'none';

        // Crear contenedor para la certificaci√≥n si no existe
        let certContainer = modal.querySelector('#certificacionContainer');
        if (!certContainer) {
          certContainer = document.createElement('div');
          certContainer.id = 'certificacionContainer';
          certContainer.style.cssText = `
            width: 100%;
            height: 100%;
            padding: 20px;
            overflow-y: auto;
            background: var(--bg-card);
        `;
          modal.querySelector('.pdf-viewer-content').appendChild(certContainer);
        }

        certContainer.style.display = 'block';

        // Generar el contenido de la certificaci√≥n
        const respuestasUsuario = resultado.respuestas || {};
        let correctas = 0;
        let total = examen.length;

        // Calcular estad√≠sticas
        examen.forEach(pregunta => {
          const respuestaUsuario = respuestasUsuario[pregunta.id];
          const respuestaCorrecta = pregunta.options.find(opt => opt.correct);
          if (respuestaCorrecta && respuestaUsuario === respuestaCorrecta.id) {
            correctas++;
          }
        });

        // Calcular si aprob√≥
        const porcentaje = (correctas / total) * 100;
        const aprobado = porcentaje >= 70;

        let contenidoHTML = `
        <div style="max-width: 800px; margin: 0 auto; padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
            <!-- Encabezado -->
            <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #2c3e50; padding-bottom: 20px;">
                <h1 style="color: white; margin-bottom: 10px; font-size: 36px;">Conquiguias World</h1>
                <h2 style="color: white; margin-bottom: 20px;">${formulario.titulo}</h2>
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px;">
                    <h3 style="margin: 0 0 10px 0;">Resultados del Examen</h3>
                    <p style="margin: 5px 0; font-size: 18px;">
                        <strong>Resumen:</strong> ${correctas} de ${total} preguntas correctas (${porcentaje.toFixed(1)}%)
                    </p>
                    <p style="margin: 5px 0; font-size: 16px;">
                        <strong>Estado:</strong> ${porcentaje >= 70 ? '‚úÖ Aprobado' : '‚ùå Reprobado'}
                    </p>
                </div>
            </div>

            <!-- Preguntas y respuestas -->
            <div style="margin-bottom: 30px;">
    `;

        // Agregar cada pregunta con retroalimentaci√≥n
        examen.forEach((pregunta, index) => {
          const respuestaUsuario = respuestasUsuario[pregunta.id];
          const respuestaCorrecta = pregunta.options.find(opt => opt.correct);
          const opcionUsuario = pregunta.options.find(opt => opt.id === respuestaUsuario);
          const esCorrecta = respuestaCorrecta && respuestaUsuario === respuestaCorrecta.id;

          contenidoHTML += `
            <div style="margin-bottom: 25px; padding: 20px; border: 2px solid ${esCorrecta ? '#28a745' : '#dc3545'}; border-radius: 10px; background: #f8f9fa;">
                <p style="margin: 0 0 15px 0; font-weight: bold; color: #2c3e50; font-size: 16px;">
                    Pregunta ${index + 1}: ${pregunta.text}
                </p>
                <p style="margin: 0 0 10px 0; color: ${esCorrecta ? '#28a745' : '#dc3545'}; font-weight: bold;">
                    ${esCorrecta ? '‚úÖ Correcta' : '‚ùå Incorrecta'}
                </p>
                <p style="margin: 0 0 8px 0; font-size: 14px; color: black;">
                    <strong>Tu respuesta:</strong> ${opcionUsuario ? opcionUsuario.text : 'No respondida'}
                </p>
                ${!esCorrecta && respuestaCorrecta ? `
                    <p style="margin: 0 0 5px 0; font-size: 14px; color: #28a745;">
                        <strong>Respuesta correcta:</strong> ${respuestaCorrecta.text}
                    </p>
                ` : ''}
            </div>
        `;
        });

        contenidoHTML += `
            </div>

            <!-- Botones de acci√≥n -->
            <div style="margin-top: 30px; text-align: center; padding: 20px; background: #ecf0f1; border-radius: 10px;">
        `;

        // Mostrar bot√≥n de impresi√≥n SOLO si aprob√≥
        if (aprobado) {
          contenidoHTML += `
                <button id="btnImprimirExamen" style="
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    border: none;
                    padding: 12px 25px;
                    font-size: 16px;
                    font-weight: bold;
                    border-radius: 6px;
                    cursor: pointer;
                    margin: 0 10px;
                ">üñ®Ô∏è Imprimir Examen y Certificaci√≥n</button>
            `;
        } else {
          contenidoHTML += `
                <div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                    <p style="margin: 0; color: #856404; font-size: 14px;">
                        ‚ö†Ô∏è <strong>No aprobado:</strong> Has completado el examen pero no alcanzaste la calificaci√≥n m√≠nima para obtener el certificado.
                    </p>
                </div>
            `;
        }



        certContainer.innerHTML = contenidoHTML;
        modal.style.display = 'flex';

        // Configurar event listeners para los botones SOLO si aprob√≥
        if (aprobado) {
          document.getElementById('btnImprimirExamen').addEventListener('click', () => {
            imprimirExamenCompleto(examen, resultado, formulario, formularioId);
          });

        }

      }

      function imprimirExamenCompleto(examen, resultado, formulario, formularioId) {
        const btnImprimir = document.getElementById('btnImprimirExamen');
        const textoOriginal = btnImprimir.innerHTML;

        // Mostrar loading
        btnImprimir.innerHTML = '‚è≥ Generando PDF...';
        btnImprimir.disabled = true;

        // Obtener el nombre del usuario desde las asistencias
        fetch(`/api/formulario?action=verRespuestas&id=${formularioId}`)
          .then(res => res.json())
          .then(data => {
            const asistencias = data.asistencias || [];
            // Buscar CUALQUIER asistencia del usuario para obtener su nombre
            const asistenciaUsuario = asistencias.find(a =>
              a.visitanteId === resultado.visitanteId && a.nombre && a.nombre.trim() !== ''
            );

            let nombreUsuario = 'Nombre no encontrado';
            if (asistenciaUsuario && asistenciaUsuario.nombre) {
              nombreUsuario = asistenciaUsuario.nombre.trim();
            } else {
              // Si no se encuentra en asistencias, intentar obtener del perfil del usuario
              const user = auth.currentUser;
              if (user && user.displayName) {
                nombreUsuario = user.displayName;
              } else {
                // √öltimo recurso: usar el correo sin el dominio
                const email = user.email;
                if (email) {
                  nombreUsuario = email.split('@')[0];
                  nombreUsuario = nombreUsuario.split('.').map(word =>
                    word.charAt(0).toUpperCase() + word.slice(1)
                  ).join(' ');
                }
              }
            }

            // Crear ventana de impresi√≥n
            const ventanaImpresion = window.open('', '_blank');
            const respuestasUsuario = resultado.respuestas || {};

            // Calcular estad√≠sticas del examen
            let correctas = 0;
            let total = examen.length;

            examen.forEach(pregunta => {
              const respuestaUsuario = respuestasUsuario[pregunta.id];
              const respuestaCorrecta = pregunta.options.find(opt => opt.correct);
              if (respuestaCorrecta && respuestaUsuario === respuestaCorrecta.id) {
                correctas++;
              }
            });

            const porcentaje = (correctas / total) * 100;
            const aprobado = porcentaje >= 70;

            // Formatear fecha
            const fechaCreacion = new Date(formulario.creado);
            const opcionesFecha = { year: 'numeric', month: 'long', day: 'numeric' };
            const fechaFormateada = fechaCreacion.toLocaleDateString('es-ES', opcionesFecha);

            // üîπ AGREGAR LAS IM√ÅGENES DECORATIVAS AL CERTIFICADO
            let contenidoImpresion = `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Examen y Certificaci√≥n - ${formulario.titulo}</title>
                    <link
    href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=Great+Vibes&family=Montserrat:wght@300;500;700&display=swap"
    rel="stylesheet">
                    <style>
                        /* ESTILOS PARA EL EXAMEN */
                        .examen-section {
                            margin: 20px;
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        }
                        .header-examen {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 2px solid #2c3e50;
                            padding-bottom: 20px;
                            position: relative;
                        }
                        .imagen-especialidad-examen {
                            position: absolute;
                            top: 10px;
                            right: 10px;
                            max-width: 80px;
                            max-height: 80px;
                        }
                            .resumen-examen {
                            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                            color: white;
                            padding: 25px;
                            border-radius: 12px;
                            margin-bottom: 30px;
                            text-align: center;
                        }
                        .pregunta {
                            margin-bottom: 20px;
                            padding: 15px;
                            border-left: 4px solid #3498db;
                            background: #f8f9fa;
                            page-break-inside: avoid;
                        }
                        .correcta { border-left-color: #28a745; }
                        .incorrecta { border-left-color: #dc3545; }
                        
                        /* ESTILOS PARA EL CERTIFICADO (HOJA COMPLETA SEPARADA) */
                        .certificacion-page {
                            page-break-before: always;
                            width: 100%;
                            min-height: 100vh;
                            margin: 0;
                            padding: 40px;
                            display: flex;
                            flex-direction: column;
                            justify-content: center;
                            align-items: center;
                            position: relative;
                            box-sizing: border-box;
                        }
                        
                        /* üîπ NUEVOS ESTILOS PARA LAS IM√ÅGENES DECORATIVAS */
                        .decoracion-certificado {
                            position: absolute;
                            top: 0;
                            height: 100%;
                            z-index: 0;
                            pointer-events: none;
                        }
                        
                        .decoracion-izquierda {
                            left: 0;
                            width: 140px;
                        }
                        
                        .decoracion-derecha {
                            right: 0;
                            width: 140px;
                        }

                        .decoracion-abajo {
                            position: relative; 
                            bottom: 0px; 
                            margin: auto;
                            margin-top: -50px;
                            margin-bottom: -50px;
                            height: 200px;
                            width: auto; /
                            z-index: 0; 
                        }
                        
                        .certificacion-contenido {
                            position: relative;
                            z-index: 1;
                            text-align: center;
                            width: 100%;
                            max-width: 800px;
                            margin: 0 auto;
                        }
                        
                        .imagen-especialidad-certificado {
                            position: absolute;
                            top: 220px;
                            right: 20px;
                            max-width: 180px;
                            max-height: 180px;
                            z-index: 1;
                        }
                        .certificacion-header {
                            width: 100%;
                            justify-content: center;
                            margin-bottom: 40px;
                        }

                        .certificacion-titulo {
                            font-size: 18px;
                            width: 80%;
                            margin: auto;
                            margin-bottom: 10px;
                            letter-spacing: 1px;
                        }

                        .certificado-texto {
                            font-size: 50px;
                            color: #2c3e50;
                            font-weight: bold;
                            margin: auto;
                            text-transform: uppercase;
                        }
                        .otorgado-a {
                            font-size: 18px;
                            margin-bottom: 20px;
                            font-weight: bold;
                        }
                        .nombre-usuario {
                            font-family:"Great Vibes", cursive;
                            font-size:40px;
                            font-weight: bold;
                            margin: 30px 0;
                            padding: 20px;
                            border-bottom: 3px solid #2c3e50;
                            display: inline-block;
                            min-width: 400px;
                            max-width: 600px;
                            word-wrap: break-word;
                        }
                        .linea-separadora {
                            width: 400px;
                            border-top: 2px solid #2c3e50;
                            margin: 30px auto;
                        }
                        .texto-certificacion {
                            font-size: 20px;
                            line-height: 1.8;
                            margin: 40px 0;
                            max-width: 600px;
                            margin-left: auto;
                            margin-right: auto;
                        }
                        .firmas-container {
                            margin-top: 80px;
                            display: flex;
                            justify-content: space-around;
                            align-items: flex-start;
                            flex-wrap: nowrap;
                            width: 100%;
                        }
                        .firma {
                            text-align: center;
                            margin: 10px 20px;
                            min-width: 100px;
                            width: 100%;
                        }
                        .firma img {
                            max-width: 140px;
                            max-height: 80px;
                            margin-bottom: 0px;
                        }
                        .linea-firma {
                            width: 180px;
                            border-top: 1px solid #2c3e50;
                            margin: 5px auto;
                        }
                        .nombre-firma {
                            font-weight: bold;
                            font-size: 16px;
                            margin-top: 8px;
                        }
                        .cargo-firma {
                            font-size: 14px;
                            color: #666;
                            margin-top: 5px;
                        }
                        
                        /* ESTILOS GENERALES DE IMPRESI√ìN */
                        @media print {
                            body {
                                margin: 0;
                                padding: 0;
                            }
                            .examen-section {
                                margin: 15px;
                            }
                            .certificacion-page {
                                margin: 0;
                                padding: 50px;
                                border: none;
                            }
                            .no-print {
                                display: none !important;
                            }
                        }
                        
                        body {
                            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            margin: 0;
                            padding: 0;
                            color: #333;
                        }

                        /* üîπ CONFIGURACI√ìN AUTOM√ÅTICA DE IMPRESI√ìN */
                    @media print {
                        /* M√ÅRGENES EN "NINGUNO" */
                        @page {
                            margin: 0 !important;
                            padding: 0 !important;
                        }
                        
                        body {
                            margin: 0 !important;
                            padding: 0 !important;
                            -webkit-print-color-adjust: exact !important;
                            color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                        
                        /* GR√ÅFICOS DE FONDO ACTIVADOS */
                        * {
                            -webkit-print-color-adjust: exact !important;
                            color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                        
                        /* Asegurar que todas las im√°genes de fondo se impriman */
                        .decoracion-certificado,
                        .fondo-grafico,
                        .resumen-examen,
                        .certificacion-page {
                            -webkit-print-color-adjust: exact !important;
                            color-adjust: exact !important;
                            print-color-adjust: exact !important;
                        }
                    }
                    </style>
                </head>
                <body>
                    <!-- SECCI√ìN DEL EXAMEN -->
                    <div class="examen-section">
                        <div class="header-examen">
                            <h1 style="color: #2c3e50; margin-bottom: 10px; font-size: 28px;">Conquiguias World</h1>
                            <h2 style="color: #34495e; margin-bottom: 10px; font-size: 22px;">${formulario.titulo}</h2>
                            ${formulario.imagenEspecialidad ?
                `<img src="${formulario.imagenEspecialidad}" class="imagen-especialidad-examen" alt="Especialidad">`
                : ''
              }
                        </div>

                        <!-- RESUMEN DEL EXAMEN -->
                        <div class="resumen-examen">
                            <h2 style="margin: 0 0 15px 0; font-size: 24px;">üìä Resultados del Examen</h2>
                            <p style="margin: 8px 0; font-size: 18px;">
                                <strong>Resumen:</strong> ${correctas} de ${total} preguntas correctas (${porcentaje.toFixed(1)}%)
                            </p>
                            <p style="margin: 8px 0; font-size: 18px;">
                                <strong>Estado:</strong> ${aprobado ? '‚úÖ Aprobado' : '‚ùå Reprobado'}
                            </p>
                            ${aprobado ?
                '<p style="margin: 15px 0 0 0; font-size: 16px; font-weight: bold;">üéâ ¬°Felicidades! Has aprobado el examen.</p>' :
                '<p style="margin: 15px 0 0 0; font-size: 16px;">üí° Sigue estudiando para mejorar tus resultados.</p>'
              }
                        </div>

                        <div style="margin: 30px 0; border-top: 2px dashed #ccc; padding-top: 20px;">
                            <h3 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">üìù Detalle de Preguntas</h3>
            `;

            // Agregar preguntas del examen
            examen.forEach((pregunta, index) => {
              const respuestaUsuario = respuestasUsuario[pregunta.id];
              const respuestaCorrecta = pregunta.options.find(opt => opt.correct);
              const opcionUsuario = pregunta.options.find(opt => opt.id === respuestaUsuario);
              const esCorrecta = respuestaCorrecta && respuestaUsuario === respuestaCorrecta.id;

              contenidoImpresion += `
                    <div class="pregunta ${esCorrecta ? 'correcta' : 'incorrecta'}">
                        <p style="margin: 0 0 10px 0; font-weight: bold; font-size: 16px; color: #2c3e50;">
                            <strong>Pregunta ${index + 1}:</strong> ${pregunta.text}
                        </p>
                        <p style="margin: 0 0 8px 0; font-size: 14px; color: ${esCorrecta ? '#28a745' : '#dc3545'}; font-weight: bold;">
                            ${esCorrecta ? '‚úÖ Correcta' : '‚ùå Incorrecta'}
                        </p>
                        <p style="margin: 0 0 8px 0; font-size: 14px;">
                            <strong>Tu respuesta:</strong> ${opcionUsuario ? opcionUsuario.text : 'No respondida'}
                        </p>
                        ${!esCorrecta && respuestaCorrecta ?
                  `<p style="margin: 0 0 5px 0; font-size: 14px; color: #28a745;">
                                <strong>Respuesta correcta:</strong> ${respuestaCorrecta.text}
                            </p>` : ''}
                    </div>
                `;
            });

            // SECCI√ìN DEL CERTIFICADO (HOJA COMPLETA SEPARADA)
            contenidoImpresion += `
                        </div>
                    </div> <!-- Cierre de examen-section -->

                    <!-- CERTIFICADO - HOJA COMPLETA SEPARADA -->
                    <div class="certificacion-page">
                        <!-- üîπ AGREGAR LAS IM√ÅGENES DECORATIVAS -->
                        <img src="images/decoracion/izquierda.png" class="decoracion-certificado decoracion-izquierda" alt="Decoraci√≥n izquierda">
                        <img src="images/decoracion/derecha.png" class="decoracion-certificado decoracion-derecha" alt="Decoraci√≥n derecha">
                        <img src="images/decoracion/barnerLogos.png" class="decoracion-certificado decoracion-abajo" alt="Decoraci√≥n abajo">
                        
                        ${formulario.imagenEspecialidad ?
                `<img src="${formulario.imagenEspecialidad}" class="imagen-especialidad-certificado" alt="Especialidad">`
                : ''
              }
                        
                        <div class="certificacion-contenido">
                            <div class="certificacion-header">
                                <p class="certificacion-titulo">
                                    LA ACADEMIA Y PLATAFORMA ONLINE CONQUIGUIAS WORLD EXTIENDE EL SIGUIENTE
                                </p>
                                <h1 class="certificado-texto">CERTIFICADO</h1>
                            </div>

                            <div class="certificacion-cuerpo">
                                <p class="otorgado-a">OTORGADO A:</p>
                                
                                <div class="nombre-usuario">${nombreUsuario}</div>
                                
                                <!-- <div class="linea-separadora"></div> -->

                                <div class="texto-certificacion">
                                    Por haber participado en la especialidad:<br>
                                    <strong style="color: #2c3e50; font-size: 22px;">"${formulario.titulo}"</strong><br>
                                    impartido por <strong>${extraerNombreFirma(formulario.imagenFirma1) || 'el instructor'}</strong>,<br>
                                    el ${fechaFormateada}.
                                </div>
                            </div>

                            <div class="firmas-container">
                                ${formulario.imagenFirma1 ? `
                                    <div class="firma">
                                        <img src="${formulario.imagenFirma1}" alt="Firma Instructor">
                                        <div class="linea-firma"></div>
                                        <div class="nombre-firma">${extraerNombreFirma(formulario.imagenFirma1)}</div>
                                        <div class="cargo-firma"><strong>INSTRUCTOR</strong></div>
                                    </div>
                                ` : ''}
                                
                                ${formulario.imagenFirma2 ? `
                                    <div class="firma">
                                        <img src="${formulario.imagenFirma2}" alt="Firma Director">
                                        <div class="linea-firma"></div>
                                        <div class="nombre-firma">${extraerNombreFirma(formulario.imagenFirma2)}</div>
                                    </div>
                                ` : ''}
                                
                                ${formulario.imagenFirma3 ? `
                                    <div class="firma">
                                        <img src="${formulario.imagenFirma3}" alt="Firma Coordinador">
                                        <div class="linea-firma"></div>
                                        <div class="nombre-firma">${extraerNombreFirma(formulario.imagenFirma3)}</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>

                    <div class="no-print" style="text-align: center; margin: 30px; padding: 20px;">
                        <button onclick="window.print()" style="
                            padding: 12px 25px; 
                            background: #007bff; 
                            color: white; 
                            border: none; 
                            border-radius: 5px; 
                            cursor: pointer;
                            font-size: 16px;
                            margin: 0 10px;
                        ">
                            üñ®Ô∏è Imprimir Documento Completo
                        </button>
                        <button onclick="window.close()" style="
                            padding: 12px 25px; 
                            background: #6c757d; 
                            color: white; 
                            border: none; 
                            border-radius: 5px; 
                            cursor: pointer;
                            font-size: 16px;
                            margin: 0 10px;
                        ">
                            Cerrar Ventana
                        </button>
                    </div>
                </body>
                </html>
            `;

            ventanaImpresion.document.write(contenidoImpresion);
            ventanaImpresion.document.close();

            // Restaurar bot√≥n
            btnImprimir.innerHTML = textoOriginal;
            btnImprimir.disabled = false;
          })
          .catch(error => {
            console.error('Error al obtener asistencias:', error);
            // Restaurar bot√≥n en caso de error
            btnImprimir.innerHTML = textoOriginal;
            btnImprimir.disabled = false;
            mostrarMensaje("error", "Error", "No se pudo generar el PDF: " + error.message);
          });
      }///////////////////////

      // Funci√≥n auxiliar para extraer nombres de las firmas desde la URL
      function extraerNombreFirma(urlFirma) {
        if (!urlFirma) return '';
        // Extraer el nombre del archivo de la URL
        const nombreArchivo = urlFirma.split('/').pop();
        // Remover la extensi√≥n del archivo y cualquier par√°metro
        const nombre = nombreArchivo.split('.')[0];
        // Convertir a formato legible (reemplazar guiones y capitalizar)
        return nombre
          .split('-')
          .map(palabra => palabra.charAt(0).toUpperCase() + palabra.slice(1))
          .join(' ');
      }




      // Funci√≥n para actualizar la interfaz con las certificaciones
      // Funci√≥n para actualizar la interfaz con las certificaciones
      function actualizarInterfazCertificaciones(certificaciones) {
        // Ocultar loading
        certificacionesLoading.style.display = "none";

        if (certificaciones.length === 0) {
          sinCertificaciones.style.display = "block";
          certificacionesContent.style.display = "none";
          return;
        }

        // Mostrar contenido
        sinCertificaciones.style.display = "none";
        certificacionesContent.style.display = "block";

        // Agrupar certificaciones por formularioId para evitar duplicados
        const certificacionesAgrupadas = {};
        certificaciones.forEach(cert => {
          if (!certificacionesAgrupadas[cert.formularioId]) {
            certificacionesAgrupadas[cert.formularioId] = [];
          }
          certificacionesAgrupadas[cert.formularioId].push(cert);
        });

        // Tomar la mejor certificaci√≥n de cada formulario (la que tenga m√°s asistencias completadas)
        const certificacionesUnicas = [];
        Object.values(certificacionesAgrupadas).forEach(grupo => {
          // Ordenar por asistencias completadas (mayor a menor) y luego por fecha (m√°s reciente primero)
          grupo.sort((a, b) => {
            if (b.asistenciasCompletadas !== a.asistenciasCompletadas) {
              return b.asistenciasCompletadas - a.asistenciasCompletadas;
            }
            return new Date(b.fecha) - new Date(a.fecha);
          });
          // Tomar la primera (mejor) certificaci√≥n del grupo
          certificacionesUnicas.push(grupo[0]);
        });

        // Actualizar contadores
        const completadas = certificacionesUnicas.filter(c => c.estado === "Completado").length;
        totalEspecialidades.textContent = certificacionesUnicas.length;
        especialidadesCompletadas.textContent = completadas;

        // Limpiar tabla
        cuerpoTablaCertificaciones.innerHTML = "";

        // Ordenar certificaciones por fecha (m√°s reciente primero)
        certificacionesUnicas.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

        // Llenar tabla
        certificacionesUnicas.forEach((cert, index) => {
          const fila = document.createElement("tr");

          let calificacionTexto = "No realizado";
          let calificacionClase = "";

          if (cert.examenRealizado) {
            calificacionClase = cert.aprobado ? "calificacion-aprobada" : "calificacion-reprobada";
            calificacionTexto = `${cert.calificacion.toFixed(1)}%`;
          }

          fila.innerHTML = `
            <td>${index + 1}</td>
            <td>${cert.titulo}</td>
            <td>${cert.fecha.toLocaleDateString()}</td>
            <td>${cert.asistenciasCompletadas}/3</td>
            <td>${cert.examenRealizado ? "S√≠" : "No"}</td>
            <td class="${calificacionClase}">${calificacionTexto}</td>
            <td class="${cert.estadoClase}">${cert.estado}</td>
            <td>
                ${cert.examenRealizado ?
              `<button onclick="verCertificacionCompleta('${cert.formularioId}', '${cert.visitanteId}')" 
                             style="background: #17a2b8; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">
                        Ver Examen
                    </button>`
              : 'No disponible'
            }
            </td>
        `;

          cuerpoTablaCertificaciones.appendChild(fila);
        });
      }
      const tabla = document.getElementById('tablaCertificaciones');
      tabla.querySelector('thead').innerHTML = `
    <tr>
        <th>#</th>
        <th>Especialidad</th>
        <th>Fecha de Participaci√≥n</th>
        <th>Asistencias Completadas</th>
        <th>Examen Realizado</th>
        <th>Calificaci√≥n</th>
        <th>Estado</th>
        <th>Examen</th>
    </tr>
`;


















      // üîπ RED SOCIAL - Variables globales
      const uploadContainer = document.getElementById('uploadContainer');
      const fileInput = document.getElementById('fileInput');
      const postDescription = document.getElementById('postDescription');
      const previewContainer = document.getElementById('previewContainer');
      const uploadProgress = document.getElementById('uploadProgress');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const uploadBtn = document.getElementById('uploadBtn');
      const countdownTimer = document.getElementById('countdownTimer');
      const feed = document.getElementById('feed');

      let userData = null;
      let isAdmin = false;
      let lastPostTime = null;
      let countdownInterval = null;

      // üîπ RED SOCIAL - Funciones principales

      // üîπ DENTRO DE initializeSocialNetwork(), despu√©s de cargarPosts():
      async function initializeSocialNetwork() {
        agregarLogFirestore('initializeSocialNetwork');

        if (isSocialNetworkInitialized) {
          console.log('‚ö†Ô∏è Red social ya estaba inicializada');
          return;
        }

        isSocialNetworkInitialized = true;
        console.log('üöÄ Inicializando red social...');

        // (C√≥digo de verificaci√≥n de usuario y datos...)

        // Verificar Firestore
        const firestoreReady = await initializeFirestore();
        if (!firestoreReady) {
          mostrarMensaje('error', 'Error de conexi√≥n', 'No se pudo conectar con la base de datos.');
          return;
        }

        setupUploadListeners();
        checkPostCooldown();
        await loadPosts(); // Esto ahora carga solo el primer lote
        // Inicializar sistema de videos
        inicializarSistemaVideos();
        console.log('‚úÖ Red social inicializada correctamente');
      }

      // üîπ Configurar listeners para la subida - VERSI√ìN CON VERIFICACI√ìN
      function setupUploadListeners() {
        console.log('üéØ Configurando listeners...');

        if (!fileInput) {
          console.error('‚ùå fileInput no encontrado');
          return;
        }

        if (!uploadBtn) {
          console.error('‚ùå uploadBtn no encontrado');
          return;
        }

        fileInput.addEventListener('change', handleFileSelect);
        uploadBtn.addEventListener('click', handleUpload);

        console.log('‚úÖ Listeners configurados correctamente');
      }

      // üîπ Manejar selecci√≥n de archivo
      function handleFileSelect(e) {
        const file = e.target.files[0];
        previewContainer.innerHTML = '';

        if (file) {
          const reader = new FileReader();
          reader.onload = function (e) {
            if (file.type.startsWith('image/')) {
              const img = document.createElement('img');
              img.src = e.target.result;
              previewContainer.appendChild(img);
            } else if (file.type.startsWith('video/')) {
              const video = document.createElement('video');
              video.src = e.target.result;
              video.controls = true;
              video.style.maxWidth = '200px';
              previewContainer.appendChild(video);
            }
          };
          reader.readAsDataURL(file);
        }
      }

      // üîπ Verificar tiempo de espera entre publicaciones
      function checkPostCooldown() {
        if (isAdmin) {
          uploadBtn.disabled = false;
          uploadBtn.style.pointerEvents = 'auto';
          uploadBtn.style.opacity = '1';
          countdownTimer.style.display = 'none';
          return;
        }

        if (lastPostTime) {
          const now = new Date();
          const lastPost = new Date(lastPostTime);
          const diffMs = now - lastPost;
          const diffMins = Math.floor(diffMs / 60000);

          if (diffMins < 60) {
            startCountdown(60 - diffMins);
          } else {
            uploadBtn.disabled = false;
            uploadBtn.style.pointerEvents = 'auto';
            uploadBtn.style.opacity = '1';
            countdownTimer.style.display = 'none';
          }
        } else {
          uploadBtn.disabled = false;
          uploadBtn.style.pointerEvents = 'auto';
          uploadBtn.style.opacity = '1';
          countdownTimer.style.display = 'none';
        }
      }

      // üîπ Iniciar contador regresivo
      function startCountdown(minutesLeft) {
        let timeLeft = minutesLeft * 60;

        // Deshabilitar completamente el bot√≥n
        uploadBtn.disabled = true;
        uploadBtn.classList.add('upload-disabled');
        uploadBtn.style.pointerEvents = 'none'; // üîí Esto previene cualquier clic
        uploadBtn.style.opacity = '0.6';
        countdownTimer.style.display = 'inline';

        updateCountdownDisplay(timeLeft);

        countdownInterval = setInterval(() => {
          timeLeft--;

          if (timeLeft <= 0) {
            clearInterval(countdownInterval);
            // Rehabilitar el bot√≥n
            uploadBtn.disabled = false;
            uploadBtn.classList.remove('upload-disabled');
            uploadBtn.style.pointerEvents = 'auto';
            uploadBtn.style.opacity = '1';
            countdownTimer.style.display = 'none';
            return;
          }

          updateCountdownDisplay(timeLeft);
        }, 1000);
      }

      // üîπ Actualizar display del contador
      function updateCountdownDisplay(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = seconds % 60;
        countdownTimer.textContent = `Puedes publicar en: ${minutes}:${secs < 10 ? '0' : ''}${secs}`;
      }

      // üîπ Convertir archivo a base64 para enviar al backend
      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.readAsDataURL(file);
          reader.onload = () => resolve(reader.result);
          reader.onerror = error => reject(error);
        });
      }

      // üîπ Subir a Imgur a trav√©s del backend unificado - VERSI√ìN CORREGIDA
      // üîπ Subir a Imgur DIRECTAMENTE desde el frontend
      async function uploadToImgur(file) {
        try {
          console.log('üì§ Subiendo directamente a Imgur...');
          uploadProgress.style.display = 'block';

          // Primero obtener el Client-ID del servidor
          const clientIdResponse = await fetch('/api/social?action=get-client-id');
          const { clientId } = await clientIdResponse.json();

          const formData = new FormData();
          formData.append('image', file);

          const response = await fetch('https://api.imgur.com/3/upload', {
            method: 'POST',
            headers: {
              'Authorization': `Client-ID ${clientId}`,
            },
            body: formData
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.data?.error || `Imgur API error: ${response.status}`);
          }

          const data = await response.json();

          // Simular progreso
          for (let i = 0; i <= 100; i += 20) {
            setTimeout(() => {
              progressBar.style.width = i + '%';
              progressText.textContent = i + '%';
            }, i * 10);
          }

          console.log('‚úÖ Subida a Imgur completada directamente');
          return {
            url: data.data.link,
            deletehash: data.data.deletehash,
            id: data.data.id
          };

        } catch (error) {
          console.error('‚ùå Error subiendo a Imgur:', error);
          throw new Error('No se pudo subir el archivo: ' + error.message);
        } finally {
          setTimeout(() => {
            uploadProgress.style.display = 'none';
            progressBar.style.width = '0%';
            progressText.textContent = '0%';
          }, 500);
        }
      }
      // üîπ Guardar publicaci√≥n en Firestore - VERSI√ìN CORREGIDA
      // üîí GUARDAR PUBLICACI√ìN COMO PENDIENTE
      async function savePost(mediaData, description, mediaType) {
        try {
          console.log('üíæ Guardando publicaci√≥n como PENDIENTE...');

          const postData = {
            userId: currentUserId,
            userName: userData.nombre || 'Usuario',
            userPhoto: userData.fotoURL || 'https://dummyimage.com/40x40/ccc/fff&text=User',
            userEmail: userData.email || '',
            mediaUrl: mediaData.url,
            mediaType: mediaType,
            description: description.trim(),
            timestamp: new Date().toISOString(),
            imgurData: {
              id: mediaData.id,
              deletehash: mediaData.deletehash
            },
            status: 'pending',
            moderatedBy: null,
            moderatedAt: null,
            moderationReason: null,
            reactions: {
              like: [], love: [], laugh: [], wow: [], sad: [], angry: [], seven: []
            },
            comments: []
          };

          console.log('üìù Datos de la publicaci√≥n (PENDIENTE):', postData);

          const docRef = await addDoc(collection(db, "posts"), postData);
          console.log('‚úÖ Publicaci√≥n guardada como PENDIENTE con ID:', docRef.id);

          return docRef.id;
        } catch (error) {
          console.error('‚ùå Error guardando publicaci√≥n:', error);
          throw new Error('No se pudo guardar la publicaci√≥n: ' + error.message);
        }
      }

      // üîπ Manejar subida de publicaci√≥n - VERSI√ìN FINAL CON FALLBACK
      async function handleUpload() {
        console.log('üîÑ handleUpload iniciado');

        // üîí VALIDACI√ìN CR√çTICA: Verificar si el bot√≥n est√° deshabilitado
        if (uploadBtn.disabled) {
          console.log('‚ùå Bot√≥n deshabilitado, publicaci√≥n bloqueada');
          return;
        }

        const file = fileInput.files[0];
        const description = postDescription.value.trim();

        console.log('üìÅ Archivo:', file);
        console.log('üìù Descripci√≥n:', description);

        if (!file) {
          console.log('‚ùå No hay archivo');
          mostrarMensaje('info', 'Selecciona una imagen o video', 'Debes seleccionar un archivo para publicar.');
          return;
        }

        if (!description) {
          console.log('‚ùå No hay descripci√≥n');
          mostrarMensaje('info', 'Agrega una descripci√≥n', 'Escribe una descripci√≥n para tu publicaci√≥n.');
          return;
        }

        // Validaciones de archivo seg√∫n tipo y tama√±o
        const fileType = file.type;

        // L√≠mite para im√°genes ‚Üí 20MB
        const IMAGE_MAX = 20 * 1024 * 1024; // 20MB
        // L√≠mite para videos / GIF ‚Üí 200MB
        const VIDEO_MAX = 200 * 1024 * 1024; // 200MB

        if (fileType.startsWith("image/")) {
          // Es imagen
          if (file.size > IMAGE_MAX) {
            mostrarMensaje(
              'error',
              'Imagen muy grande',
              'Las im√°genes no deben superar los 20MB.'
            );
            return;
          }
        } else if (fileType.startsWith("video/") || fileType === "image/gif") {
          // Es video o GIF
          if (file.size > VIDEO_MAX) {
            mostrarMensaje(
              'error',
              'Video demasiado grande',
              'Los videos y GIF no deben superar los 200MB.'
            );
            return;
          }
        }


        const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'video/mp4', 'video/quicktime'];
        if (!validTypes.includes(file.type)) {
          mostrarMensaje('error', 'Tipo de archivo no v√°lido', 'Solo se permiten im√°genes (JPEG, PNG, GIF) y videos (MP4).');
          return;
        }

        try {
          uploadBtn.disabled = true;
          uploadBtn.textContent = 'Subiendo...';

          // 1. Subir a Imgur
          console.log('üì§ Subiendo a Imgur...');
          const mediaData = await uploadToImgur(file);

          // 2. Preparar datos de la publicaci√≥n
          const postData = {
            userId: currentUserId,
            userName: `${userData.nombre || ''} ${userData.apellido || ''}`.trim() || 'Usuario',
            userNombre: userData.nombre || '',
            userApellido: userData.apellido || '',
            userPhoto: userData.fotoURL || 'https://dummyimage.com/40x40/ccc/fff&text=User',
            userEmail: userData.email || '',
            mediaUrl: mediaData.url,
            mediaType: file.type,
            description: description,
            timestamp: new Date().toISOString(),
            imgurData: mediaData,
            reactions: { like: [], love: [], laugh: [], wow: [], sad: [], angry: [], seven: [] },
            comments: [],
            status: isAdmin ? 'approved' : 'pending' // ‚úÖ Cambio importante aqu√≠
          };

          let postId;

          // 3. Intentar guardar en Firestore primero
          try {
            console.log('üíæ Intentando guardar en Firestore...');
            const docRef = await addDoc(collection(db, "posts"), postData);
            postId = docRef.id;
            console.log('‚úÖ Guardado en Firestore, ID:', postId);
          } catch (firestoreError) {
            console.warn('‚ö†Ô∏è Fall√≥ Firestore, usando localStorage:', firestoreError);

            // Fallback a localStorage
            const saved = savePostToLocalStorage(postData);
            if (saved) {
              postId = 'local_' + Date.now();
              console.log('‚úÖ Guardado en localStorage');
              mostrarMensaje('info', 'Publicaci√≥n guardada localmente', 'La publicaci√≥n se guard√≥ localmente debido a problemas de conexi√≥n.');
            } else {
              throw new Error('No se pudo guardar la publicaci√≥n en ning√∫n almacenamiento');
            }
          }

          // 4. Actualizar tiempo de publicaci√≥n
          if (!isAdmin) {
            try {
              await updateDoc(doc(db, "usuarios", currentUserId), {
                lastPostTime: new Date().toISOString()
              });
              lastPostTime = new Date().toISOString();
              startCountdown(60);
            } catch (error) {
              console.warn('‚ö†Ô∏è No se pudo actualizar lastPostTime:', error);
            }
          }

          // 5. Limpiar y recargar
          fileInput.value = '';
          postDescription.value = '';
          previewContainer.innerHTML = '';

          // Solo deshabilitar si NO es admin
          if (!isAdmin) {
            uploadBtn.disabled = true;
            uploadBtn.style.pointerEvents = 'none';
            uploadBtn.style.opacity = '0.6';
            uploadBtn.textContent = 'Publicar';
            startCountdown(60); // Iniciar el contador de 60 minutos
          } else {
            // Admin puede publicar inmediatamente
            uploadBtn.disabled = false;
            uploadBtn.style.pointerEvents = 'auto';
            uploadBtn.style.opacity = '1';
            uploadBtn.textContent = 'Publicar';
          }

          await loadPosts();
          // En handleUpload, despu√©s de guardar la publicaci√≥n exitosamente
          mostrarMensaje('info', 'üì§ Publicaci√≥n enviada',
            'Tu publicaci√≥n ha sido enviada para revisi√≥n. Ser√° visible para todos una vez que sea aprobada por un administrador.\n\n' +
            'Tiempo estimado de revisi√≥n: 24 horas.'
          );

          setTimeout(() => {
            initializeScrollSnapOnce();
        }, 500);

        } catch (error) {
          console.error('‚ùå Error al publicar:', error);
          mostrarMensaje('error', 'Error al publicar', error.message || 'No se pudo completar la publicaci√≥n.');
          uploadBtn.disabled = false;
          uploadBtn.textContent = 'Publicar';
        }
      }

      // üîπ VARIABLES PARA SCROLL INFINITO
      let lastVisiblePost = null; // √öltimo documento visible para paginaci√≥n
      let hasMorePosts = true; // Si hay m√°s publicaciones por cargar
      let isLoadingMore = false; // Para evitar m√∫ltiples cargas simult√°neas
      let postsPerLoad = 10; // N√∫mero de publicaciones a cargar por vez
      let observer = null; // Observer para el scroll infinito

      // üîπ INICIALIZAR SCROLL INFINITO
      function initializeInfiniteScroll() {
        const sentinel = document.getElementById('scrollSentinel');
        const loadingIndicator = document.getElementById('loadingPosts');
        const noMoreIndicator = document.getElementById('noMorePosts');

        // Configurar Intersection Observer para detectar cuando el centinela es visible
        observer = new IntersectionObserver(async (entries) => {
          const entry = entries[0];

          if (entry.isIntersecting && hasMorePosts && !isLoadingMore) {
            console.log('üîÑ Cargando m√°s publicaciones...');
            isLoadingMore = true;
            loadingIndicator.classList.remove('hidden');

            try {
              await loadMorePosts();
            } catch (error) {
              console.error('‚ùå Error cargando m√°s publicaciones:', error);
            } finally {
              isLoadingMore = false;
              loadingIndicator.classList.add('hidden');
            }
          }

          // Mostrar indicador de fin de publicaciones
          if (!hasMorePosts && !noMoreIndicator.classList.contains('hidden')) {
            noMoreIndicator.classList.remove('hidden');
          }
        }, {
          rootMargin: '1000px', // Cargar cuando el centinela est√© a 100px de ser visible
          threshold: 0.1
        });

        if (sentinel) {
          observer.observe(sentinel);
        }
      }

      // üîπ CARGAR M√ÅS PUBLICACIONES (Paginaci√≥n)
      async function loadMorePosts() {
        if (!hasMorePosts) return;

        try {
          console.log('üì• Cargando m√°s publicaciones...');

          // üî• GUARDAR LA POSICI√ìN ACTUAL ANTES DE CARGAR
        const mainContent = document.getElementById('mainContent');
        const currentScroll = mainContent.scrollTop;
        const currentPostBeforeLoad = currentSnappedPost;

          let q;
          if (lastVisiblePost) {
            // Cargar despu√©s del √∫ltimo post visible
            q = query(
              collection(db, "posts"),
              where("status", "==", "approved"),
              orderBy("timestamp", "desc"),
              startAfter(lastVisiblePost),
              limit(postsPerLoad)
            );
          } else {
            // Primera carga (esto no deber√≠a pasar, pero por si acaso)
            q = query(
              collection(db, "posts"),
              where("status", "==", "approved"),
              orderBy("timestamp", "desc"),
              limit(postsPerLoad)
            );
          }

          const querySnapshot = await getDocs(q);

          if (querySnapshot.empty) {
            console.log('üì≠ No hay m√°s publicaciones');
            hasMorePosts = false;
            return;
          }

          console.log(`üìä Se cargaron ${querySnapshot.size} publicaciones m√°s`);

          // Actualizar el √∫ltimo documento visible
          lastVisiblePost = querySnapshot.docs[querySnapshot.docs.length - 1];

          isProgrammaticScroll = true;
          // Mostrar las nuevas publicaciones
          querySnapshot.forEach((doc) => {
            const post = { ...doc.data(), id: doc.id };
            displayPost(post, doc.id);
          });

          setTimeout(() => {
            inicializarSistemaVideos();
          }, 100);

          // üî• RESTAURAR POSICI√ìN Y ACTUALIZAR SNAPPING
        setTimeout(() => {
            // Restaurar scroll position
            mainContent.scrollTop = currentScroll;
            
            // Re-activar snapping SIN centrar autom√°ticamente
            setupScrollSnapSystem();
            // Quitar flag despu√©s de un tiempo
            setTimeout(() => {
                isProgrammaticScroll = false;
            }, 500);
            
        }, 200);

          // Si cargamos menos de postsPerLoad, no hay m√°s publicaciones
          if (querySnapshot.size < postsPerLoad) {
            hasMorePosts = false;
          }

        } catch (error) {
          console.error('‚ùå Error cargando m√°s publicaciones:', error);
          throw error;
        }
      }

      // üîπ CARGA INICIAL DE PUBLICACIONES (Modificada para scroll infinito)
      async function loadPosts() {
        agregarLogFirestore('loadPosts');

        // üîí Protecci√≥n contra llamadas simult√°neas
        if (postsLoading) {
          console.log('‚è≥ LoadPosts ya en ejecuci√≥n, ignorando...');
          return;
        }

        // üîí Protecci√≥n contra llamadas muy frecuentes (m√≠nimo 30 segundos)
        const now = Date.now();
        if (lastLoadTime && (now - lastLoadTime < 30000)) {
          console.log('‚è∞ LoadPosts llamado muy pronto, ignorando...');
          return;
        }

        postsLoading = true;
        lastLoadTime = now;

        try {
          console.log('üì• Cargando publicaciones aprobadas...');
          console.log('üîç Firestore Read - loadPosts iniciado');

          // Reiniciar variables de paginaci√≥n
          lastVisiblePost = null;
          hasMorePosts = true;

          const q = query(
            collection(db, "posts"),
            where("status", "==", "approved"),
            orderBy("timestamp", "desc"),
            limit(postsPerLoad) // üî• Cargar solo el primer lote
          );

          const querySnapshot = await getDocs(q);
          console.log(`üìä Se encontraron ${querySnapshot.size} publicaciones aprobadas`);

          // Limpiar feed solo en carga inicial
          feed.innerHTML = '';

          if (querySnapshot.empty) {
            feed.innerHTML = `
            <div class="empty-feed">
              <h3>üì∑ No hay publicaciones a√∫n</h3>
              <p>¬°S√© el primero en compartir algo!</p>
            </div>
          `;
            hasMorePosts = false;
            return;
          }

          // Actualizar el √∫ltimo documento visible
          lastVisiblePost = querySnapshot.docs[querySnapshot.docs.length - 1];

          // Mostrar las publicaciones
          querySnapshot.forEach((doc) => {
            const post = { ...doc.data(), id: doc.id };
            displayPost(post, doc.id);
          });

          setTimeout(() => {
            inicializarSistemaVideos();
          }, 100);

          // Si cargamos menos de postsPerLoad, no hay m√°s publicaciones
          if (querySnapshot.size < postsPerLoad) {
            hasMorePosts = false;
          }

          // üîπ INICIALIZAR SCROLL INFINITO DESPU√âS DE LA PRIMERA CARGA
          setTimeout(() => {
            initializeInfiniteScroll();
          }, 500);

          setTimeout(() => {
            initializeScrollSnapOnce();
        }, 500);

        } catch (error) {
          console.error('‚ùå Error cargando publicaciones:', error);

          // Fallback: intentar cargar sin filtro
          try {
            console.log('üîÑ Intentando carga sin filtro...');
            const q = query(
              collection(db, "posts"),
              orderBy("timestamp", "desc"),
              limit(postsPerLoad)
            );
            const querySnapshot = await getDocs(q);

            feed.innerHTML = '';

            if (querySnapshot.empty) {
              feed.innerHTML = `
              <div class="empty-feed">
                <h3>üì∑ No hay publicaciones a√∫n</h3>
                <p>¬°S√© el primero en compartir algo!</p>
              </div>
            `;
              hasMorePosts = false;
              return;
            }

            // Filtrar manualmente las aprobadas
            let approvedCount = 0;
            querySnapshot.forEach((doc) => {
              const post = doc.data();
              if (post.status === 'approved') {
                displayPost({ ...post, id: doc.id }, doc.id);
                approvedCount++;
                lastVisiblePost = doc;
              }
            });

            if (approvedCount < postsPerLoad) {
              hasMorePosts = false;
            }

            // Inicializar scroll infinito despu√©s del fallback
            setTimeout(() => {
              initializeInfiniteScroll();
            }, 500);

          } catch (fallbackError) {
            console.error('‚ùå Error en fallback:', fallbackError);
            feed.innerHTML = `
            <div class="empty-feed">
              <h3>‚ùå Error al cargar publicaciones</h3>
              <p>${fallbackError.message || 'Intenta recargar la p√°gina'}</p>
              <button onclick="loadPosts()" style="margin-top: 10px; padding: 8px 16px; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer;">
                Reintentar
              </button>
            </div>
          `;
          } finally {
            postsLoading = false;
          }
        }
      }

      function agregarLogFirestore(funcion) {
        console.log(`üîç Firestore Read - ${funcion}`, {
          timestamp: new Date().toISOString(),
          user: currentUserId
        });
      }

      // üîπ Mostrar publicaci√≥n en el feed - VERSI√ìN MEJORADA
      // üîπ Mostrar publicaci√≥n en el feed - VERSI√ìN CON REACCIONES EXCLUSIVAS
      function displayPost(post, postId) {
        const postElement = document.createElement('div');
        postElement.className = 'post-card';

        const timeAgo = getTimeAgo(new Date(post.timestamp));
        const isPostOwner = post.userId === currentUserId;
        const isLocalPost = post.source === 'local';

        // Preparar reacciones (con valores por defecto si no existen)
        const reactions = post.reactions || {
          like: [], love: [], laugh: [], wow: [], sad: [], angry: [], seven: []
        };

        // Determinar si el usuario actual est√° en cada reacci√≥n
        const userReactions = {
          like: reactions.like?.includes(currentUserId) || false,
          love: reactions.love?.includes(currentUserId) || false,
          laugh: reactions.laugh?.includes(currentUserId) || false,
          wow: reactions.wow?.includes(currentUserId) || false,
          sad: reactions.sad?.includes(currentUserId) || false,
          angry: reactions.angry?.includes(currentUserId) || false,
          seven: reactions.seven?.includes(currentUserId) || false
        };

        // üî• NUEVO: Obtener nombre completo del post
        // Si el post tiene nombre y apellido separados, los combinamos
        let nombreCompleto = post.userName; // Valor por defecto

        // Si tenemos datos separados, crear nombre completo
        if (post.userNombre && post.userApellido) {
          nombreCompleto = `${post.userNombre} ${post.userApellido}`;
        }
        // Si el userName ya contiene nombre y apellido (separados por espacio)
        else if (post.userName && post.userName.includes(' ')) {
          nombreCompleto = post.userName;
        }
        // Si solo tenemos userName, usarlo tal cual
        else {
          nombreCompleto = post.userName || 'Usuario';
        }

        // Encontrar qu√© reacci√≥n tiene activa el usuario actual (solo deber√≠a haber una)
        const userActiveReaction = Object.keys(userReactions).find(
          reaction => userReactions[reaction]
        );

        postElement.innerHTML = `
    <div class="post-header">
      <img src="${post.userPhoto}" alt="Foto de perfil" class="post-user-img" onerror="this.src='https://dummyimage.com/40x40/ccc/fff'">
      <div>
        <div class="post-contenedor">
          <div class="post-user-name">${nombreCompleto}</div>
          ${ADMIN_EMAILS.includes(post.userEmail) ? '<span class="status-admin post-status-indicator">Admin</span>' : ''}
        </div>
        <div class="post-time">
          ${timeAgo}
          ${isLocalPost ? ' (Guardado localmente)' : ''}
        </div>
      </div>
      ${(isAdmin || isPostOwner) ? `
        <button class="delete-post-btn" data-postid="${postId}" data-deletehash="${post.imgurData?.deletehash}">
          üóëÔ∏è Eliminar
        </button>
      ` : ''}
    </div>
    
    <div class="post-content">
      ${post.mediaType.startsWith('image/')
            ? `<img src="${post.mediaUrl}" alt="Publicaci√≥n" loading="lazy" onerror="this.style.display='none'">`
            : post.mediaType.startsWith('video/')
              ? `<video src="${post.mediaUrl}" playsinline loop controls style="max-width: 100%; border-radius: 8px;"></video>`
              : `<div style="padding: 20px; text-align: center; color: #666;">Tipo de archivo no compatible</div>`
          }
    </div>
    

    <div class="post-description">
      ${post.description || ''}
    </div>
    
    <div class="post-actions">
      <button class="reaction-btn ${userReactions.like ? 'active' : ''}" 
              data-reaction="like" 
              data-postid="${postId}">
        ‚ù§Ô∏è <span class="reaction-count">${reactions.like?.length || 0}</span>
      </button>
      
      <button class="reaction-btn ${userReactions.love ? 'active' : ''}" 
              data-reaction="love" 
              data-postid="${postId}">
        üòç <span class="reaction-count">${reactions.love?.length || 0}</span>
      </button>
      
      <button class="reaction-btn ${userReactions.laugh ? 'active' : ''}" 
              data-reaction="laugh" 
              data-postid="${postId}">
        üòÇ <span class="reaction-count">${reactions.laugh?.length || 0}</span>
      </button>
      
      <button class="reaction-btn ${userReactions.wow ? 'active' : ''}" 
              data-reaction="wow" 
              data-postid="${postId}">
        ü§£ <span class="reaction-count">${reactions.wow?.length || 0}</span>
      </button>
      
      <button class="reaction-btn ${userReactions.sad ? 'active' : ''}" 
              data-reaction="sad" 
              data-postid="${postId}">
        üò≤ <span class="reaction-count">${reactions.sad?.length || 0}</span>
      </button>
      
      <button class="reaction-btn ${userReactions.angry ? 'active' : ''}" 
              data-reaction="angry" 
              data-postid="${postId}">
        üò† <span class="reaction-count">${reactions.angry?.length || 0}</span>
      </button>
      
      <button class="reaction-btn ${userReactions.seven ? 'active' : ''}" 
              data-reaction="seven" 
              data-postid="${postId}">
        7Ô∏è‚É£ <span class="reaction-count">${reactions.seven?.length || 0}</span>
      </button>
    </div>

    ${post.comments && post.comments.length > 0 ? `
      <div class="post-comments" style="padding: 10px 15px; border-top: 1px solid #f0f0f0;">
        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Comentarios:</div>
        ${post.comments.slice(0, 2).map(comment => `
          <div style="margin-bottom: 5px; font-size: 13px;">
            <strong>${comment.userName}:</strong> ${comment.text}
          </div>
        `).join('')}
        ${post.comments.length > 2 ? `
          <div style="font-size: 12px; color: #1976d2; cursor: pointer;">
            Ver ${post.comments.length - 2} comentarios m√°s...
          </div>
        ` : ''}
      </div>
    ` : ''}
  `;

        feed.appendChild(postElement);
      }

      // üîπ Calcular tiempo transcurrido (formato humano)
      function getTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / 60000);
        const diffHours = Math.floor(diffMs / 3600000);
        const diffDays = Math.floor(diffMs / 86400000);
        const diffWeeks = Math.floor(diffDays / 7);
        const diffMonths = Math.floor(diffDays / 30);

        if (diffMins < 1) return 'Ahora mismo';
        if (diffMins < 60) return `Hace ${diffMins} minuto${diffMins > 1 ? 's' : ''}`;
        if (diffHours < 24) return `Hace ${diffHours} hora${diffHours > 1 ? 's' : ''}`;
        if (diffDays < 7) return `Hace ${diffDays} d√≠a${diffDays > 1 ? 's' : ''}`;
        if (diffWeeks < 4) return `Hace ${diffWeeks} semana${diffWeeks > 1 ? 's' : ''}`;
        if (diffMonths < 12) return `Hace ${diffMonths} mes${diffMonths > 1 ? 'es' : ''}`;

        return date.toLocaleDateString('es-ES', {
          day: 'numeric',
          month: 'long',
          year: 'numeric'
        });
      }

      // üîπ Manejar reacciones
      feed.addEventListener('click', async (e) => {
        if (e.target.classList.contains('reaction-btn') || e.target.closest('.reaction-btn')) {
          const btn = e.target.classList.contains('reaction-btn') ? e.target : e.target.closest('.reaction-btn');
          const reaction = btn.getAttribute('data-reaction');
          const postId = btn.getAttribute('data-postid');

          await addReaction(postId, reaction);
        }

        // Manejar eliminaci√≥n de posts
        // En el evento click del feed, REEMPLAZA esta parte:
        if (e.target.classList.contains('delete-post-btn') || e.target.closest('.delete-post-btn')) {
          const btn = e.target.classList.contains('delete-post-btn') ? e.target : e.target.closest('.delete-post-btn');
          const postId = btn.getAttribute('data-postid');
          const deletehash = btn.getAttribute('data-deletehash');

          mostrarMensaje('confirm',
            'Eliminar publicaci√≥n',
            '¬øEst√°s seguro de que quieres eliminar esta publicaci√≥n? Esta acci√≥n no se puede deshacer.',
            async () => {
              try {
                await deletePost(postId, deletehash);

                // Eliminar del DOM
                const postElement = btn.closest('.post-card');
                if (postElement) {
                  postElement.style.opacity = '0.5';
                  setTimeout(() => {
                    postElement.remove();
                    // Verificar si el feed qued√≥ vac√≠o
                    if (feed.children.length === 0) {
                      feed.innerHTML = `
                                <div class="empty-feed">
                                    <h3>üì∑ No hay publicaciones a√∫n</h3>
                                    <p>¬°S√© el primero en compartir algo!</p>
                                </div>
                            `;
                    }
                  }, 300);
                }

                mostrarMensaje('success', '‚úÖ Publicaci√≥n eliminada', 'La publicaci√≥n ha sido eliminada correctamente.');

              } catch (error) {
                console.error('Error al eliminar:', error);
                mostrarMensaje('error', 'Error al eliminar', 'No se pudo eliminar la publicaci√≥n: ' + error.message);
              }
            }
          );
        }
      });

      // üîπ Agregar reacci√≥n EXCLUSIVA - solo una por usuario
      async function addReaction(postId, newReaction) {
        try {
          // Validar que el usuario est√© autenticado
          if (!currentUserId) {
            console.error('‚ùå Usuario no autenticado');
            mostrarMensaje('info', 'Inicia sesi√≥n', 'Debes iniciar sesi√≥n para reaccionar.');
            return;
          }

          console.log(`üéØ Usuario ${currentUserId} quiere reaccionar con ${newReaction} al post ${postId}`);

          const postRef = doc(db, "posts", postId);
          const postDoc = await getDoc(postRef);

          if (!postDoc.exists()) {
            console.error('‚ùå El post no existe');
            return;
          }

          const postData = postDoc.data();

          // Inicializar reactions si no existen
          if (!postData.reactions) {
            postData.reactions = {
              like: [], love: [], laugh: [], wow: [], sad: [], angry: [], seven: []
            };
          }

          // üî• NUEVA L√ìGICA: Reacciones exclusivas
          const updatedReactions = { ...postData.reactions };
          const allReactionTypes = ['like', 'love', 'laugh', 'wow', 'sad', 'angry', 'seven'];

          // 1. Verificar si el usuario ya ten√≠a esta misma reacci√≥n
          const currentReactionIndex = updatedReactions[newReaction]?.indexOf(currentUserId);
          const hadThisReaction = currentReactionIndex > -1;

          if (hadThisReaction) {
            // üîÑ Caso 1: Ya ten√≠a esta reacci√≥n ‚Üí REMOVERLA (toggle off)
            console.log(`‚ûñ Usuario ya ten√≠a ${newReaction}, removiendo...`);
            updatedReactions[newReaction].splice(currentReactionIndex, 1);
          } else {
            // üîÑ Caso 2: Nueva reacci√≥n ‚Üí REMOVER de todas y AGREGAR a la nueva
            console.log(`üîÑ Usuario cambia a ${newReaction}`);

            // Remover al usuario de TODAS las reacciones primero
            allReactionTypes.forEach(reactionType => {
              if (updatedReactions[reactionType]) {
                const userIndex = updatedReactions[reactionType].indexOf(currentUserId);
                if (userIndex > -1) {
                  updatedReactions[reactionType].splice(userIndex, 1);
                  console.log(`‚ûñ Removido de ${reactionType}`);
                }
              }
            });

            // Agregar a la nueva reacci√≥n
            if (!updatedReactions[newReaction]) {
              updatedReactions[newReaction] = [];
            }
            updatedReactions[newReaction].push(currentUserId);
            console.log(`‚ûï Agregado a ${newReaction}`);
          }

          console.log('üìù Reacciones actualizadas:', updatedReactions);

          // Actualizar en Firestore
          await updateDoc(postRef, {
            reactions: updatedReactions
          });

          console.log('‚úÖ Reacci√≥n actualizada exitosamente');

          // Actualizar visualmente TODOS los botones de este post
          updateReactionButtons(postId, updatedReactions);

        } catch (error) {
          console.error('‚ùå Error agregando reacci√≥n:', error);
          mostrarMensaje('error', 'Error al reaccionar', 'No se pudo agregar la reacci√≥n. Intenta nuevamente.');
        }
      }

      // üîπ Funci√≥n para actualizar visualmente los botones de reacci√≥n
      function updateReactionButtons(postId, reactions) {
        const reactionButtons = document.querySelectorAll(`[data-postid="${postId}"].reaction-btn`);

        reactionButtons.forEach(button => {
          const reactionType = button.getAttribute('data-reaction');
          const count = reactions[reactionType]?.length || 0;
          const countElement = button.querySelector('.reaction-count');

          // Actualizar contador
          if (countElement) {
            countElement.textContent = count;
          }

          // Actualizar estado activo
          const isUserInThisReaction = reactions[reactionType]?.includes(currentUserId);
          if (isUserInThisReaction) {
            button.classList.add('active');
          } else {
            button.classList.remove('active');
          }
        });
      }


      // üîπ Eliminar publicaci√≥n (para admin o due√±o del post)
      // üîπ Eliminar publicaci√≥n (versi√≥n corregida)
      async function deletePost(postId, imgurDeletehash) {
        try {
          console.log(`üóëÔ∏è Eliminando publicaci√≥n: ${postId}`);

          // 1. Eliminar de Imgur si existe deletehash
          if (imgurDeletehash && imgurDeletehash !== 'undefined') {
            try {
              const deleteResponse = await fetch(`/api/social?action=delete`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ deletehash: imgurDeletehash })
              });

              if (deleteResponse.ok) {
                console.log('‚úÖ Imagen eliminada de Imgur');
              } else {
                console.warn('‚ö†Ô∏è No se pudo eliminar de Imgur, continuando...');
              }
            } catch (imgurError) {
              console.warn('‚ö†Ô∏è Error eliminando de Imgur:', imgurError);
            }
          }

          // 2. Eliminar de Firestore
          await deleteDoc(doc(db, "posts", postId));
          console.log('‚úÖ Publicaci√≥n eliminada de Firestore');

          return true;

        } catch (error) {
          console.error('‚ùå Error eliminando publicaci√≥n:', error);
          throw new Error('No se pudo eliminar la publicaci√≥n: ' + error.message);
        }
      }

      // üîπ Funci√≥n auxiliar para verificar que el API est√° funcionando
      async function checkSocialAPI() {
        try {
          const response = await fetch('/api/social?action=health');
          const data = await response.json();
          console.log('Social API status:', data);
          return data.status === 'OK';
        } catch (error) {
          console.error('Social API no responde:', error);
          return false;
        }
      }

      // üîπ VERIFICACI√ìN INICIAL DEL ESTADO
      console.log('üîç Estado inicial de la red social:');
      console.log('- currentUserId:', currentUserId);
      console.log('- userData:', userData);
      console.log('- isAdmin:', isAdmin);
      console.log('- inicioSection visible:', !inicioSection.classList.contains('hidden'));



      // üîπ Funci√≥n para verificar y configurar Firestore - VERSI√ìN CORREGIDA
      async function initializeFirestore() {
        try {
          console.log('üî• Inicializando Firestore...');

          // Verificar que podemos acceder a Firestore
          const testQuery = query(collection(db, "posts"), limit(1));
          const testSnapshot = await getDocs(testQuery);
          console.log('‚úÖ Firestore accesible');

          return true;
        } catch (error) {
          console.error('‚ùå Error accediendo a Firestore:', error);
          return false;
        }
      }

      // üîπ Probar permisos de Firestore - VERSI√ìN CORREGIDA
      async function testFirestorePermissions() {
        try {
          console.log('üîê Probando permisos de Firestore...');

          // Intentar escribir un documento de prueba
          const testCollectionRef = collection(db, "test_permissions");
          const testDocRef = doc(testCollectionRef);
          await setDoc(testDocRef, {
            test: true,
            timestamp: new Date().toISOString(),
            userId: currentUserId
          });

          // Intentar leerlo
          const testDoc = await getDoc(testDocRef);
          console.log('‚úÖ Permisos de escritura/lectura OK');

          // Limpiar el documento de prueba
          await deleteDoc(testDocRef);

          return true;
        } catch (error) {
          console.error('‚ùå Error en permisos:', error);
          return false;
        }
      }

      // üîπ Funci√≥n de fallback para guardar en localStorage
      function savePostToLocalStorage(postData) {
        try {
          const savedPosts = JSON.parse(localStorage.getItem('localPosts') || '[]');
          savedPosts.push({
            ...postData,
            id: 'local_' + Date.now(),
            local: true
          });
          localStorage.setItem('localPosts', JSON.stringify(savedPosts));
          return true;
        } catch (error) {
          console.error('Error guardando en localStorage:', error);
          return false;
        }
      }



      // üîß FUNCIONES DEL PANEL DE ADMINISTRACI√ìN

      // Mostrar/ocultar secci√≥n Admin
      function setupAdminSection() {
        const menuAdmin = document.getElementById('menuAdmin');
        const adminSection = document.getElementById('adminSection');

        if (isAdmin) {
          menuAdmin.classList.remove('hidden');

          menuAdmin.addEventListener('click', () => {
            mostrarSeccion(adminSection, menuAdmin);
            loadPendingPosts();
          });
        }
      }

      // Cargar publicaciones pendientes
      async function loadPendingPosts() {
        try {
          const adminLoading = document.getElementById('adminLoading');
          const adminPostsContainer = document.getElementById('adminPostsContainer');
          const noPendingPosts = document.getElementById('noPendingPosts');

          adminLoading.style.display = 'block';
          adminPostsContainer.innerHTML = '';
          noPendingPosts.style.display = 'none';

          console.log('üîß Cargando publicaciones pendientes...');

          // Consulta SOLO publicaciones pendientes
          const q = query(
            collection(db, "posts"),
            where("status", "==", "pending"),
            orderBy("timestamp", "asc")
          );

          const querySnapshot = await getDocs(q);
          adminLoading.style.display = 'none';

          if (querySnapshot.empty) {
            noPendingPosts.style.display = 'block';
            updateAdminStats();
            return;
          }

          console.log(`üîß Publicaciones pendientes: ${querySnapshot.size}`);

          querySnapshot.forEach((doc) => {
            const post = { ...doc.data(), id: doc.id };
            displayPendingPost(post, doc.id);
          });

          updateAdminStats();

        } catch (error) {
          console.error('‚ùå Error cargando publicaciones pendientes:', error);

          // Fallback: cargar todas y filtrar manualmente
          try {
            console.log('üîÑ Intentando carga manual de pendientes...');
            const q = query(collection(db, "posts"), orderBy("timestamp", "asc"));
            const querySnapshot = await getDocs(q);

            document.getElementById('adminLoading').style.display = 'none';
            const pendingPosts = [];

            querySnapshot.forEach((doc) => {
              const post = doc.data();
              if (post.status === 'pending') {
                pendingPosts.push({ ...post, id: doc.id });
              }
            });

            if (pendingPosts.length === 0) {
              document.getElementById('noPendingPosts').style.display = 'block';
              updateAdminStats();
              return;
            }

            pendingPosts.forEach((post) => {
              displayPendingPost(post, post.id);
            });

            updateAdminStats();

          } catch (fallbackError) {
            console.error('‚ùå Error en fallback de admin:', fallbackError);
            document.getElementById('adminLoading').style.display = 'none';
            mostrarMensaje('error', 'Error', 'No se pudieron cargar las publicaciones pendientes.');
          }
        }
      }

      // Mostrar publicaci√≥n pendiente en el panel admin
      function displayPendingPost(post, postId) {
        const postElement = document.createElement('div');
        postElement.className = 'post-card';
        postElement.style.marginBottom = '20px';
        postElement.style.border = '2px solid #ff9800';

        const timeAgo = getTimeAgo(new Date(post.timestamp));

        postElement.innerHTML = `
    <div class="post-header">
      <img src="${post.userPhoto}" alt="Foto de perfil" class="post-user-img" onerror="this.src='https://dummyimage.com/40x40/ccc/fff'">
      <div style="flex: 1;">
        <div class="post-user-name">${post.userName}</div>
        <div class="post-time">${timeAgo}</div>
        <div style="font-size: 12px; color: #ff9800; margin-top: 5px;">
          ‚è≥ Esperando aprobaci√≥n
        </div>
      </div>
    </div>
    
    <div class="post-content">
      ${post.mediaType.startsWith('image/')
            ? `<img src="${post.mediaUrl}" alt="Publicaci√≥n pendiente" loading="lazy" style="max-width: 100%; border-radius: 8px;">`
            : `<video src="${post.mediaUrl}" controls style="max-width: 100%; border-radius: 8px;"></video>`
          }
    </div>
    
    <div class="post-description">
      ${post.description}
    </div>
    
    <div style="padding: 15px;border-radius: 8px; margin: 10px 0;">
      <h4 style="margin-bottom: 10px;">üîß Acciones de Moderaci√≥n</h4>
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button class="approve-btn" data-postid="${postId}" data-deletehash="${post.imgurData?.deletehash}" 
                style="background: #4caf50; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
          ‚úÖ Aprobar
        </button>
        <button class="reject-btn" data-postid="${postId}" data-deletehash="${post.imgurData?.deletehash}" 
                style="background: #f44336; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
          ‚ùå Rechazar
        </button>
        <button class="view-user-btn" data-userid="${post.userId}" 
                style="background: #2196f3; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px;">
          üë§ Ver Usuario
        </button>
      </div>
    </div>
  `;

        document.getElementById('adminPostsContainer').appendChild(postElement);
      }

      // Aprobar publicaci√≥n
      async function approvePost(postId) {
        try {
          console.log(`‚úÖ Aprobando publicaci√≥n: ${postId}`);

          const postRef = doc(db, "posts", postId);
          await updateDoc(postRef, {
            status: 'approved',
            moderatedBy: currentUserId,
            moderatedAt: new Date().toISOString()
          });

          // Eliminar del panel admin
          const postElement = document.querySelector(`.approve-btn[data-postid="${postId}"]`)?.closest('.post-card');
          if (postElement) {
            postElement.remove();
          }

          // Actualizar estad√≠sticas
          updateAdminStats();

          // Notificar al backend (opcional)
          try {
            await fetch(`/api/social?action=approve-post`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ postId })
            });
          } catch (apiError) {
            console.warn('‚ö†Ô∏è No se pudo notificar al backend:', apiError);
          }

          mostrarMensaje('success', '‚úÖ Publicaci√≥n aprobada', 'La publicaci√≥n ahora es visible para todos los usuarios.');

          // Verificar si quedan m√°s publicaciones pendientes
          const remainingPosts = document.querySelectorAll('.post-card').length;
          if (remainingPosts === 0) {
            document.getElementById('noPendingPosts').style.display = 'block';
          }

        } catch (error) {
          console.error('‚ùå Error aprobando publicaci√≥n:', error);
          mostrarMensaje('error', 'Error', 'No se pudo aprobar la publicaci√≥n.');
        }
      }

      // Rechazar publicaci√≥n
      // üîπ Rechazar publicaci√≥n (versi√≥n mejorada)
      async function rejectPost(postId, deletehash) {
        try {
          console.log(`‚ùå Rechazando publicaci√≥n: ${postId}`);

          // 1. Eliminar de Imgur si existe deletehash
          if (deletehash && deletehash !== 'undefined') {
            try {
              await fetch(`/api/social?action=delete`, {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({ deletehash })
              });
              console.log('‚úÖ Imagen eliminada de Imgur');
            } catch (imgurError) {
              console.warn('‚ö†Ô∏è No se pudo eliminar de Imgur:', imgurError);
            }
          }

          // 2. Actualizar estado en Firestore a "rejected" en lugar de eliminar
          const postRef = doc(db, "posts", postId);
          await updateDoc(postRef, {
            status: 'rejected',
            moderatedBy: currentUserId,
            moderatedAt: new Date().toISOString(),
            moderationReason: 'Rechazada por administrador'
          });

          console.log('‚úÖ Estado actualizado a "rejected"');

          // 3. Eliminar del panel admin con animaci√≥n
          const postElement = document.querySelector(`.reject-btn[data-postid="${postId}"]`)?.closest('.post-card');
          if (postElement) {
            postElement.style.opacity = '0.5';
            setTimeout(() => {
              postElement.remove();

              // Verificar si quedan m√°s publicaciones pendientes
              const remainingPosts = document.querySelectorAll('#adminPostsContainer .post-card').length;
              if (remainingPosts === 0) {
                document.getElementById('noPendingPosts').style.display = 'block';
              }
            }, 300);
          }

          // 4. Actualizar estad√≠sticas
          await updateAdminStats();

          mostrarMensaje('success', '‚ùå Publicaci√≥n rechazada', 'La publicaci√≥n ha sido rechazada y eliminada.');

        } catch (error) {
          console.error('‚ùå Error rechazando publicaci√≥n:', error);
          mostrarMensaje('error', 'Error', 'No se pudo rechazar la publicaci√≥n: ' + error.message);
        }
      }

      // Actualizar estad√≠sticas del panel admin
      // üîπ Actualizar estad√≠sticas del panel admin (versi√≥n mejorada)
      async function updateAdminStats() {
        try {
          console.log('üìä Actualizando estad√≠sticas...');

          // Contar por estados
          const allPostsQuery = query(collection(db, "posts"));
          const snapshot = await getDocs(allPostsQuery);

          let pendingCount = 0;
          let approvedCount = 0;
          let rejectedCount = 0;

          snapshot.forEach((doc) => {
            const post = doc.data();
            switch (post.status) {
              case 'pending':
                pendingCount++;
                break;
              case 'approved':
                approvedCount++;
                break;
              case 'rejected':
                rejectedCount++;
                break;
              default:
                // Para publicaciones antiguas sin estado, contar como aprobadas
                if (!post.status) {
                  approvedCount++;
                }
            }
          });

          document.getElementById('pendingCount').textContent = pendingCount;
          document.getElementById('approvedCount').textContent = approvedCount;
          document.getElementById('rejectedCount').textContent = rejectedCount;

          console.log(`üìä Estad√≠sticas: ${pendingCount} pendientes, ${approvedCount} aprobadas, ${rejectedCount} rechazadas`);

        } catch (error) {
          console.error('‚ùå Error actualizando estad√≠sticas:', error);
          // Valores por defecto en caso de error
          document.getElementById('pendingCount').textContent = '0';
          document.getElementById('approvedCount').textContent = '0';
          document.getElementById('rejectedCount').textContent = '0';
        }
      }

      // Manejar eventos del panel admin
      // üîπ Manejar eventos del panel admin (versi√≥n mejorada)
      function setupAdminEventListeners() {
        document.addEventListener('click', async (e) => {
          // Aprobar publicaci√≥n
          if (e.target.classList.contains('approve-btn')) {
            const postId = e.target.getAttribute('data-postid');
            mostrarMensaje('confirm',
              '¬øAprobar publicaci√≥n?',
              'Esta publicaci√≥n ser√° visible para todos los usuarios.',
              () => approvePost(postId)
            );
          }

          // Rechazar publicaci√≥n
          if (e.target.classList.contains('reject-btn')) {
            const postId = e.target.getAttribute('data-postid');
            const deletehash = e.target.getAttribute('data-deletehash');
            mostrarMensaje('confirm',
              '¬øRechazar publicaci√≥n?',
              'Esta publicaci√≥n ser√° eliminada permanentemente. Esta acci√≥n no se puede deshacer.',
              () => rejectPost(postId, deletehash)
            );
          }

          // Ver informaci√≥n del usuario
          if (e.target.classList.contains('view-user-btn')) {
            const userId = e.target.getAttribute('data-userid');
            // Aqu√≠ puedes implementar una funci√≥n para ver detalles del usuario
            mostrarMensaje('info', 'Informaci√≥n del usuario', `ID del usuario: ${userId}`);
          }
        });
      }

      // üîß FUNCI√ìN TEMPORAL PARA MIGRAR PUBLICACIONES ANTIGUAS
      // üîπ Migrar publicaciones antiguas sin estado
      async function migrateOldPosts() {
        try {
          console.log('üîÑ Migrando publicaciones antiguas...');

          const q = query(collection(db, "posts"));
          const snapshot = await getDocs(q);

          let migratedCount = 0;
          const migrationPromises = [];

          snapshot.forEach((doc) => {
            const post = doc.data();
            // Si la publicaci√≥n no tiene estado, asignarle 'approved'
            if (!post.status) {
              migrationPromises.push(
                updateDoc(doc.ref, {
                  status: 'approved',
                  migratedAt: new Date().toISOString()
                })
              );
              migratedCount++;
            }
          });

          if (migrationPromises.length > 0) {
            await Promise.all(migrationPromises);
            console.log(`‚úÖ Migradas ${migratedCount} publicaciones antiguas`);
            mostrarMensaje('success', 'Migraci√≥n completada', `Se migraron ${migratedCount} publicaciones antiguas.`);
          } else {
            console.log('‚úÖ No hay publicaciones para migrar');
          }

          // Recargar posts despu√©s de la migraci√≥n
          await loadPosts();
          await updateAdminStats();

        } catch (error) {
          console.error('‚ùå Error en migraci√≥n:', error);
          mostrarMensaje('error', 'Error en migraci√≥n', 'No se pudieron migrar las publicaciones antiguas.');
        }
      }

      // üîπ Lista global de administradores (se llena autom√°ticamente)
      let ADMIN_EMAILS = [];
      // üîπ Obtener lista de administradores desde el backend
      async function getAdminEmails() {
        try {
          const response = await fetch('/api/social?action=get-admins');
          if (!response.ok) {
            throw new Error('Error al obtener administradores');
          }

          const data = await response.json();
          if (data.success) {
            if (data.success) {
              ADMIN_EMAILS = data.admins;
              console.log('‚úÖ Administradores cargados:', ADMIN_EMAILS);
            }
            return data.admins;
          } else {
            throw new Error(data.error);
          }
        } catch (error) {
          console.error('‚ùå Error obteniendo administradores:', error);
        }
      }

      // üîπ VARIABLE GLOBAL PARA SABER QU√â VIDEO SE EST√Å REPRODUCIENDO
      let videoActualmenteReproduciendose = null;

      // üîπ CONFIGURAR EVENTOS PARA TODOS LOS VIDEOS
      function configurarEventosVideos() {
        // Remover event listeners anteriores para evitar duplicados
        document.querySelectorAll('video').forEach(video => {
          video.replaceWith(video.cloneNode(true));
        });

        // Agregar event listeners a todos los videos
        document.querySelectorAll('video').forEach(video => {
          video.addEventListener('play', function () {
            manejarPlayVideo(this);
          });

          video.addEventListener('pause', function () {
            manejarPauseVideo(this);
          });
        });
      }

      // üîπ CUANDO UN VIDEO COMIENZA A REPRODUCIRSE
      function manejarPlayVideo(videoQueSeReproduce) {
        console.log('‚ñ∂Ô∏è Video comenz√≥ a reproducirse:', videoQueSeReproduce.src);

        // Si hay otro video reproduci√©ndose, pausarlo
        if (videoActualmenteReproduciendose &&
          videoActualmenteReproduciendose !== videoQueSeReproduce &&
          !videoActualmenteReproduciendose.paused) {

          console.log('‚è∏Ô∏è Pausando video anterior:', videoActualmenteReproduciendose.src);
          videoActualmenteReproduciendose.pause();
        }

        // Actualizar el video actual
        videoActualmenteReproduciendose = videoQueSeReproduce;
      }

      // üîπ CUANDO UN VIDEO SE PAUSA
      function manejarPauseVideo(videoQueSePausa) {
        console.log('‚è∏Ô∏è Video se paus√≥:', videoQueSePausa.src);

        // Si el video que se pausa es el que estaba reproduci√©ndose, limpiar la variable
        if (videoActualmenteReproduciendose === videoQueSePausa) {
          videoActualmenteReproduciendose = null;
        }
      }

      // üîπ INICIALIZAR EL SISTEMA DESPU√âS DE CARGAR POSTS
      function inicializarSistemaVideos() {
        // Peque√±o delay para asegurar que los videos est√©n en el DOM
        setTimeout(() => {
          configurarEventosVideos();
          console.log('‚úÖ Sistema de videos inicializado');
        }, 500);
      }

      // üîπ PAUSAR TODOS LOS VIDEOS (√∫til para cambiar de secci√≥n)
      function pausarTodosLosVideos() {
        if (videoActualmenteReproduciendose) {
          videoActualmenteReproduciendose.pause();
        }

        document.querySelectorAll('video').forEach(video => {
          if (!video.paused) {
            video.pause();
          }
        });

        videoActualmenteReproduciendose = null;
        console.log('‚è∏Ô∏è Todos los videos pausados');
      }







      // üîπ SISTEMA DE SCROLL SNAPPING AUTOM√ÅTICO

let isScrolling = false;
let scrollTimeout;
let currentSnappedPost = null;

function initializeScrollSnapping() {
    const mainContent = document.getElementById('mainContent');
    const posts = document.querySelectorAll('.post-card');
    
    if (posts.length === 0) return;
    
    // Configurar Intersection Observer para detectar posts centrados
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting && entry.intersectionRatio > 0.7) {
                // Esta es la publicaci√≥n actualmente centrada
                highlightSnappedPost(entry.target);
            }
        });
    }, {
        root: mainContent,
        threshold: [0.7, 0.8, 0.9],
        rootMargin: '-45% 0px -45% 0px' // Solo el centro (10% arriba y abajo)
    });
    
    // Observar todas las publicaciones
    posts.forEach(post => {
        observer.observe(post);
        
        // Agregar efecto de rebote al hacer clic
        post.addEventListener('click', (e) => {
            if (!e.target.closest('.post-actions') && !e.target.closest('.delete-post-btn')) {
                snapToPost(post);
            }
        });
    });
    
    // Detectar scroll para mejorar la experiencia
    mainContent.addEventListener('scroll', () => {
        if (!isScrolling) {
            isScrolling = true;
        }
        
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
            isScrolling = false;
            // Al terminar el scroll, asegurar que un post est√© centrado
            ensurePostIsCentered();
        }, 150);
    });
    
    console.log('üéØ Scroll snapping inicializado');
}

// Funci√≥n para resaltar la publicaci√≥n centrada
function highlightSnappedPost(postElement) {
    // Remover highlight anterior
    if (currentSnappedPost && currentSnappedPost !== postElement) {
        currentSnappedPost.classList.remove('snapped');
    }
    
    // Aplicar highlight nuevo
    postElement.classList.add('snapped');
    currentSnappedPost = postElement;
    
    // Efecto de rebote
    postElement.style.animation = 'none';
    setTimeout(() => {
        postElement.style.animation = 'bounceSnap 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55)';
    }, 10);
}

// Funci√≥n para centrar una publicaci√≥n espec√≠fica
function snapToPost(postElement) {
    const mainContent = document.getElementById('mainContent');
    const postRect = postElement.getBoundingClientRect();
    const mainRect = mainContent.getBoundingClientRect();
    
    const targetScroll = mainContent.scrollTop + (postRect.top - mainRect.top) - (mainRect.height / 2) + (postRect.height / 2);
    
    mainContent.scrollTo({
        top: targetScroll,
        behavior: 'smooth'
    });
    
    highlightSnappedPost(postElement);
}

// Asegurar que siempre haya un post centrado
function ensurePostIsCentered() {
    const posts = document.querySelectorAll('.post-card');
    const mainContent = document.getElementById('mainContent');
    
    let closestPost = null;
    let closestDistance = Infinity;
    
    posts.forEach(post => {
        const postRect = post.getBoundingClientRect();
        const mainRect = mainContent.getBoundingClientRect();
        
        const postCenter = postRect.top + (postRect.height / 2);
        const mainCenter = mainRect.top + (mainRect.height / 2);
        const distance = Math.abs(postCenter - mainCenter);
        
        if (distance < closestDistance) {
            closestDistance = distance;
            closestPost = post;
        }
    });
    
    if (closestPost && closestDistance < mainRect.height * 0.4) {
        snapToPost(closestPost);
    }
}

// Navegaci√≥n con teclado
function setupKeyboardSnapping() {
    document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown' || e.key === 'ArrowUp' || e.key === ' ' || e.key === 'PageDown' || e.key === 'PageUp') {
            e.preventDefault();
            
            const posts = Array.from(document.querySelectorAll('.post-card'));
            if (posts.length === 0) return;
            
            let currentIndex = currentSnappedPost ? posts.indexOf(currentSnappedPost) : 0;
            
            if (e.key === 'ArrowDown' || e.key === ' ' || e.key === 'PageDown') {
                currentIndex = currentIndex < posts.length - 1 ? currentIndex + 1 : 0;
            } else if (e.key === 'ArrowUp' || e.key === 'PageUp') {
                currentIndex = currentIndex > 0 ? currentIndex - 1 : posts.length - 1;
            }
            
            snapToPost(posts[currentIndex]);
            smoothScrollToPost(posts[newIndex]);
        }
    });
}

// üîπ SISTEMA DE SCROLL SNAPPING MEJORADO (MANTIENE POSICI√ìN)
let scrollSnapObserver = null;
let isProgrammaticScroll = false;

function setupScrollSnapSystem() {
    const posts = document.querySelectorAll('.post-card');
    if (posts.length === 0) return;
    
    // Detener el observer anterior si existe
    if (scrollSnapObserver) {
        scrollSnapObserver.disconnect();
    }
    
    // Crear nuevo observer
    scrollSnapObserver = new IntersectionObserver((entries) => {
      // Si es un scroll program√°tico, ignorar
      if (isProgrammaticScroll) return;
        entries.forEach(entry => {
            if (entry.isIntersecting && entry.intersectionRatio > 0.7) {
                if (currentSnappedPost && currentSnappedPost !== entry.target) {
                    currentSnappedPost.classList.remove('snapped');
                }
                entry.target.classList.add('snapped');
                currentSnappedPost = entry.target;
                
                // Efecto rebote
                entry.target.style.animation = 'none';
                setTimeout(() => {
                    entry.target.style.animation = 'bounceSnap 0.6s ease';
                }, 10);
            }
        });
    }, {
        root: document.getElementById('mainContent'),
        threshold: 0.7,
        rootMargin: '-40% 0px -40% 0px'
    });
    
    // Observar solo las nuevas publicaciones (no todas)
    posts.forEach(post => {
        if (!post.hasAttribute('data-observed')) {
            scrollSnapObserver.observe(post);
            post.setAttribute('data-observed', 'true');
        }
    });
    
    console.log('üéØ Scroll snapping actualizado para', posts.length, 'publicaciones');
}

// Funci√≥n para inicializar solo una vez al principio
function initializeScrollSnapOnce() {
    const posts = document.querySelectorAll('.post-card');
    if (posts.length === 0) return;
    
    // Solo centrar la primera publicaci√≥n la primera vez
    if (!document.body.hasAttribute('data-snap-initialized')) {
        setTimeout(() => {
            if (posts[0]) {
                posts[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }, 500);
        document.body.setAttribute('data-snap-initialized', 'true');
    }
    
    setupScrollSnapSystem();
}

// üîπ FUNCI√ìN PARA SCROLL SUAVE SIN INTERFERENCIAS
function smoothScrollToPost(postElement) {
    isProgrammaticScroll = true;
    
    const mainContent = document.getElementById('mainContent');
    const postRect = postElement.getBoundingClientRect();
    const mainRect = mainContent.getBoundingClientRect();
    
    const targetScroll = mainContent.scrollTop + (postRect.top - mainRect.top) - (mainRect.height / 2) + (postRect.height / 2);
    
    mainContent.scrollTo({
        top: targetScroll,
        behavior: 'smooth'
    });
    
    // Resaltar la publicaci√≥n
    if (currentSnappedPost) {
        currentSnappedPost.classList.remove('snapped');
    }
    postElement.classList.add('snapped');
    currentSnappedPost = postElement;
    
    // Permitir que el observer vuelva a funcionar
    setTimeout(() => {
        isProgrammaticScroll = false;
    }, 1000);
}
    </script>


</body>

</html>