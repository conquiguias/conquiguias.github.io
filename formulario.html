<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Formulario</title>
</head>

<body>
  <img src="logo1.png" style="width: 25%;" alt="">
  <h2 id="tituloFormulario">Cargando...</h2>
  
  <!-- Contadores para cada asistencia -->
  <div id="contadores">
    <p id="contadorPrimera" style="display: none;">‚è≥ Primera asistencia: <span id="tiempoPrimera">30:00</span></p>
    <p id="contadorSegunda" style="display: none;">‚è≥ Segunda asistencia: <span id="tiempoSegunda">20:00</span></p>
    <p id="contadorTercera" style="display: none;">‚è≥ Tercera asistencia: <span id="tiempoTercera">20:00</span></p>
  </div>

  <!-- Botones de asistencia -->
  <div id="botonesAsistencia">
    <button id="btnPrimeraAsistencia" style="display: none;">Registrar primera asistencia</button>
    <button id="btnSegundaAsistencia" style="display: none;" disabled>Registrar segunda asistencia</button>
    <button id="btnTerceraAsistencia" style="display: none;" disabled>Registrar tercera asistencia</button>
  </div>

  <form id="formulario" style="display: none;">
    <input type="hidden" name="id" id="idFormulario">

    <label>Nombre:</label><br>
    <input type="text" name="nombre" required><br><br>

    <label>Correo: (Opcional)</label><br>
    <input type="email" name="correo"><br><br>

    <label>Edad: (Opcional)</label><br>
    <input type="number" name="edad"><br><br>

    <label>Tel√©fono:</label><br>
    <input type="tel" name="telefono" required><br><br>

    <label>Asociaci√≥n o campo:</label><br>
    <input type="text" name="asociacion" required><br><br>

    <button type="submit">Enviar</button>
  </form>

  <p id="mensaje"></p>

  <h3>üìä Respuestas registradas | Se actualiza cada 5 minutos.</h3>
  <p id="contadorRecarga">üîÑ Pr√≥xima recarga en: <span id="segundos">300</span> segundos</p>

  <p>Informaci√≥n exclusiva para instructores y directores. Su informaci√≥n es borrada despu√©s de 90 d√≠as</p>
  <table border="1" id="tablaRespuestas" style="border-collapse: collapse; width: 100%;">
    <thead>
      <tr>
        <th>#</th>
        <th>Nombre</th>
        <th>Correo</th>
        <th>Edad</th>
        <th>Tel√©fono</th>
        <th>Asociaci√≥n</th>
        <th>Fecha</th>
        <th>N√∫mero de Asistencia</th>
        <th>¬øAsisti√≥?</th>
        <th>Evaluaci√≥n</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    function generarUUID() {
      return crypto.randomUUID();
    }

    let visitanteId = localStorage.getItem("visitanteId");
    if (!visitanteId) {
      visitanteId = generarUUID();
      localStorage.setItem("visitanteId", visitanteId);
    }

    // Variables para control de asistencias
    let primeraAsistenciaCompletada = false;
    let segundaAsistenciaCompletada = false;
    let terceraAsistenciaCompletada = false;
    let intervaloPrimera, intervaloSegunda, intervaloTercera;
    let fechaInicioFormulario;
    let fechaFinPrimera, fechaFinSegunda, fechaFinTercera;

    document.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(location.search);
      const id = params.get("id");

      if (!id) {
        document.body.innerHTML = "<h2>‚ùå Error: ID de formulario no especificado.</h2>";
        return;
      }

      try {
        const res = await fetch(`/api/obtenerFormulario?id=${id}`);
        if (!res.ok) {
          document.body.innerHTML = `<h2>‚ùå Formulario '${id}' no encontrado.</h2>`;
          return;
        }

        const data = await res.json();
        document.getElementById("tituloFormulario").textContent = data.titulo;
        document.getElementById("idFormulario").value = id;

        // Calcular tiempos basados en la fecha de cierre del formulario
        const fechaCierre = new Date(data.fechaCierre);
        fechaInicioFormulario = new Date(fechaCierre.getTime() - (70 * 60 * 1000)); // 70 minutos antes
        fechaFinPrimera = new Date(fechaInicioFormulario.getTime() + (30 * 60 * 1000)); // 30 minutos
        fechaFinSegunda = new Date(fechaFinPrimera.getTime() + (20 * 60 * 1000)); // 20 minutos
        fechaFinTercera = new Date(fechaFinSegunda.getTime() + (20 * 60 * 1000)); // 20 minutos

        // Verificar estado de asistencias del usuario
        await verificarEstadoAsistencias(id);
        
        // Iniciar sistema de asistencias
        iniciarSistemaAsistencias();

        // Cargar respuestas y configurar recarga
        let segundosRestantes = 300;
        cargarRespuestas(id);
        setInterval(() => {
          segundosRestantes--;
          document.getElementById("segundos").textContent = segundosRestantes;
          if (segundosRestantes <= 0) {
            cargarRespuestas(id);
            segundosRestantes = 300;
          }
        }, 1000);

      } catch (error) {
        console.error(error);
        document.body.innerHTML = "<h2>‚ùå Error al cargar el formulario.</h2>";
      }
    });

    // Funci√≥n para verificar el estado de asistencias del usuario
    async function verificarEstadoAsistencias(idFormulario) {
      try {
        const res = await fetch(`/api/verRespuestas?id=${idFormulario}`);
        if (res.ok) {
          const respuestas = await res.json();
          const misRespuestas = respuestas.filter(r => r.visitanteId === visitanteId);
          
          misRespuestas.forEach(respuesta => {
            if (respuesta.asistenciaNumero === 1) primeraAsistenciaCompletada = true;
            if (respuesta.asistenciaNumero === 2) segundaAsistenciaCompletada = true;
            if (respuesta.asistenciaNumero === 3) terceraAsistenciaCompletada = true;
          });
        }
      } catch (error) {
        console.error("Error al verificar asistencias:", error);
      }
    }

    // Sistema principal de asistencias
    function iniciarSistemaAsistencias() {
      const ahora = new Date();
      
      // Verificar si el formulario ya expir√≥
      if (ahora > fechaFinTercera) {
        document.getElementById("mensaje").textContent = "‚õî El formulario ha caducado. No se pueden registrar m√°s asistencias.";
        return;
      }

      // Configurar primera asistencia si a√∫n no est√° completada y est√° en tiempo
      if (!primeraAsistenciaCompletada && ahora < fechaFinPrimera) {
        configurarPrimeraAsistencia();
      } 
      // Si la primera ya est√° completada o el tiempo pas√≥, configurar segunda
      else if (primeraAsistenciaCompletada && !segundaAsistenciaCompletada && ahora < fechaFinSegunda) {
        configurarSegundaAsistencia();
      }
      // Si la segunda ya est√° completada o el tiempo pas√≥, configurar tercera
      else if (segundaAsistenciaCompletada && !terceraAsistenciaCompletada && ahora < fechaFinTercera) {
        configurarTerceraAsistencia();
      }
    }

    function configurarPrimeraAsistencia() {
      document.getElementById("btnPrimeraAsistencia").style.display = "block";
      document.getElementById("contadorPrimera").style.display = "block";

      // Configurar contador regresivo
      actualizarContadorPrimera();
      intervaloPrimera = setInterval(actualizarContadorPrimera, 1000);

      document.getElementById("btnPrimeraAsistencia").addEventListener("click", () => {
        document.getElementById("formulario").style.display = "block";
        document.getElementById("btnPrimeraAsistencia").style.display = "none";
      });
    }

    function actualizarContadorPrimera() {
      const ahora = new Date();
      const restante = fechaFinPrimera - ahora;

      if (restante <= 0) {
        clearInterval(intervaloPrimera);
        document.getElementById("contadorPrimera").textContent = "‚è∞ Tiempo agotado para primera asistencia";
        document.getElementById("btnPrimeraAsistencia").disabled = true;
        // Pasar a segunda asistencia autom√°ticamente si ya complet√≥ la primera
        if (primeraAsistenciaCompletada) {
          configurarSegundaAsistencia();
        }
        return;
      }

      const minutos = Math.floor((restante / 1000 / 60) % 60);
      const segundos = Math.floor((restante / 1000) % 60);
      document.getElementById("tiempoPrimera").textContent = 
        `${minutos}:${segundos.toString().padStart(2, "0")}`;
    }

    function configurarSegundaAsistencia() {
      if (!primeraAsistenciaCompletada) {
        document.getElementById("mensaje").textContent = "‚ùå Debes completar la primera asistencia antes de continuar.";
        return;
      }

      document.getElementById("btnSegundaAsistencia").style.display = "block";
      document.getElementById("contadorSegunda").style.display = "block";
      document.getElementById("btnSegundaAsistencia").disabled = false;

      // Ocultar primera asistencia
      document.getElementById("contadorPrimera").style.display = "none";

      // Configurar contador regresivo
      actualizarContadorSegunda();
      intervaloSegunda = setInterval(actualizarContadorSegunda, 1000);

      document.getElementById("btnSegundaAsistencia").addEventListener("click", async () => {
        const datos = {
          id: document.getElementById("idFormulario").value,
          visitanteId: visitanteId,
          asistenciaNumero: 2,
          fecha: new Date().toISOString()
        };

        const res = await fetch("/api/guardar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(datos)
        });

        if (res.ok) {
          segundaAsistenciaCompletada = true;
          document.getElementById("btnSegundaAsistencia").style.display = "none";
          document.getElementById("contadorSegunda").style.display = "none";
          document.getElementById("mensaje").textContent = "‚úÖ Segunda asistencia registrada";
          configurarTerceraAsistencia();
          cargarRespuestas(datos.id);
        } else {
          document.getElementById("mensaje").textContent = "‚ùå Error al registrar segunda asistencia";
        }
      });
    }

    function actualizarContadorSegunda() {
      const ahora = new Date();
      const restante = fechaFinSegunda - ahora;

      if (restante <= 0) {
        clearInterval(intervaloSegunda);
        document.getElementById("contadorSegunda").textContent = "‚è∞ Tiempo agotado para segunda asistencia";
        document.getElementById("btnSegundaAsistencia").disabled = true;
        // Pasar a tercera asistencia autom√°ticamente si ya complet√≥ la segunda
        if (segundaAsistenciaCompletada) {
          configurarTerceraAsistencia();
        }
        return;
      }

      const minutos = Math.floor((restante / 1000 / 60) % 60);
      const segundos = Math.floor((restante / 1000) % 60);
      document.getElementById("tiempoSegunda").textContent = 
        `${minutos}:${segundos.toString().padStart(2, "0")}`;
    }

    function configurarTerceraAsistencia() {
      if (!segundaAsistenciaCompletada) {
        document.getElementById("mensaje").textContent = "‚ùå Debes completar la segunda asistencia antes de continuar.";
        return;
      }

      document.getElementById("btnTerceraAsistencia").style.display = "block";
      document.getElementById("contadorTercera").style.display = "block";
      document.getElementById("btnTerceraAsistencia").disabled = false;

      // Ocultar segunda asistencia
      document.getElementById("contadorSegunda").style.display = "none";

      // Configurar contador regresivo
      actualizarContadorTercera();
      intervaloTercera = setInterval(actualizarContadorTercera, 1000);

      document.getElementById("btnTerceraAsistencia").addEventListener("click", async () => {
        const datos = {
          id: document.getElementById("idFormulario").value,
          visitanteId: visitanteId,
          asistenciaNumero: 3,
          fecha: new Date().toISOString()
        };

        const res = await fetch("/api/guardar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(datos)
        });

        if (res.ok) {
          terceraAsistenciaCompletada = true;
          document.getElementById("btnTerceraAsistencia").style.display = "none";
          document.getElementById("contadorTercera").style.display = "none";
          document.getElementById("mensaje").textContent = "‚úÖ Tercera asistencia registrada. ¬°Completaste todas las asistencias!";
          cargarRespuestas(datos.id);
        } else {
          document.getElementById("mensaje").textContent = "‚ùå Error al registrar tercera asistencia";
        }
      });
    }

    function actualizarContadorTercera() {
      const ahora = new Date();
      const restante = fechaFinTercera - ahora;

      if (restante <= 0) {
        clearInterval(intervaloTercera);
        document.getElementById("contadorTercera").textContent = "‚è∞ Tiempo agotado para tercera asistencia";
        document.getElementById("btnTerceraAsistencia").disabled = true;
        return;
      }

      const minutos = Math.floor((restante / 1000 / 60) % 60);
      const segundos = Math.floor((restante / 1000) % 60);
      document.getElementById("tiempoTercera").textContent = 
        `${minutos}:${segundos.toString().padStart(2, "0")}`;
    }

    // Mostrar respuestas del formulario en la tabla
    async function cargarRespuestas(idFormulario) {
      const tablaBody = document.querySelector("#tablaRespuestas tbody");
      tablaBody.innerHTML = "<tr><td colspan='10'>Cargando respuestas...</td></tr>";

      try {
        const res = await fetch(`/api/verRespuestas?id=${idFormulario}`);
        if (!res.ok) {
          tablaBody.innerHTML = "<tr><td colspan='10'>No hay respuestas a√∫n.</td></tr>";
          return;
        }

        const respuestas = await res.json();

        if (!respuestas.length) {
          tablaBody.innerHTML = "<tr><td colspan='10'>No hay respuestas a√∫n.</td></tr>";
          return;
        }

        // Agrupar respuestas por visitanteId
        const respuestasAgrupadas = {};
        respuestas.forEach(r => {
          if (!respuestasAgrupadas[r.visitanteId]) {
            respuestasAgrupadas[r.visitanteId] = {
              nombre: r.nombre || 'N/A',
              correo: r.correo || 'N/A',
              edad: r.edad || 'N/A',
              telefono: r.telefono || 'N/A',
              asociacion: r.asociacion || 'N/A',
              fecha: r.fecha,
              maxAsistencia: 0,
              asistencias: []
            };
          }
          
          if (r.asistenciaNumero) {
            respuestasAgrupadas[r.visitanteId].asistencias.push(r.asistenciaNumero);
            respuestasAgrupadas[r.visitanteId].maxAsistencia = Math.max(
              respuestasAgrupadas[r.visitanteId].maxAsistencia, 
              r.asistenciaNumero
            );
          }
        });

        tablaBody.innerHTML = "";
        Object.values(respuestasAgrupadas).forEach((r, index) => {
          const asistioCompleto = r.maxAsistencia >= 3 ? "S√ç" : "NO";
          const puedeExamen = r.maxAsistencia >= 3;
          const fila = `
            <tr>
              <td>${index + 1}</td>
              <td>${r.nombre}</td>
              <td>${r.correo}</td>
              <td>${r.edad}</td>
              <td>${r.telefono}</td>
              <td>${r.asociacion}</td>
              <td>${new Date(r.fecha).toLocaleString()}</td>
              <td>${r.maxAsistencia}</td>
              <td>${asistioCompleto}</td>
              <td>
                ${puedeExamen 
                  ? '<button onclick="iniciarExamen()">Hacer Examen</button>' 
                  : 'No puede hacer Examen'}
              </td>
            </tr>
          `;
          tablaBody.insertAdjacentHTML("beforeend", fila);
        });

      } catch (error) {
        tablaBody.innerHTML = "<tr><td colspan='10'>Error al cargar respuestas.</td></tr>";
        console.error(error);
      }
    }

    function iniciarExamen() {
      alert("Funci√≥n de examen ser√° implementada pr√≥ximamente");
      // Aqu√≠ ir√° la l√≥gica del examen
    }

    document.getElementById("formulario").addEventListener("submit", async function (e) {
      e.preventDefault();

      const datos = Object.fromEntries(new FormData(this).entries());
      datos.visitanteId = visitanteId;
      datos.asistenciaNumero = 1;

      // Validar que est√© en el tiempo correcto para la primera asistencia
      const ahora = new Date();
      if (ahora > fechaFinPrimera) {
        document.getElementById("mensaje").textContent = "‚ùå El tiempo para la primera asistencia ha expirado";
        return;
      }

      const res = await fetch("/api/guardar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(datos)
      });

      const mensaje = document.getElementById("mensaje");
      if (res.ok) {
        mensaje.textContent = "‚úÖ Primera asistencia registrada. ¬°Gracias!";
        this.reset();
        this.style.display = "none";
        primeraAsistenciaCompletada = true;
        
        // Limpiar intervalo de primera asistencia
        if (intervaloPrimera) clearInterval(intervaloPrimera);
        
        // Configurar segunda asistencia
        configurarSegundaAsistencia();
        cargarRespuestas(datos.id);
      } else {
        mensaje.textContent = "‚ùå Ocurri√≥ un error al guardar. Usuario Ya registrado";
      }
    });
  </script>
</body>
</html>