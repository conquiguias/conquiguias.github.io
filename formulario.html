<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formulario de Asistencia</title>
</head>
<body>
  <img src="logo1.png" style="width: 25%;" alt="">
  <h2 id="tituloFormulario">Cargando...</h2>
  <p id="contador"></p>

  <form id="formulario" style="display: none;">
    <input type="hidden" name="id" id="idFormulario">

    <label>Nombre:</label><br>
    <input type="text" name="nombre" required><br><br>

    <label>Correo:</label><br>
    <input type="email" name="correo" required><br><br>

    <label>Tel√©fono:</label><br>
    <input type="tel" name="telefono" required><br><br>

    <label>Asociaci√≥n o campo:</label><br>
    <input type="text" name="asociacion" required><br><br>

    <button type="submit">Registrar Primera Asistencia</button>
  </form>

  <!-- Botones din√°micos -->
  <div id="botonesAsistencia" style="margin-top:20px; display:none;">
    <button id="btnSegunda" style="display:none;">Registrar Segunda Asistencia</button>
    <button id="btnTercera" style="display:none;">Registrar Tercera Asistencia</button>
  </div>

  <p id="mensaje"></p>

  <h3>üìä Respuestas registradas | Se actualiza cada 5 minutos.</h3>
  <p id="contadorRecarga">üîÑ Pr√≥xima recarga en: <span id="segundos">300</span> segundos</p>

  <p>Informaci√≥n exclusiva para instructores y directores. Su informaci√≥n es borrada despu√©s de 90 d√≠as.</p>
  <table border="1" id="tablaRespuestas" style="border-collapse: collapse; width: 100%;">
    <thead>
      <tr>
        <th>#</th>
        <th>Nombre</th>
        <th>Correo</th>
        <th>Tel√©fono</th>
        <th>Asociaci√≥n</th>
        <th>N√∫mero Asistencia</th>
        <th>¬øAsisti√≥?</th>
        <th>Examen</th>
        <th>Fecha</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(location.search);
      const id = params.get("id");
      if (!id) {
        document.body.innerHTML = "<h2>‚ùå Error: ID de formulario no especificado.</h2>";
        return;
      }

      const titulo = document.getElementById("tituloFormulario");
      const contador = document.getElementById("contador");
      const formulario = document.getElementById("formulario");
      const botones = document.getElementById("botonesAsistencia");
      const btnSegunda = document.getElementById("btnSegunda");
      const btnTercera = document.getElementById("btnTercera");
      const mensaje = document.getElementById("mensaje");
      const tablaBody = document.querySelector("#tablaRespuestas tbody");

      // Cargar formulario
      try {
        const res = await fetch(`/api/obtenerFormulario?id=${id}`);
        if (!res.ok) throw new Error("Formulario no encontrado.");
        const data = await res.json();
        titulo.textContent = data.titulo || "Asistencia Especialidad";
        formulario.style.display = "block";
        document.getElementById("idFormulario").value = id;
      } catch {
        document.body.innerHTML = "<h2>‚ùå Error al cargar el formulario.</h2>";
        return;
      }

      // Estado inicial
      let tiempoPrimera = 30 * 60; // 30 min
      let tiempoSegunda = 30 * 60;
      let tiempoTercera = 10 * 60;
      let etapa = 1;

      function iniciarCronometro(duracion, siguienteEtapa) {
        let restante = duracion;
        contador.style.display = "block";
        const intervalo = setInterval(() => {
          const min = Math.floor(restante / 60);
          const seg = String(restante % 60).padStart(2, "0");
          contador.textContent = `‚è≥ Tiempo restante: ${min}:${seg}`;
          restante--;
          if (restante < 0) {
            clearInterval(intervalo);
            if (siguienteEtapa === 2) mostrarSegunda();
            if (siguienteEtapa === 3) mostrarTercera();
            if (siguienteEtapa === 4) contador.textContent = "‚õî Tiempo de asistencia finalizado.";
          }
        }, 1000);
      }

      function mostrarSegunda() {
        formulario.style.display = "none";
        botones.style.display = "block";
        btnSegunda.style.display = "inline-block";
        contador.textContent = "üïì Segunda asistencia activa durante 30 minutos.";
        iniciarCronometro(tiempoSegunda, 3);
      }

      function mostrarTercera() {
        botones.style.display = "block";
        btnSegunda.style.display = "none";
        btnTercera.style.display = "inline-block";
        contador.textContent = "üïï Tercera asistencia activa durante 10 minutos.";
        iniciarCronometro(tiempoTercera, 4);
      }

      formulario.addEventListener("submit", async (e) => {
        e.preventDefault();
        const datos = Object.fromEntries(new FormData(formulario).entries());
        datos.id = id;

        const res = await fetch("/api/guardar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(datos),
        });

        const data = await res.json();
        if (res.ok) {
          mensaje.textContent = data.message;
          formulario.style.display = "none";
          iniciarCronometro(tiempoPrimera, 2);
          cargarRespuestas(id);
        } else {
          mensaje.textContent = data.error;
        }
      });

      btnSegunda.addEventListener("click", async () => {
        const correo = document.querySelector("[name='correo']").value.trim();
        if (!correo) return alert("Debes ingresar tu correo antes.");
        const res = await fetch("/api/guardar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id, correo }),
        });
        const data = await res.json();
        if (res.ok) {
          mensaje.textContent = "‚úÖ Segunda asistencia registrada.";
          btnSegunda.style.display = "none";
          iniciarCronometro(tiempoSegunda, 3);
          cargarRespuestas(id);
        } else {
          mensaje.textContent = data.error;
        }
      });

      btnTercera.addEventListener("click", async () => {
        const correo = document.querySelector("[name='correo']").value.trim();
        const res = await fetch("/api/guardar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id, correo }),
        });
        const data = await res.json();
        if (res.ok) {
          mensaje.textContent = "‚úÖ Tercera asistencia registrada.";
          btnTercera.style.display = "none";
          contador.textContent = "‚úÖ Asistencias completadas. ¬°Listo para examen!";
          cargarRespuestas(id);
        } else {
          mensaje.textContent = data.error;
        }
      });

      // Tabla
      async function cargarRespuestas(idFormulario) {
        tablaBody.innerHTML = "<tr><td colspan='9'>Cargando...</td></tr>";
        try {
          const res = await fetch(`/api/verRespuestas?id=${idFormulario}`);
          const respuestas = await res.json();
          if (!respuestas.length) {
            tablaBody.innerHTML = "<tr><td colspan='9'>No hay respuestas a√∫n.</td></tr>";
            return;
          }

          tablaBody.innerHTML = "";
          respuestas.forEach((r, i) => {
            const totalAsistencias = Object.values(r.asistencias || {}).filter(Boolean).length;
            const examen = totalAsistencias === 3 ? 
              "<button>Hacer examen</button>" : 
              "No puede hacer examen";
            const fila = `
              <tr>
                <td>${i + 1}</td>
                <td>${r.nombre || "-"}</td>
                <td>${r.correo}</td>
                <td>${r.telefono || "-"}</td>
                <td>${r.asociacion || "-"}</td>
                <td>${totalAsistencias}</td>
                <td>${totalAsistencias > 0 ? "S√≠" : "No"}</td>
                <td>${examen}</td>
                <td>${new Date(r.fechaUltima).toLocaleString()}</td>
              </tr>
            `;
            tablaBody.insertAdjacentHTML("beforeend", fila);
          });
        } catch {
          tablaBody.innerHTML = "<tr><td colspan='9'>Error al cargar respuestas.</td></tr>";
        }
      }

      // Recarga cada 5 min
      let segundos = 300;
      setInterval(() => {
        segundos--;
        document.getElementById("segundos").textContent = segundos;
        if (segundos <= 0) {
          cargarRespuestas(id);
          segundos = 300;
        }
      }, 1000);

      cargarRespuestas(id);
    });
  </script>
</body>
</html>
