<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Formulario</title>
</head>

<body>
  <img src="logo1.png" style="width: 25%;" alt="">
  <h2 id="tituloFormulario">Cargando...</h2>
  <p id="contador"></p>

  <form id="formulario" style="display: none;">
    <input type="hidden" name="id" id="idFormulario">

    <label>Nombre:</label><br>
    <input type="text" name="nombre" required><br><br>

    <label>Correo: (Opcional)</label><br>
    <input type="email" name="correo"><br><br>

    <label>Edad: (Opcional)</label><br>
    <input type="number" name="edad"><br><br>

    <label>Tel√©fono:</label><br>
    <input type="tel" name="telefono" required><br><br>

    <label>Asociaci√≥n o campo:</label><br>
    <input type="text" name="asociacion" required><br><br>

    <button type="submit">Enviar</button>
  </form>

  <p id="mensaje"></p>

  <h3>üìä Respuestas registradas | Se actualiza cada 5 minutos.</h3><p id="contadorRecarga">üîÑ Pr√≥xima recarga en: <span id="segundos">300</span> segundos</p>

  <p>Informaci√≥n exclusiva para instructores y directores. Su informaci√≥n es borrada despu√©s de 90 d√≠as</p>
  <table border="1" id="tablaRespuestas" style="border-collapse: collapse; width: 100%;">
    <thead>
      <tr>
        <th>#</th>
        <th>Nombre</th>
        <th>Correo</th>
        <th>Edad</th>
        <th>Tel√©fono</th>
        <th>Asociaci√≥n</th>
        <th>Fecha</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>


  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(location.search);
      const id = params.get("id");
    
      if (!id) {
        document.body.innerHTML = "<h2>‚ùå Error: ID de formulario no especificado.</h2>";
        return;
      }
    
      // Clave √∫nica por especialidad
      const storageKey = `asistencia_${id}`;
    
      // Recuperar progreso anterior (solo para este formulario)
      let progreso = JSON.parse(localStorage.getItem(storageKey)) || {
        asistencia: 0,
        ultimaHora: null,
      };
    
      try {
        const res = await fetch(`/api/obtenerFormulario?id=${id}`);
        if (!res.ok) {
          document.body.innerHTML = `<h2>‚ùå Formulario '${id}' no encontrado.</h2>`;
          return;
        }
    
        const data = await res.json();
        const tituloEl = document.getElementById("tituloFormulario");
        const formulario = document.getElementById("formulario");
        const mensaje = document.getElementById("mensaje");
        const contadorEl = document.getElementById("contador");
    
        tituloEl.textContent = data.titulo;
        document.getElementById("idFormulario").value = id;
    
        // üîπ Funci√≥n para mostrar contador visible
        const iniciarContador = (duracion, callback) => {
          let tiempoRestante = duracion;
          contadorEl.style.display = "block";
          const intervalo = setInterval(() => {
            const minutos = Math.floor(tiempoRestante / 60);
            const segundos = tiempoRestante % 60;
            contadorEl.textContent = `‚è≥ Tiempo restante: ${minutos}:${segundos
              .toString()
              .padStart(2, "0")}`;
            tiempoRestante--;
            if (tiempoRestante < 0) {
              clearInterval(intervalo);
              callback();
            }
          }, 1000);
        };
    
        // üîπ Control de flujo seg√∫n asistencia actual
        if (progreso.asistencia === 0) {
          formulario.style.display = "block";
          iniciarContador(30 * 60, () => {
            mensaje.textContent = "‚è±Ô∏è Finaliz√≥ el tiempo de registro de la primera asistencia.";
            formulario.style.display = "none";
            progreso.asistencia = 1;
            progreso.ultimaHora = Date.now();
            localStorage.setItem(storageKey, JSON.stringify(progreso));
          });
        } else if (progreso.asistencia === 1) {
          mostrarBotonAsistencia("Segunda", 30 * 60, 2);
        } else if (progreso.asistencia === 2) {
          mostrarBotonAsistencia("Tercera", 10 * 60, 3);
        } else {
          mensaje.textContent = "‚úÖ Ya completaste las tres asistencias.";
        }
    
        // üîπ Funci√≥n para mostrar botones din√°micos
        function mostrarBotonAsistencia(nombre, duracion, siguiente) {
          formulario.style.display = "none";
          const contenedor = document.createElement("div");
          contenedor.innerHTML = `<button id="btn${nombre}">Registrar ${nombre} Asistencia</button>`;
          document.body.insertBefore(contenedor, mensaje);
    
          iniciarContador(duracion, () => {
            mensaje.textContent = `‚è±Ô∏è Finaliz√≥ el tiempo de la ${nombre.toLowerCase()} asistencia.`;
            contenedor.remove();
            progreso.asistencia = siguiente;
            progreso.ultimaHora = Date.now();
            localStorage.setItem(storageKey, JSON.stringify(progreso));
          });
    
          document.getElementById(`btn${nombre}`).onclick = async () => {
            const correo = localStorage.getItem("correoUsuario");
            if (!correo) {
              mensaje.textContent = "‚ö†Ô∏è Error: no se encontr√≥ tu registro inicial.";
              return;
            }
    
            const res = await fetch("/api/guardar", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                id,
                correo,
                numeroAsistencia: siguiente - 1,
              }),
            });
    
            if (res.ok) {
              mensaje.textContent = `‚úÖ ${nombre} asistencia registrada correctamente.`;
              contenedor.remove();
              progreso.asistencia = siguiente;
              progreso.ultimaHora = Date.now();
              localStorage.setItem(storageKey, JSON.stringify(progreso));
              cargarRespuestas(id);
            } else {
              mensaje.textContent = "‚ùå Error al registrar asistencia.";
            }
          };
        }
    
        // Guardar correo despu√©s del primer registro
        document
          .getElementById("formulario")
          .addEventListener("submit", async function (e) {
            e.preventDefault();
            const datos = Object.fromEntries(new FormData(this).entries());
            localStorage.setItem("correoUsuario", datos.correo);
    
            const res = await fetch("/api/guardar", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(datos),
            });
    
            if (res.ok) {
              mensaje.textContent = "‚úÖ Primera asistencia registrada.";
              formulario.style.display = "none";
              progreso.asistencia = 1;
              progreso.ultimaHora = Date.now();
              localStorage.setItem(storageKey, JSON.stringify(progreso));
              cargarRespuestas(datos.id);
            } else {
              mensaje.textContent = "‚ùå Ocurri√≥ un error al registrar.";
            }
          });
    
        // üîπ Mostrar tabla
        async function cargarRespuestas(idFormulario) {
          const tablaBody = document.querySelector("#tablaRespuestas tbody");
          tablaBody.innerHTML = "<tr><td colspan='7'>Cargando...</td></tr>";
    
          try {
            const res = await fetch(`/api/verRespuestas?id=${idFormulario}`);
            if (!res.ok) {
              tablaBody.innerHTML = "<tr><td colspan='7'>No hay datos.</td></tr>";
              return;
            }
    
            const respuestas = await res.json();
            if (!respuestas.length) {
              tablaBody.innerHTML = "<tr><td colspan='7'>No hay respuestas.</td></tr>";
              return;
            }
    
            tablaBody.innerHTML = "";
            respuestas.forEach((r, i) => {
              const fila = `
                <tr>
                  <td>${i + 1}</td>
                  <td>${r.nombre || "-"}</td>
                  <td>${r.correo || "-"}</td>
                  <td>${r.telefono || "-"}</td>
                  <td>${r.asociacion || "-"}</td>
                  <td>${r.numeroAsistencia || "-"}</td>
                  <td>${r.asistio || "S√≠"}</td>
                  <td>${r.numeroAsistencia === 3 ? "üß† Examen disponible" : "‚ùå No puede hacer examen"}</td>
                  <td>${new Date(r.fecha).toLocaleString()}</td>
                </tr>
              `;
              tablaBody.insertAdjacentHTML("beforeend", fila);
            });
          } catch (error) {
            console.error(error);
            tablaBody.innerHTML = "<tr><td colspan='7'>Error al cargar respuestas.</td></tr>";
          }
        }
    
        cargarRespuestas(id);
      } catch (error) {
        console.error(error);
        document.body.innerHTML = "<h2>‚ùå Error al cargar el formulario.</h2>";
      }
    });
    </script>
    

</body>

</html>