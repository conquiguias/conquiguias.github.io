<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Formulario</title>
</head>

<body>
  <img src="logo1.png" style="width: 25%;" alt="">
  <h2 id="tituloFormulario">Cargando...</h2>
  <p id="contador"></p>

  <form id="formulario" style="display: none;">
    <input type="hidden" name="id" id="idFormulario">

    <label>Nombre:</label><br>
    <input type="text" name="nombre" required><br><br>

    <label>Correo: (Opcional)</label><br>
    <input type="email" name="correo"><br><br>

    <label>Edad: (Opcional)</label><br>
    <input type="number" name="edad"><br><br>

    <label>Tel√©fono:</label><br>
    <input type="tel" name="telefono" required><br><br>

    <label>Asociaci√≥n o campo:</label><br>
    <input type="text" name="asociacion" required><br><br>

    <button type="submit">Enviar</button>
  </form>
<!-- Botones din√°micos para asistencias -->
<div id="botonesAsistencia" style="margin-top: 20px; display: none;">
  <button id="btnPrimera" style="display:none;">Primera Asistencia</button>
  <button id="btnSegunda" style="display:none;">Segunda Asistencia</button>
  <button id="btnTercera" style="display:none;">Tercer Asistencia</button>
</div>

  <p id="mensaje"></p>

  <h3>üìä Respuestas registradas | Se actualiza cada 5 minutos.</h3><p id="contadorRecarga">üîÑ Pr√≥xima recarga en: <span id="segundos">300</span> segundos</p>

  <p>Informaci√≥n exclusiva para instructores y directores. Su informaci√≥n es borrada despu√©s de 90 d√≠as</p>
  <table border="1" id="tablaRespuestas" style="border-collapse: collapse; width: 100%;">
    <thead>
      <tr>
        <th>#</th>
        <th>Nombre</th>
        <th>Correo</th>
        <th>Edad</th>
        <th>Tel√©fono</th>
        <th>Asociaci√≥n</th>
        <th>Fecha</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>


  document.addEventListener("DOMContentLoaded", async () => {
    const params = new URLSearchParams(location.search);
    const id = params.get("id");
  
    // Clave para progreso del usuario en este formulario
    const claveProgreso = `progreso_${id}`;
    let progreso = JSON.parse(localStorage.getItem(claveProgreso)) || {
      asistencias: [false, false, false] // Primera, segunda, tercera
    };
  
    // Mostrar botones seg√∫n progreso
    const btnPrimera = document.getElementById("btnPrimera");
    const btnSegunda = document.getElementById("btnSegunda");
    const btnTercera = document.getElementById("btnTercera");
    const botonesDiv = document.getElementById("botonesAsistencia");
  
    botonesDiv.style.display = "block";
  
    if (!progreso.asistencias[0]) btnPrimera.style.display = "inline-block";
    else if (!progreso.asistencias[1]) btnSegunda.style.display = "inline-block";
    else if (!progreso.asistencias[2]) btnTercera.style.display = "inline-block";
  
    // Funci√≥n para registrar asistencia
    async function registrarAsistencia(numero) {
      const datos = {
        id,
        visitanteId,
        numeroAsistencia: numero,
        asistio: "S√≠",
        fecha: new Date().toISOString()
      };
  
      // Guardar en backend
      try {
        const res = await fetch("/api/guardarAsistencia", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(datos)
        });
  
        if (res.ok) {
          alert(`‚úÖ Asistencia ${numero} registrada correctamente`);
          progreso.asistencias[numero - 1] = true;
          localStorage.setItem(claveProgreso, JSON.stringify(progreso));
          actualizarTabla();
          // Ocultar bot√≥n usado
          if (numero === 1) btnPrimera.style.display = "none";
          if (numero === 2) btnSegunda.style.display = "none";
          if (numero === 3) btnTercera.style.display = "none";
        } else {
          alert("‚ùå Error al registrar asistencia");
        }
      } catch (e) {
        console.error(e);
        alert("‚ö†Ô∏è Error de conexi√≥n");
      }
    }
  
    btnPrimera.addEventListener("click", () => registrarAsistencia(1));
    btnSegunda.addEventListener("click", () => registrarAsistencia(2));
    btnTercera.addEventListener("click", () => registrarAsistencia(3));
  
    // Funci√≥n para cargar tabla con asistencias y examen
    async function actualizarTabla() {
      const tablaBody = document.querySelector("#tablaRespuestas tbody");
      tablaBody.innerHTML = "<tr><td colspan='9'>Cargando...</td></tr>";
  
      try {
        const res = await fetch(`/api/verRespuestas?id=${encodeURIComponent(id)}`);
        if (!res.ok) {
          tablaBody.innerHTML = "<tr><td colspan='9'>No hay respuestas a√∫n.</td></tr>";
          return;
        }
  
        const respuestas = await res.json();
        tablaBody.innerHTML = "";
  
        respuestas.forEach((r, i) => {
          const filasAsistencias = [1, 2, 3].map(n => {
            const asistio = r.asistencias?.[n - 1] ? "S√≠" : "No";
            return `
              <tr>
                <td>${i + 1}</td>
                <td>${r.nombre || "-"}</td>
                <td>${r.correo || "-"}</td>
                <td>${r.edad || "-"}</td>
                <td>${r.telefono || "-"}</td>
                <td>${r.asociacion || "-"}</td>
                <td>${n}</td>
                <td>${asistio}</td>
                <td>${r.asistencias?.every(a => a) ? `<button>Hacer examen</button>` : "No puede hacer examen"}</td>
              </tr>
            `;
          });
          tablaBody.insertAdjacentHTML("beforeend", filasAsistencias.join(""));
        });
  
      } catch (e) {
        console.error(e);
        tablaBody.innerHTML = "<tr><td colspan='9'>Error al cargar tabla</td></tr>";
      }
    }
  
    // Cargar tabla al inicio
    actualizarTabla();
  });
  
  
  

</body>

</html>