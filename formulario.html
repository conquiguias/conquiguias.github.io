<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Formulario</title>
</head>

<body>
  <img src="logo1.png" style="width: 25%;" alt="">
  <h2 id="tituloFormulario">Cargando...</h2>
  <p id="contador"></p>

  <!-- Formulario principal -->
  <form id="formulario" style="display: none;">
    <input type="hidden" name="id" id="idFormulario">

    <label>Nombre:</label><br>
    <input type="text" name="nombre" required><br><br>

    <label>Correo: (Opcional)</label><br>
    <input type="email" name="correo"><br><br>

    <label>Edad: (Opcional)</label><br>
    <input type="number" name="edad"><br><br>

    <label>Tel√©fono:</label><br>
    <input type="tel" name="telefono" required><br><br>

    <label>Asociaci√≥n o campo:</label><br>
    <input type="text" name="asociacion" required><br><br>

    <button type="submit">Enviar</button>
  </form>

  <p id="mensaje"></p>

  <!-- Botones de asistencias -->
  <div id="botonesAsistencia" style="margin-top: 20px; display: none;">
    <button id="btnPrimera">Primera Asistencia</button>
    <button id="btnSegunda" style="display:none;">Segunda Asistencia</button>
    <button id="btnTercera" style="display:none;">Tercera Asistencia</button>
  </div>

  <h3>üìä Respuestas registradas | Se actualiza cada 5 minutos.</h3>
  <p id="contadorRecarga">üîÑ Pr√≥xima recarga en: <span id="segundos">300</span> segundos</p>
  <p>Informaci√≥n exclusiva para instructores y directores. Su informaci√≥n es borrada despu√©s de 90 d√≠as</p>

  <!-- Tabla de respuestas -->
  <table border="1" id="tablaRespuestas" style="border-collapse: collapse; width: 100%;">
    <thead>
      <tr>
        <th>#</th>
        <th>Nombre</th>
        <th>Correo</th>
        <th>Edad</th>
        <th>Tel√©fono</th>
        <th>Asociaci√≥n</th>
        <th>N√∫mero Asistencia</th>
        <th>¬øAsisti√≥?</th>
        <th>Examen</th>
        <th>Fecha</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // Generador de UUID
    function generarUUID() {
      return crypto.randomUUID();
    }

    let visitanteId = localStorage.getItem("visitanteId");
    if (!visitanteId) {
      visitanteId = generarUUID();
      localStorage.setItem("visitanteId", visitanteId);
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(location.search);
      const id = params.get("id");
      if (!id) return;

      let registros = [];

      // Cargar formulario
      try {
        const res = await fetch(`/api/obtenerFormulario?id=${id}`);
        if (!res.ok) return;

        const data = await res.json();
        const fechaCierre = new Date(data.fechaCierre);
        const ahora = new Date();

        document.getElementById("tituloFormulario").textContent = data.titulo;
        document.getElementById("idFormulario").value = id;

        if (ahora < fechaCierre) {
          document.getElementById("formulario").style.display = "block";
        } else {
          document.getElementById("contador").textContent = `‚õî El formulario ha caducado.`;
        }

        // Contador
        const contadorEl = document.getElementById("contador");
        const actualizarContador = () => {
          const restante = fechaCierre - new Date();
          if (restante <= 0) {
            contadorEl.textContent = "‚õî El formulario ha caducado.";
            document.getElementById("formulario").style.display = "none";
            clearInterval(intervalo);
            return;
          }
          const minutos = Math.floor((restante / 1000 / 60) % 60);
          const segundos = Math.floor((restante / 1000) % 60);
          contadorEl.textContent = `‚è≥ El formulario se cerrar√° en: ${minutos}:${segundos.toString().padStart(2, "0")}`;
        };
        actualizarContador();
        const intervalo = setInterval(actualizarContador, 1000);

      } catch (error) {
        console.error(error);
      }

      // Funci√≥n para cargar respuestas
      async function cargarRespuestas() {
        const tablaBody = document.querySelector("#tablaRespuestas tbody");
        tablaBody.innerHTML = "<tr><td colspan='10'>Cargando respuestas...</td></tr>";

        try {
          const res = await fetch(`/api/verRespuestas?id=${id}`);
          registros = await res.json();

          if (!registros.length) {
            tablaBody.innerHTML = "<tr><td colspan='10'>No hay respuestas a√∫n.</td></tr>";
            return;
          }

          tablaBody.innerHTML = "";
          registros.forEach((r, index) => {
            const asistencias = r.asistencias || [];
            const filas = Math.max(asistencias.length, 3);
            for (let i = 0; i < filas; i++) {
              const numAsistencia = i + 1;
              const asistio = asistencias[i] ? "S√≠" : "No";
              let examen = "-";
              if (i === 2) {
                examen = asistencias.every(a => a) ? `<button onclick="alert('Hacer examen de ${r.nombre}')">Hacer Examen</button>` : "No puede hacer examen";
              }

              tablaBody.insertAdjacentHTML("beforeend", `
                <tr>
                  <td>${index + 1}</td>
                  <td>${r.nombre}</td>
                  <td>${r.correo || "-"}</td>
                  <td>${r.edad || "-"}</td>
                  <td>${r.telefono}</td>
                  <td>${r.asociacion}</td>
                  <td>${numAsistencia}</td>
                  <td>${asistio}</td>
                  <td>${examen}</td>
                  <td>${new Date(r.fecha).toLocaleString()}</td>
                </tr>
              `);
            }
          });

        } catch (error) {
          console.error(error);
          tablaBody.innerHTML = "<tr><td colspan='10'>Error al cargar respuestas.</td></tr>";
        }
      }

      await cargarRespuestas();

      // Botones de asistencia
      const btnPrimera = document.getElementById("btnPrimera");
      const btnSegunda = document.getElementById("btnSegunda");
      const btnTercera = document.getElementById("btnTercera");
      document.getElementById("botonesAsistencia").style.display = "block";

      const registroUsuario = registros.find(r => r.visitanteId === visitanteId);

      if (!registroUsuario) btnPrimera.style.display = "inline-block";
      else if (registroUsuario.asistencias[0] && !registroUsuario.asistencias[1]) btnSegunda.style.display = "inline-block";
      else if (registroUsuario.asistencias[1] && !registroUsuario.asistencias[2]) btnTercera.style.display = "inline-block";

      async function registrarAsistencia(num) {
        const datos = {
          id,
          visitanteId,
          numeroAsistencia: num,
          nombre: document.querySelector("input[name=nombre]").value,
          correo: document.querySelector("input[name=correo]").value,
          telefono: document.querySelector("input[name=telefono]").value,
          edad: document.querySelector("input[name=edad]").value,
          asociacion: document.querySelector("input[name=asociacion]").value
        };

        const res = await fetch("/api/guardar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(datos)
        });

        if (res.ok) {
          alert(`Asistencia #${num} registrada`);
          await cargarRespuestas();
          btnPrimera.style.display = "none";
          btnSegunda.style.display = "none";
          btnTercera.style.display = "none";
        } else {
          alert("Error al registrar asistencia");
        }
      }

      btnPrimera.addEventListener("click", () => registrarAsistencia(1));
      btnSegunda.addEventListener("click", () => registrarAsistencia(2));
      btnTercera.addEventListener("click", () => registrarAsistencia(3));

      // Recarga autom√°tica cada 5 minutos
      let segundosRestantes = 300;
      setInterval(() => {
        segundosRestantes--;
        document.getElementById("segundos").textContent = segundosRestantes;
        if (segundosRestantes <= 0) {
          cargarRespuestas();
          segundosRestantes = 300;
        }
      }, 1000);

    });

    // Guardar formulario
    document.getElementById("formulario").addEventListener("submit", async function (e) {
      e.preventDefault();
      const datos = Object.fromEntries(new FormData(this).entries());
      datos.visitanteId = visitanteId;

      const res = await fetch("/api/guardar", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(datos)
      });

      const mensaje = document.getElementById("mensaje");
      if (res.ok) {
        mensaje.textContent = "‚úÖ Tu asistencia ha sido registrada. ¬°Gracias!";
        this.reset();
        this.style.display = "none";
      } else {
        mensaje.textContent = "‚ùå Ocurri√≥ un error al guardar. Usuario ya registrado";
      }
    });
  </script>

</body>

</html>
