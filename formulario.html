<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Formulario</title>
</head>

<body>
  <img src="logo1.png" style="width: 25%;" alt="">
  <h2 id="tituloFormulario">Cargando...</h2>
  <p id="contador"></p>

  <form id="formulario" style="display: none;">
    <input type="hidden" name="id" id="idFormulario">

    <label>Nombre:</label><br>
    <input type="text" name="nombre" required><br><br>

    <label>Correo: (Opcional)</label><br>
    <input type="email" name="correo"><br><br>

    <label>Edad: (Opcional)</label><br>
    <input type="number" name="edad"><br><br>

    <label>Tel√©fono:</label><br>
    <input type="tel" name="telefono" required><br><br>

    <label>Asociaci√≥n o campo:</label><br>
    <input type="text" name="asociacion" required><br><br>

    <button type="submit">Enviar</button>
  </form>

  <p id="mensaje"></p>

  <h3>üìä Respuestas registradas | Se actualiza cada 5 minutos.</h3><p id="contadorRecarga">üîÑ Pr√≥xima recarga en: <span id="segundos">300</span> segundos</p>

  <p>Informaci√≥n exclusiva para instructores y directores. Su informaci√≥n es borrada despu√©s de 90 d√≠as</p>
  <table border="1" id="tablaRespuestas" style="border-collapse: collapse; width: 100%;">
    <thead>
      <tr>
        <th>#</th>
        <th>Nombre</th>
        <th>Correo</th>
        <th>Edad</th>
        <th>Tel√©fono</th>
        <th>Asociaci√≥n</th>
        <th>Fecha</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>


  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("formRegistro");
      const registroContainer = document.getElementById("registro-container");
      const asistenciaContainer = document.getElementById("asistencia-container");
      const tabla = document.getElementById("tablaAsistencias");
      const tbody = tabla.querySelector("tbody");
    
      let usuario = JSON.parse(localStorage.getItem("asistencia_usuario")) || null;
    
      // Funci√≥n para mostrar cron√≥metro visible
      function iniciarCronometro(duracionSegundos, onFinalizar, mostrar) {
        let restante = duracionSegundos;
        mostrar.textContent = `‚è± Tiempo restante: ${Math.floor(restante / 60)}:${(restante % 60).toString().padStart(2, "0")}`;
    
        const interval = setInterval(() => {
          restante--;
          const min = Math.floor(restante / 60);
          const seg = (restante % 60).toString().padStart(2, "0");
          mostrar.textContent = `‚è± Tiempo restante: ${min}:${seg}`;
    
          if (restante <= 0) {
            clearInterval(interval);
            onFinalizar();
          }
        }, 1000);
      }
    
      // Primera vez: mostrar formulario
      if (!usuario) {
        registroContainer.style.display = "block";
      } else {
        manejarAsistencia(usuario);
      }
    
      // === REGISTRO PRIMERA ASISTENCIA ===
      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const nombre = form.nombre.value.trim();
        const email = form.email.value.trim();
    
        try {
          const res = await fetch("/api/guardar", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: "especialidad", nombre, correo: email }),
          });
    
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Error al guardar");
    
          alert(data.message);
    
          usuario = {
            nombre,
            email,
            asistenciaNumero: data.numeroAsistencia,
            asistencias: [true],
            ultimaAsistencia: Date.now(),
          };
          localStorage.setItem("asistencia_usuario", JSON.stringify(usuario));
    
          registroContainer.style.display = "none";
          manejarAsistencia(usuario);
        } catch (err) {
          alert("‚ùå Error al registrar asistencia: " + err.message);
        }
      });
    
      // === CONTROL DE ASISTENCIAS SIGUIENTES ===
      function manejarAsistencia(usuario) {
        asistenciaContainer.innerHTML = "";
        asistenciaContainer.style.display = "block";
    
        let numero = usuario.asistenciaNumero + 1;
        if (numero > 3) return mostrarTablaFinal(usuario);
    
        let texto = numero === 2 ? "Segunda Asistencia" : numero === 3 ? "Tercer Asistencia" : "Completado";
    
        const bloque = document.createElement("div");
        bloque.innerHTML = `
          <h3>${texto}</h3>
          <p id="mensajeTiempo"></p>
          <button id="btnAsistencia" disabled>Registrar ${texto}</button>
        `;
        asistenciaContainer.appendChild(bloque);
    
        const btn = bloque.querySelector("#btnAsistencia");
        const mostrar = bloque.querySelector("#mensajeTiempo");
    
        // Duraciones espec√≠ficas
        let duracionEspera, duracionActivo;
        if (numero === 2) {
          duracionEspera = 30 * 60; // 30 min para habilitar
          duracionActivo = 30 * 60; // 30 min para registrar
        } else if (numero === 3) {
          duracionEspera = 10 * 60; // 10 min para habilitar
          duracionActivo = 10 * 60; // 10 min para registrar
        }
    
        mostrar.textContent = "‚è≥ Espera el inicio de la siguiente asistencia...";
        iniciarCronometro(duracionEspera, () => {
          btn.disabled = false;
          mostrar.textContent = `üü¢ ${texto} disponible por ${duracionActivo / 60} minutos`;
          iniciarCronometro(duracionActivo, () => {
            btn.disabled = true;
            mostrar.textContent = `‚õî Tiempo de ${texto} finalizado.`;
            mostrarTablaFinal(usuario);
          }, mostrar);
        }, mostrar);
    
        btn.addEventListener("click", async () => {
          try {
            const res = await fetch("/api/guardar", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ id: "especialidad", nombre: usuario.nombre, correo: usuario.email }),
            });
    
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || "Error al guardar");
    
            alert(`‚úÖ ${texto} registrada correctamente`);
    
            usuario.asistenciaNumero = numero;
            usuario.asistencias.push(true);
            usuario.ultimaAsistencia = Date.now();
            localStorage.setItem("asistencia_usuario", JSON.stringify(usuario));
    
            manejarAsistencia(usuario);
          } catch (err) {
            alert("‚ùå Error al registrar asistencia: " + err.message);
          }
        });
      }
    
      // === TABLA FINAL ===
      function mostrarTablaFinal(usuario) {
        asistenciaContainer.style.display = "none";
        tabla.style.display = "table";
        tbody.innerHTML = "";
    
        const asistioTodas = usuario.asistencias.length === 3;
        const fila = `
          <tr>
            <td>${usuario.nombre}</td>
            <td>${usuario.email}</td>
            <td>${usuario.asistenciaNumero}</td>
            <td>${asistioTodas ? "S√≠" : "No"}</td>
            <td>${
              asistioTodas
                ? `<button id="btnExamen">Hacer Examen</button>`
                : "No puede hacer examen"
            }</td>
          </tr>
        `;
        tbody.insertAdjacentHTML("beforeend", fila);
    
        if (asistioTodas) {
          document.getElementById("btnExamen").addEventListener("click", () => {
            document.getElementById("examen-container").style.display = "block";
            window.scrollTo(0, document.body.scrollHeight);
          });
        }
      }
    });
    </script>
    

</body>

</html>