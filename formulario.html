<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Formulario de Asistencias</title>
</head>
<body>
<img src="logo1.png" style="width:25%;" alt="">
<h2 id="tituloFormulario">Cargando...</h2>

<!-- Formulario primera asistencia -->
<form id="formulario" style="display:none;">
<input type="hidden" name="id" id="idFormulario">
<label>Nombre:</label><br>
<input type="text" name="nombre" required><br><br>
<label>Correo: (Opcional)</label><br>
<input type="email" name="correo"><br><br>
<label>Edad: (Opcional)</label><br>
<input type="number" name="edad"><br><br>
<label>TelÃ©fono:</label><br>
<input type="tel" name="telefono" required><br><br>
<label>AsociaciÃ³n o campo:</label><br>
<input type="text" name="asociacion" required><br><br>
<button type="submit">Registrar Primera Asistencia</button>
</form>

<!-- Botones segunda y tercera asistencia -->
<div id="botonesAsistencia" style="margin-top:20px; display:none;">
<button id="btnSegunda" disabled>Registrar Segunda Asistencia (<span id="contadorSegunda">--:--</span>)</button>
<button id="btnTercera" disabled>Registrar Tercera Asistencia (<span id="contadorTercera">--:--</span>)</button>
</div>

<p id="mensaje"></p>

<h3>ðŸ“Š Respuestas registradas | Se actualiza cada 5 minutos.</h3>
<p id="contadorRecarga">ðŸ”„ PrÃ³xima recarga en: <span id="segundos">300</span> segundos</p>

<table border="1" id="tablaRespuestas" style="border-collapse: collapse; width:100%;">
<thead>
<tr>
<th>#</th>
<th>Nombre</th>
<th>Correo</th>
<th>Edad</th>
<th>TelÃ©fono</th>
<th>AsociaciÃ³n</th>
<th>NÃºmero Asistencia</th>
<th>Â¿AsistiÃ³?</th>
<th>Examen</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const DURACION_ASISTENCIAS = [30,30,10]; // minutos
let visitanteId = localStorage.getItem("visitanteId");
if (!visitanteId) { visitanteId = crypto.randomUUID(); localStorage.setItem("visitanteId", visitanteId); }

document.addEventListener("DOMContentLoaded", async ()=>{
const params = new URLSearchParams(location.search);
const id = params.get("id");
if(!id) return;

const tituloEl = document.getElementById("tituloFormulario");
const contadorEl = document.getElementById("contador");
const formulario = document.getElementById("formulario");
const btnSegunda = document.getElementById("btnSegunda");
const btnTercera = document.getElementById("btnTercera");
const contadorSegunda = document.getElementById("contadorSegunda");
const contadorTercera = document.getElementById("contadorTercera");
const botonesDiv = document.getElementById("botonesAsistencia");
const mensaje = document.getElementById("mensaje");
const tablaBody = document.querySelector("#tablaRespuestas tbody");

let fechaInicio, fechaFinAsistencias;

try{
const res = await fetch(`/api/obtenerFormulario?id=${id}`);
const data = await res.json();
tituloEl.textContent = data.titulo;
formulario.idFormulario.value = id;
fechaInicio = new Date(data.fechaInicio);
let acumulado=0;
fechaFinAsistencias = DURACION_ASISTENCIAS.map(min=>{
acumulado+=min;
return new Date(fechaInicio.getTime()+acumulado*60*1000);
});
} catch(e){console.error(e); tituloEl.textContent="âŒ Error al cargar formulario"; return;}

async function cargarRespuestas(){
try{
const res = await fetch(`/api/verRespuestas?id=${id}`);
const respuestas = await res.json();
tablaBody.innerHTML="";
respuestas.forEach((r,index)=>{
r.asistencias = r.asistencias || [false,false,false];
let examen = (r.asistencias.every(a=>a))?`<button onclick="alert('Hacer examen de ${r.nombre}')">Hacer Examen</button>`:"No puede hacer examen";
r.asistencias.forEach((asistio,num)=>{
tablaBody.insertAdjacentHTML("beforeend",`
<tr>
<td>${index+1}</td>
<td>${r.nombre}</td>
<td>${r.correo||"-"}</td>
<td>${r.edad||"-"}</td>
<td>${r.telefono||"-"}</td>
<td>${r.asociacion}</td>
<td>${num+1}</td>
<td>${asistio?"SÃ­":"No"}</td>
<td>${num===2?examen:"-"}</td>
</tr>
`);
});
});
}catch(e){console.error(e);}
}
await cargarRespuestas();

// mostrar botones y formulario segÃºn asistencia y tiempo
async function actualizarBotones(){
const resUsuarios = await fetch(`/api/verRespuestas?id=${id}`);
const registros = await resUsuarios.json();
let registroUsuario = registros.find(r=>r.visitanteId===visitanteId);
const ahora = new Date();
botonesDiv.style.display="block";

if(!registroUsuario && ahora<fechaFinAsistencias[0]){
formulario.style.display="block"; btnSegunda.disabled=true; btnTercera.disabled=true;
}else{
formulario.style.display="none";
if(registroUsuario && registroUsuario.asistencias[0] && ahora<fechaFinAsistencias[1]){
btnSegunda.disabled=false;
}else{btnSegunda.disabled=true;}
if(registroUsuario && registroUsuario.asistencias[1] && ahora<fechaFinAsistencias[2]){
btnTercera.disabled=false;
}else{btnTercera.disabled=true;}
}
}

// cronÃ³metro global y botones
setInterval(()=>{
const ahora = new Date();
let texto="";
if(ahora<fechaFinAsistencias[0]) texto=`â³ Primera asistencia activa (${Math.floor((fechaFinAsistencias[0]-ahora)/60000)}:${Math.floor((fechaFinAsistencias[0]-ahora)/1000%60).toString().padStart(2,'0')})`;
else if(ahora<fechaFinAsistencias[1]) texto=`â³ Segunda asistencia activa (${Math.floor((fechaFinAsistencias[1]-ahora)/60000)}:${Math.floor((fechaFinAsistencias[1]-ahora)/1000%60).toString().padStart(2,'0')})`;
else if(ahora<fechaFinAsistencias[2]) texto=`â³ Tercera asistencia activa (${Math.floor((fechaFinAsistencias[2]-ahora)/60000)}:${Math.floor((fechaFinAsistencias[2]-ahora)/1000%60).toString().padStart(2,'0')})`;
else texto="â›” Todas las asistencias han finalizado";
contadorEl.textContent=texto;

// contar individualmente botones
contadorSegunda.textContent = (ahora<fechaFinAsistencias[1])?`${Math.floor((fechaFinAsistencias[1]-ahora)/60000)}:${Math.floor((fechaFinAsistencias[1]-ahora)/1000%60).toString().padStart(2,'0')}`:"--:--";
contadorTercera.textContent = (ahora<fechaFinAsistencias[2])?`${Math.floor((fechaFinAsistencias[2]-ahora)/60000)}:${Math.floor((fechaFinAsistencias[2]-ahora)/1000%60).toString().padStart(2,'0')}`:"--:--";

actualizarBotones();
},1000);

// primera asistencia
formulario.addEventListener("submit", async e=>{
e.preventDefault();
const datos = Object.fromEntries(new FormData(formulario).entries());
datos.visitanteId = visitanteId;
datos.numeroAsistencia = 1;
datos.asistencias=[true,false,false];
const res = await fetch("/api/guardar",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(datos)});
if(res.ok){mensaje.textContent="âœ… Primera asistencia registrada"; formulario.style.display="none"; await cargarRespuestas();}
});

// segunda asistencia
btnSegunda.addEventListener("click", async ()=>{
const res = await fetch("/api/guardar",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id,visitanteId,numeroAsistencia:2,asistencias:[true]} )});
if(res.ok){mensaje.textContent="âœ… Segunda asistencia registrada"; btnSegunda.disabled=true; btnTercera.disabled=false; await cargarRespuestas();}
});

// tercera asistencia
btnTercera.addEventListener("click", async ()=>{
const res = await fetch("/api/guardar",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id,visitanteId,numeroAsistencia:3,asistencias:[true]} )});
if(res.ok){mensaje.textContent="âœ… Tercera asistencia registrada"; btnTercera.disabled=true; await cargarRespuestas();}
});

// auto marcar no asistiÃ³ si tiempo terminÃ³
setInterval(async ()=>{
const resUsuarios = await fetch(`/api/verRespuestas?id=${id}`);
const registros = await resUsuarios.json();
let registroUsuario = registros.find(r=>r.visitanteId===visitanteId);
if(!registroUsuario) return;
const ahora = new Date();
for(let i=0;i<3;i++){
if(!registroUsuario.asistencias[i] && ahora>fechaFinAsistencias[i]){
await fetch("/api/guardar",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({id,visitanteId,numeroAsistencia:i+1,asistencias:[false]})});
await cargarRespuestas();
}
}
},10000);

});
</script>
</body>
</html>
