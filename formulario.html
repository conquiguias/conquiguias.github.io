<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Formulario de Asistencia</title>
</head>
<body>
  <img src="logo1.png" style="width: 25%;" alt="">
<h2 id="tituloFormulario">Cargando...</h2>
<p id="contador"></p>

<form id="formulario" style="display: none;">
  <input type="hidden" name="id" id="idFormulario">

  <label>Nombre:</label><br>
  <input type="text" name="nombre" required><br><br>

  <label>Correo:</label><br>
  <input type="email" name="correo" required><br><br>

  <label>Tel√©fono:</label><br>
  <input type="tel" name="telefono" required><br><br>

  <label>Asociaci√≥n o campo:</label><br>
  <input type="text" name="asociacion" required><br><br>

  <button type="submit">Registrar Primera Asistencia</button>
</form>

<div id="botonesAsistencia" style="margin-top:20px; display:none;">
  <button id="btnSegunda" style="display:none;">Registrar Segunda Asistencia</button>
  <button id="btnTercera" style="display:none;">Registrar Tercera Asistencia</button>
</div>

<p id="mensaje"></p>

<h3>üìä Respuestas registradas | Se actualiza cada 5 minutos.</h3>
<p id="contadorRecarga">üîÑ Pr√≥xima recarga en: <span id="segundos">300</span> segundos</p>

<p>Informaci√≥n exclusiva para instructores y directores. Su informaci√≥n es borrada despu√©s de 90 d√≠as.</p>
<table border="1" id="tablaRespuestas" style="border-collapse: collapse; width: 100%;">
  <thead>
    <tr>
      <th>#</th>
      <th>Nombre</th>
      <th>Correo</th>
      <th>Tel√©fono</th>
      <th>Asociaci√≥n</th>
      <th>N√∫mero Asistencia</th>
      <th>¬øAsisti√≥?</th>
      <th>Fecha</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
document.addEventListener("DOMContentLoaded", async () => {
  const params = new URLSearchParams(location.search);
  const id = params.get("id");
  if (!id) return alert("‚ùå Falta el par√°metro id en la URL.");

  document.getElementById("idFormulario").value = id;

  const form = document.getElementById("formulario");
  const botonesDiv = document.getElementById("botonesAsistencia");
  const btn2 = document.getElementById("btnSegunda");
  const btn3 = document.getElementById("btnTercera");
  const mensaje = document.getElementById("mensaje");
  const tablaBody = document.querySelector("#tablaRespuestas tbody");

  let usuario = JSON.parse(localStorage.getItem("asistenciaUsuario_" + id)) || null;
  let tiempoGuardado = JSON.parse(localStorage.getItem("asistenciaTiempo_" + id)) || null;

  if (usuario) {
    form.style.display = "none";
    mostrarEstado(usuario);
  } else {
    form.style.display = "block";
  }

  // === Registro de la primera asistencia ===
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const datos = Object.fromEntries(new FormData(form).entries());

    const res = await fetch("/api/guardar", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ ...datos, id })
    });

    const data = await res.json();
    if (!res.ok) return alert(data.error || "‚ùå Error al guardar.");

    alert(data.message);
    localStorage.setItem("correoUsuario", datos.correo);

    const nuevoUsuario = {
      nombre: datos.nombre,
      correo: datos.correo,
      telefono: datos.telefono,
      asociacion: datos.asociacion,
      asistenciaNumero: 1
    };

    localStorage.setItem("asistenciaUsuario_" + id, JSON.stringify(nuevoUsuario));
    localStorage.setItem("asistenciaTiempo_" + id, JSON.stringify({ ultima: Date.now() }));

    form.style.display = "none";
    mostrarEstado(nuevoUsuario);
  });

  // === Muestra botones y cron√≥metros seg√∫n progreso ===
  function mostrarEstado(usuario) {
    botonesDiv.style.display = "block";
    actualizarTabla();

    const tiempo = JSON.parse(localStorage.getItem("asistenciaTiempo_" + id));
    const diffMin = tiempo ? Math.floor((Date.now() - tiempo.ultima) / 60000) : 0;

    if (usuario.asistenciaNumero === 1) {
      if (diffMin < 30) {
        const restante = 30 - diffMin;
        mensaje.textContent = `‚è≥ Espera ${restante} minutos para registrar la segunda asistencia.`;
      } else {
        btn2.style.display = "inline-block";
      }
    } else if (usuario.asistenciaNumero === 2) {
      if (diffMin < 30) {
        const restante = 30 - diffMin;
        mensaje.textContent = `‚è≥ Espera ${restante} minutos para registrar la tercera asistencia.`;
      } else {
        btn3.style.display = "inline-block";
      }
    } else if (usuario.asistenciaNumero >= 3) {
      mensaje.textContent = "‚úÖ Has completado las 3 asistencias.";
    }
  }

  async function registrarAsistencia(num) {
    const usuario = JSON.parse(localStorage.getItem("asistenciaUsuario_" + id));
    const res = await fetch("/api/guardar", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ ...usuario, id })
    });
    const data = await res.json();
    if (!res.ok) return alert(data.error || "‚ùå Error al guardar.");

    alert(data.message);
    usuario.asistenciaNumero = num;
    localStorage.setItem("asistenciaUsuario_" + id, JSON.stringify(usuario));
    localStorage.setItem("asistenciaTiempo_" + id, JSON.stringify({ ultima: Date.now() }));
    btn2.style.display = "none";
    btn3.style.display = "none";
    mensaje.textContent = `‚úÖ ${num === 2 ? "Segunda" : "Tercera"} asistencia registrada correctamente.`;
    actualizarTabla();
  }

  btn2.addEventListener("click", () => registrarAsistencia(2));
  btn3.addEventListener("click", () => registrarAsistencia(3));

  // === Actualizar tabla ===
  async function actualizarTabla() {
    const correo = localStorage.getItem("correoUsuario");
    if (!correo) return;
    tablaBody.innerHTML = "<tr><td colspan='8'>Cargando...</td></tr>";

    const res = await fetch(`/api/leer?id=${id}&correo=${encodeURIComponent(correo)}`);
    const data = await res.json();

    if (!data.success || !data.asistencias.length) {
      tablaBody.innerHTML = "<tr><td colspan='8'>Sin registros a√∫n.</td></tr>";
      return;
    }

    tablaBody.innerHTML = "";
    data.asistencias.forEach((a, i) => {
      tablaBody.insertAdjacentHTML("beforeend", `
        <tr>
          <td>${i + 1}</td>
          <td>${a.nombre}</td>
          <td>${a.correo}</td>
          <td>${a.telefono}</td>
          <td>${a.asociacion}</td>
          <td>${a.numeroAsistencia}</td>
          <td>${a.asistio}</td>
          <td>${new Date(a.fecha).toLocaleString()}</td>
        </tr>
      `);
    });
  }

  // üîÅ Recarga autom√°tica de tabla cada 5 minutos
  let segundos = 300;
  setInterval(() => {
    segundos--;
    document.getElementById("segundos").textContent = segundos;
    if (segundos <= 0) {
      actualizarTabla();
      segundos = 300;
    }
  }, 1000);
});
</script>

    
    
    
    
</body>
</html>
