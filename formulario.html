<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Formulario de Asistencias</title>
</head>
<body>

<img src="logo1.png" style="width:25%;" alt="">
<h2 id="tituloFormulario">Cargando...</h2>
<p id="contador"></p>

<!-- Formulario de datos personales -->
<form id="formulario" style="display:none;">
  <input type="hidden" name="id" id="idFormulario">
  <label>Nombre:</label><br>
  <input type="text" name="nombre" required><br><br>

  <label>Correo (opcional):</label><br>
  <input type="email" name="correo"><br><br>

  <label>Edad (opcional):</label><br>
  <input type="number" name="edad"><br><br>

  <label>TelÃ©fono:</label><br>
  <input type="tel" name="telefono" required><br><br>

  <label>AsociaciÃ³n:</label><br>
  <input type="text" name="asociacion" required><br><br>

  <button type="submit">Registrar Primera Asistencia</button>
</form>

<!-- Botones para segunda y tercera asistencia -->
<div id="botonesAsistencia" style="margin-top:20px; display:none;">
  <button id="btnSegunda" disabled>Registrar Segunda Asistencia (<span id="timerSegunda">30:00</span>)</button>
  <button id="btnTercera" disabled>Registrar Tercera Asistencia (<span id="timerTercera">10:00</span>)</button>
</div>

<p id="mensaje"></p>

<h3>ðŸ“Š Respuestas registradas | Se actualiza cada 5 minutos.</h3>
<p id="contadorRecarga">ðŸ”„ PrÃ³xima recarga en: <span id="segundos">300</span> segundos</p>

<table border="1" id="tablaRespuestas" style="border-collapse:collapse; width:100%;">
<thead>
<tr>
  <th>#</th>
  <th>Nombre</th>
  <th>Correo</th>
  <th>Edad</th>
  <th>TelÃ©fono</th>
  <th>AsociaciÃ³n</th>
  <th>NÃºmero de Asistencia</th>
  <th>Â¿AsistiÃ³?</th>
  <th>Examen</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
const visitanteId = localStorage.getItem("visitanteId") || crypto.randomUUID();
if (!localStorage.getItem("visitanteId")) localStorage.setItem("visitanteId", visitanteId);

document.addEventListener("DOMContentLoaded", async () => {
  const params = new URLSearchParams(location.search);
  const idFormulario = params.get("id");
  if (!idFormulario) return;

  const tituloEl = document.getElementById("tituloFormulario");
  const contadorEl = document.getElementById("contador");
  const formularioEl = document.getElementById("formulario");
  const btnSegunda = document.getElementById("btnSegunda");
  const btnTercera = document.getElementById("btnTercera");
  const botonesDiv = document.getElementById("botonesAsistencia");
  const timerSegunda = document.getElementById("timerSegunda");
  const timerTercera = document.getElementById("timerTercera");

  tituloEl.textContent = "Cargando...";

  const resForm = await fetch(`/api/obtenerFormulario?id=${idFormulario}`);
  if (!resForm.ok) { tituloEl.textContent = "Formulario no encontrado"; return; }
  const formData = await resForm.json();
  tituloEl.textContent = formData.titulo;

  // Obtener registros actuales
  let registros = [];
  async function cargarRespuestas() {
    const res = await fetch(`/api/verRespuestas?id=${idFormulario}`);
    registros = res.ok ? await res.json() : [];
    const tbody = document.querySelector("#tablaRespuestas tbody");
    tbody.innerHTML = "";

    registros.forEach((r,index)=>{
      for(let i=0;i<3;i++){
        const asistio = r.asistencias?.[i]?.registrado || false;
        let examen="-";
        if(i===2){
          examen = r.asistencias?.every(a=>a?.registrado)? 
            `<button onclick="alert('Hacer examen de ${r.nombre}')">Hacer examen</button>` : "No puede hacer examen";
        }
        tbody.insertAdjacentHTML("beforeend",`
          <tr>
            <td>${index+1}</td>
            <td>${r.nombre}</td>
            <td>${r.correo||"-"}</td>
            <td>${r.edad||"-"}</td>
            <td>${r.telefono}</td>
            <td>${r.asociacion}</td>
            <td>${i+1}</td>
            <td>${asistio?"SÃ­":"No"}</td>
            <td>${i===2?examen:"-"}</td>
          </tr>
        `);
      }
    });
  }

  await cargarRespuestas();

  const registroUsuario = registros.find(r=>r.visitanteId===visitanteId);

  // Mostrar interfaz segÃºn estado
  if(!registroUsuario){
    formularioEl.style.display="block";
    botonesDiv.style.display="none";
  } else {
    formularioEl.style.display="none";
    botonesDiv.style.display="block";
    // Revisar temporizadores segÃºn asistencias previas
    if(registroUsuario.asistencias?.[0]?.registrado && !registroUsuario.asistencias[1]){
      startTimer(30*60, timerSegunda, ()=> btnSegunda.disabled=false);
    }
    if(registroUsuario.asistencias?.[1]?.registrado && !registroUsuario.asistencias[2]){
      startTimer(10*60, timerTercera, ()=> btnTercera.disabled=false);
    }
  }

  // FunciÃ³n de temporizador visual
  function startTimer(segundos, displayEl, callback){
    displayEl.parentElement.querySelector("button").disabled=true;
    let s = segundos;
    const interval = setInterval(()=>{
      const min = Math.floor(s/60).toString().padStart(2,"0");
      const sec = (s%60).toString().padStart(2,"0");
      displayEl.textContent = `${min}:${sec}`;
      s--;
      if(s<0){ clearInterval(interval); callback(); }
    },1000);
  }

  // Submit primera asistencia
  formularioEl.addEventListener("submit", async e=>{
    e.preventDefault();
    const datos = Object.fromEntries(new FormData(formularioEl).entries());
    datos.visitanteId=visitanteId;
    datos.numeroAsistencia=1;
    const res = await fetch("/api/guardar",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(datos)});
    if(res.ok){
      document.getElementById("mensaje").textContent="âœ… Primera asistencia registrada";
      formularioEl.style.display="none";
      botonesDiv.style.display="block";
      startTimer(30*60, timerSegunda, ()=> btnSegunda.disabled=false);
      await cargarRespuestas();
    }
  });

  // Segunda asistencia
  btnSegunda.addEventListener("click", async ()=>{
    btnSegunda.disabled=true;
    const datos={visitanteId,numeroAsistencia:2,id:idFormulario};
    const res=await fetch("/api/guardar",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(datos)});
    if(res.ok){
      document.getElementById("mensaje").textContent="âœ… Segunda asistencia registrada";
      startTimer(10*60, timerTercera, ()=> btnTercera.disabled=false);
      await cargarRespuestas();
    }
  });

  // Tercera asistencia
  btnTercera.addEventListener("click", async ()=>{
    btnTercera.disabled=true;
    const datos={visitanteId,numeroAsistencia:3,id:idFormulario};
    const res=await fetch("/api/guardar",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(datos)});
    if(res.ok){
      document.getElementById("mensaje").textContent="âœ… Tercera asistencia registrada";
      await cargarRespuestas();
    }
  });

  // Refrescar tabla cada 5 minutos
  let segundosRestantes=300;
  setInterval(async ()=>{
    segundosRestantes--;
    document.getElementById("segundos").textContent=segundosRestantes;
    if(segundosRestantes<=0){
      await cargarRespuestas();
      segundosRestantes=300;
    }
  },1000);

});
</script>

</body>
</html>
