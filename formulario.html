<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Formulario</title>
  <style>
    /* Estilos generales */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: #f5f7fa;
      color: #333;
      line-height: 1.6;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    /* Encabezado y logo */
    img {
      display: block;
      margin: 0 auto 20px;
      max-width: 200px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    h2,
    h3 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 20px;
      font-weight: 600;
    }

    h2 {
      font-size: 28px;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
    }

    h3 {
      font-size: 22px;
      margin-top: 30px;
    }

    /* Contadores de asistencia */
    #contadores {
      background: white;
      border-radius: 10px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border-left: 5px solid #3498db;
    }

    #contadores p {
      font-size: 18px;
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
      background-color: #f8f9fa;
      transition: all 0.3s ease;
    }

    #contadores p:hover {
      background-color: #e9ecef;
      transform: translateX(5px);
    }

    #contadores span {
      font-weight: bold;
      color: #e74c3c;
      font-size: 20px;
    }

    /* Botones de asistencia */
    #botonesAsistencia {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin: 25px 0;
    }

    #botonesAsistencia button {
      padding: 12px 25px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      min-width: 220px;
    }

    #btnPrimeraAsistencia {
      background-color: #3498db;
      color: white;
    }

    #btnSegundaAsistencia {
      background-color: #2ecc71;
      color: white;
    }

    #btnTerceraAsistencia {
      background-color: #9b59b6;
      color: white;
    }

    #botonesAsistencia button:hover:not(:disabled) {
      transform: translateY(-3px);
      box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
    }

    #botonesAsistencia button:disabled {
      background-color: #95a5a6;
      cursor: not-allowed;
      opacity: 0.7;
      transform: none;
    }

    /* Formulario */
    #formulario {
      background: white;
      border-radius: 10px;
      padding: 25px;
      margin: 20px 0;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border-top: 5px solid #2ecc71;
    }

    #formulario label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2c3e50;
    }

    #formulario input {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 16px;
      transition: border 0.3s ease;
    }

    #formulario input:focus {
      border-color: #3498db;
      outline: none;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
    }

    #formulario button[type="submit"] {
      background-color: #2ecc71;
      color: white;
      border: none;
      padding: 12px 25px;
      font-size: 16px;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
    }

    #formulario button[type="submit"]:hover {
      background-color: #27ae60;
      transform: translateY(-2px);
    }

    /* Mensajes */
    #mensaje {
      padding: 15px;
      margin: 20px 0;
      border-radius: 8px;
      font-weight: 600;
      text-align: center;
      font-size: 16px;
    }

    #mensaje:not(:empty) {
      background-color: #e8f6f3;
      border-left: 5px solid #2ecc71;
    }

    /* Contador de recarga */
    #contadorRecarga {
      background-color: #34495e;
      color: white;
      padding: 10px 15px;
      border-radius: 6px;
      display: inline-block;
      margin: 10px 0;
      font-weight: 600;
    }

    #segundos {
      color: #f39c12;
      font-weight: bold;
    }

    /* Tabla de respuestas */
    #tablaRespuestas {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
      overflow: hidden;
    }

    #tablaRespuestas thead {
      background-color: #34495e;
      color: white;
    }

    #tablaRespuestas th {
      padding: 15px;
      text-align: left;
      font-weight: 600;
    }

    #tablaRespuestas tbody tr {
      border-bottom: 1px solid #ddd;
      transition: background-color 0.3s ease;
    }

    #tablaRespuestas tbody tr:nth-child(even) {
      background-color: #f8f9fa;
    }

    #tablaRespuestas tbody tr:hover {
      background-color: #e8f4fd;
    }

    #tablaRespuestas td {
      padding: 12px 15px;
    }

    #tablaRespuestas button {
      background-color: #3498db;
      color: white;
      border: none;
      padding: 8px 15px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    #tablaRespuestas button:hover {
      background-color: #2980b9;
      transform: translateY(-2px);
    }

    /* Informaci√≥n adicional */
    p:last-of-type {
      background-color: #fff9e6;
      padding: 15px;
      border-radius: 8px;
      border-left: 5px solid #f39c12;
      margin: 20px 0;
      font-style: italic;
    }

    /* Responsive */
    @media (max-width: 768px) {
      body {
        padding: 10px;
      }

      #botonesAsistencia {
        flex-direction: column;
        align-items: center;
      }

      #botonesAsistencia button {
        width: 100%;
      }

      #tablaRespuestas {
        display: block;
        overflow-x: auto;
      }

      #formulario {
        padding: 15px;
      }
    }

    /* Animaciones */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #contadores,
    #formulario,
    #tablaRespuestas {
      animation: fadeIn 0.5s ease;
    }

    /* Estados especiales */
    .tiempo-agotado {
      color: #e74c3c !important;
      text-decoration: line-through;
    }

    .asistencia-completada {
      color: #2ecc71 !important;
      font-weight: bold;
    }

    /* Estilos para el sistema de evaluaci√≥n */
    #examenModal {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .pregunta-examen {
      transition: all 0.3s ease;
    }

    .pregunta-examen:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }

    .pregunta-examen h3 {
      color: #2c3e50;
      font-size: 1.2em;
      line-height: 1.4;
    }

    .opciones label {
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .opciones label:hover {
      border-color: #3498db;
      background: #e8f4fd !important;
    }

    .opciones input[type="radio"]:checked+label {
      background: #d4edda !important;
      border-color: #28a745 !important;
      color: #155724;
    }

    #resultadoExamen {
      animation: fadeIn 0.5s ease;
    }

    /* Responsive para el modal de examen */
    @media (max-width: 768px) {
      #examenModal .modal-content {
        margin: 20px auto;
        padding: 20px;
        width: 95%;
      }

      .pregunta-examen {
        padding: 15px;
      }

      .pregunta-examen h3 {
        font-size: 1.1em;
      }
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* A√±adir al final del CSS existente */
    #resultadosModal .modal-content {
      animation: fadeIn 0.3s ease;
    }

    #contenidoResultados {
      line-height: 1.6;
    }

    #contenidoResultados div {
      transition: all 0.3s ease;
    }

    #contenidoResultados div:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    @media (max-width: 768px) {
      #resultadosModal .modal-content {
        margin: 20px auto;
        padding: 20px;
        width: 95%;
      }
    }
  </style>
</head>

<body>
  <img src="logo1.png" style="width: 25%;" alt="">
  <h2 id="tituloFormulario">Cargando...</h2>

  <!-- Contadores para cada asistencia -->
  <div id="contadores">
    <p id="contadorPrimera">‚è≥ Primera asistencia: <span id="tiempoPrimera">30:00</span></p>
    <p id="contadorSegunda" style="display: none;">‚è≥ Segunda asistencia: <span id="tiempoSegunda">30:00</span></p>
    <p id="contadorTercera" style="display: none;">‚è≥ Tercera asistencia: <span id="tiempoTercera">10:00</span></p>
  </div>

  <!-- Botones de asistencia -->
  <div id="botonesAsistencia">
    <button id="btnPrimeraAsistencia" style="display: none;">Registrar primera asistencia</button>
    <button id="btnSegundaAsistencia" style="display: none;" disabled>Registrar segunda asistencia</button>
    <button id="btnTerceraAsistencia" style="display: none;" disabled>Registrar tercera asistencia</button>
  </div>

  <form id="formulario" style="display: none;">
    <input type="hidden" name="id" id="idFormulario">

    <label>Nombre:</label><br>
    <input type="text" name="nombre" required><br><br>

    <label>Correo: (Opcional)</label><br>
    <input type="email" name="correo"><br><br>

    <label>Edad: (Opcional)</label><br>
    <input type="number" name="edad"><br><br>

    <label>Tel√©fono:</label><br>
    <input type="tel" name="telefono" required><br><br>

    <label>Asociaci√≥n o campo:</label><br>
    <input type="text" name="asociacion" required><br><br>

    <button type="submit">Enviar</button>
  </form>

  <p id="mensaje"></p>

  <h3>üìä Respuestas registradas | Se actualiza cada 5 minutos.</h3>
  <p id="contadorRecarga">üîÑ Pr√≥xima recarga en: <span id="segundos">300</span> segundos</p>

  <p>Informaci√≥n exclusiva para instructores y directores. Su informaci√≥n es borrada despu√©s de 90 d√≠as</p>
  <table border="1" id="tablaRespuestas" style="border-collapse: collapse; width: 100%;">
    <thead>
      <tr>
        <th>#</th>
        <th>Nombre</th>
        <th>Correo</th>
        <th>Edad</th>
        <th>Tel√©fono</th>
        <th>Asociaci√≥n</th>
        <th>Fecha</th>
        <th>N√∫mero de Asistencia</th>
        <th>¬øAsisti√≥?</th>
        <th>Evaluaci√≥n</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    function generarUUID() {
      return crypto.randomUUID();
    }

    let visitanteId = localStorage.getItem("visitanteId");
    if (!visitanteId) {
      visitanteId = generarUUID();
      localStorage.setItem("visitanteId", visitanteId);
    }

    // Variables para control de asistencias
    let primeraAsistenciaCompletada = false;
    let segundaAsistenciaCompletada = false;
    let terceraAsistenciaCompletada = false;
    let intervaloPrimera, intervaloSegunda, intervaloTercera;
    let fechaInicioFormulario;
    let fechaFinPrimera, fechaFinSegunda, fechaFinTercera;

    document.addEventListener("DOMContentLoaded", async () => {
      const params = new URLSearchParams(location.search);
      const id = params.get("id");

      if (!id) {
        document.body.innerHTML = "<h2>‚ùå Error: ID de formulario no especificado.</h2>";
        return;
      }

      try {
        // Mostrar loading
        document.getElementById("tituloFormulario").innerHTML = "Cargando... <div class='loading'></div>";

        const res = await fetch(`/api/obtenerFormulario?id=${id}`);
        if (!res.ok) {
          document.body.innerHTML = `<h2>‚ùå Formulario '${id}' no encontrado.</h2>`;
          return;
        }

        const data = await res.json();
        document.getElementById("tituloFormulario").textContent = data.titulo;
        document.getElementById("idFormulario").value = id;

        // Calcular tiempos basados en la fecha de cierre del formulario
        const fechaCierre = new Date(data.fechaCierre);
        fechaInicioFormulario = new Date(fechaCierre.getTime() - (70 * 60 * 1000)); // 70 minutos antes
        fechaFinPrimera = new Date(fechaInicioFormulario.getTime() + (30 * 60 * 1000)); // 30 minutos
        fechaFinSegunda = new Date(fechaInicioFormulario.getTime() + (60 * 60 * 1000)); // 60 minutos
        fechaFinTercera = new Date(fechaInicioFormulario.getTime() + (70 * 60 * 1000)); // 70 minutos

        // Verificar estado REAL de asistencias del usuario desde el backend
        await verificarEstadoRealAsistencias(id);

        // Iniciar sistema de asistencias basado en el estado REAL
        iniciarSistemaAsistencias();

        // Cargar respuestas y configurar recarga
        let segundosRestantes = 300;
        cargarRespuestas(id);
        setInterval(() => {
          segundosRestantes--;
          document.getElementById("segundos").textContent = segundosRestantes;
          if (segundosRestantes <= 0) {
            cargarRespuestas(id);
            segundosRestantes = 300;
          }
        }, 1000);

      } catch (error) {
        console.error(error);
        document.body.innerHTML = "<h2>‚ùå Error al cargar el formulario.</h2>";
      }
    });

    // Funci√≥n para verificar el estado REAL de asistencias del usuario desde la base de datos
    async function verificarEstadoRealAsistencias(idFormulario) {
      try {
        const res = await fetch(`/api/verRespuestas?id=${idFormulario}`);
        if (res.ok) {
          const data = await res.json();
          const respuestas = data.asistencias || [];

          // Buscar TODAS las respuestas de este usuario
          const misRespuestas = respuestas.filter(r => r.visitanteId === visitanteId);

          console.log("Respuestas encontradas para el usuario:", misRespuestas);

          // Resetear estados
          primeraAsistenciaCompletada = false;
          segundaAsistenciaCompletada = false;
          terceraAsistenciaCompletada = false;

          // Verificar asistencias basado en los registros reales
          misRespuestas.forEach(respuesta => {
            if (respuesta.asistenciaNumero === 1) {
              primeraAsistenciaCompletada = true;
              console.log("‚úÖ Primera asistencia encontrada");
            }
            if (respuesta.asistenciaNumero === 2) {
              segundaAsistenciaCompletada = true;
              console.log("‚úÖ Segunda asistencia encontrada");
            }
            if (respuesta.asistenciaNumero === 3) {
              terceraAsistenciaCompletada = true;
              console.log("‚úÖ Tercera asistencia encontrada");
            }
          });

          console.log("Estado REAL de asistencias:", {
            primera: primeraAsistenciaCompletada,
            segunda: segundaAsistenciaCompletada,
            tercera: terceraAsistenciaCompletada
          });
        }
      } catch (error) {
        console.error("Error al verificar asistencias:", error);
      }
    }

    // Sistema principal de asistencias - BASADO EN EL ESTADO REAL
    function iniciarSistemaAsistencias() {
      const ahora = new Date();

      // Verificar si el formulario ya expir√≥
      if (ahora > fechaFinTercera) {
        document.getElementById("mensaje").textContent = "‚õî El formulario ha caducado. No se pueden registrar m√°s asistencias.";
        mostrarEstadoFinal();
        return;
      }

      console.log("Iniciando sistema con estado:", {
        primera: primeraAsistenciaCompletada,
        segunda: segundaAsistenciaCompletada,
        tercera: terceraAsistenciaCompletada
      });

      // Determinar qu√© bot√≥n mostrar basado en el estado REAL del usuario
      if (terceraAsistenciaCompletada) {
        mostrarEstadoFinal();
      } else if (segundaAsistenciaCompletada) {
        configurarTerceraAsistencia();
      } else if (primeraAsistenciaCompletada) {
        configurarSegundaAsistencia();
      } else {
        configurarPrimeraAsistencia();
      }
    }

    function mostrarEstadoFinal() {
      if (terceraAsistenciaCompletada) {
        document.getElementById("mensaje").textContent = "‚úÖ ¬°Completaste todas las asistencias!";
      }
      // Ocultar todos los botones
      document.getElementById("btnPrimeraAsistencia").style.display = "none";
      document.getElementById("btnSegundaAsistencia").style.display = "none";
      document.getElementById("btnTerceraAsistencia").style.display = "none";
    }

    function configurarPrimeraAsistencia() {
      const ahora = new Date();

      // Si el tiempo de la primera asistencia ya pas√≥, mostrar mensaje
      if (ahora > fechaFinPrimera) {
        document.getElementById("contadorPrimera").textContent = "‚è∞ Tiempo agotado para primera asistencia";
        document.getElementById("contadorPrimera").style.display = "block";
        document.getElementById("mensaje").textContent = "‚ùå El tiempo para la primera asistencia ha expirado";
        return;
      }

      // Mostrar primer bot√≥n y contador
      document.getElementById("btnPrimeraAsistencia").style.display = "block";
      document.getElementById("contadorPrimera").style.display = "block";

      // Configurar contador regresivo
      actualizarContadorPrimera();
      intervaloPrimera = setInterval(actualizarContadorPrimera, 1000);

      document.getElementById("btnPrimeraAsistencia").addEventListener("click", () => {
        document.getElementById("formulario").style.display = "block";
        document.getElementById("btnPrimeraAsistencia").disabled = true;
      });
    }

    function actualizarContadorPrimera() {
      const ahora = new Date();
      const restante = fechaFinPrimera - ahora;

      if (restante <= 0) {
        clearInterval(intervaloPrimera);
        document.getElementById("contadorPrimera").textContent = "‚è∞ Tiempo agotado para primera asistencia";
        document.getElementById("btnPrimeraAsistencia").disabled = true;
        document.getElementById("mensaje").textContent = "‚ùå El tiempo para la primera asistencia ha expirado";
        return;
      }

      const minutos = Math.floor((restante / 1000 / 60) % 60);
      const segundos = Math.floor((restante / 1000) % 60);
      document.getElementById("tiempoPrimera").textContent =
        `${minutos}:${segundos.toString().padStart(2, "0")}`;
    }

    function configurarSegundaAsistencia() {
      const ahora = new Date();

      // Ocultar primera asistencia
      document.getElementById("contadorPrimera").style.display = "none";
      document.getElementById("btnPrimeraAsistencia").style.display = "none";

      // Si el tiempo de la segunda asistencia ya pas√≥, mostrar mensaje
      if (ahora > fechaFinSegunda) {
        document.getElementById("contadorSegunda").textContent = "‚è∞ Tiempo agotado para segunda asistencia";
        document.getElementById("contadorSegunda").style.display = "block";
        document.getElementById("mensaje").textContent = "‚ùå El tiempo para la segunda asistencia ha expirado";
        return;
      }

      // Mostrar segunda asistencia
      document.getElementById("btnSegundaAsistencia").style.display = "block";
      document.getElementById("contadorSegunda").style.display = "block";

      // Solo activar el bot√≥n si ya pas√≥ el tiempo de la primera asistencia
      if (ahora >= fechaFinPrimera) {
        document.getElementById("btnSegundaAsistencia").disabled = false;
        document.getElementById("mensaje").textContent = "‚è≥ Puedes registrar tu segunda asistencia";
      } else {
        document.getElementById("btnSegundaAsistencia").disabled = true;
        document.getElementById("mensaje").textContent = "‚è≥ Espera a que termine el tiempo de la primera asistencia";
      }

      // Configurar contador regresivo
      actualizarContadorSegunda();
      intervaloSegunda = setInterval(actualizarContadorSegunda, 1000);

      document.getElementById("btnSegundaAsistencia").addEventListener("click", async () => {
        const ahora = new Date();

        // Verificar que est√© en el tiempo correcto para la segunda asistencia
        if (ahora < fechaFinPrimera) {
          document.getElementById("mensaje").textContent = "‚ùå A√∫n no es tiempo para la segunda asistencia";
          return;
        }

        const datos = {
          id: document.getElementById("idFormulario").value,
          visitanteId: visitanteId,
          asistenciaNumero: 2,
          fecha: new Date().toISOString()
        };

        try {
          const res = await fetch("/api/guardar", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(datos)
          });

          if (res.ok) {
            segundaAsistenciaCompletada = true;
            document.getElementById("btnSegundaAsistencia").disabled = true;
            document.getElementById("mensaje").textContent = "‚úÖ Segunda asistencia registrada";
            clearInterval(intervaloSegunda);

            // Actualizar estado local y backend
            await verificarEstadoRealAsistencias(datos.id);
            configurarTerceraAsistencia();
            cargarRespuestas(datos.id);
          } else {
            const errorText = await res.text();
            document.getElementById("mensaje").textContent = "‚ùå Error al registrar segunda asistencia: " + errorText;
          }
        } catch (error) {
          document.getElementById("mensaje").textContent = "‚ùå Error de conexi√≥n al registrar segunda asistencia";
        }
      });
    }

    function actualizarContadorSegunda() {
      const ahora = new Date();
      const restante = fechaFinSegunda - ahora;

      if (restante <= 0) {
        clearInterval(intervaloSegunda);
        document.getElementById("contadorSegunda").textContent = "‚è∞ Tiempo agotado para segunda asistencia";
        document.getElementById("btnSegundaAsistencia").disabled = true;
        document.getElementById("mensaje").textContent = "‚ùå El tiempo para la segunda asistencia ha expirado";
        return;
      }

      const minutos = Math.floor((restante / 1000 / 60) % 60);
      const segundos = Math.floor((restante / 1000) % 60);
      document.getElementById("tiempoSegunda").textContent =
        `${minutos}:${segundos.toString().padStart(2, "0")}`;

      // Activar el bot√≥n solo cuando haya pasado el tiempo de la primera asistencia
      if (ahora >= fechaFinPrimera) {
        document.getElementById("btnSegundaAsistencia").disabled = false;
      }
    }

    function configurarTerceraAsistencia() {
      const ahora = new Date();

      // Ocultar segunda asistencia
      document.getElementById("contadorSegunda").style.display = "none";
      document.getElementById("btnSegundaAsistencia").style.display = "none";

      // Si el tiempo de la tercera asistencia ya pas√≥, mostrar mensaje
      if (ahora > fechaFinTercera) {
        document.getElementById("contadorTercera").textContent = "‚è∞ Tiempo agotado para tercera asistencia";
        document.getElementById("contadorTercera").style.display = "block";
        document.getElementById("mensaje").textContent = "‚ùå El tiempo para la tercera asistencia ha expirado";
        return;
      }

      // Mostrar tercera asistencia
      document.getElementById("btnTerceraAsistencia").style.display = "block";
      document.getElementById("contadorTercera").style.display = "block";

      // Solo activar el bot√≥n si ya pas√≥ el tiempo de la segunda asistencia
      if (ahora >= fechaFinSegunda) {
        document.getElementById("btnTerceraAsistencia").disabled = false;
        document.getElementById("mensaje").textContent = "‚è≥ Puedes registrar tu tercera asistencia";
      } else {
        document.getElementById("btnTerceraAsistencia").disabled = true;
        document.getElementById("mensaje").textContent = "‚è≥ Espera a que termine el tiempo de la segunda asistencia";
      }

      // Configurar contador regresivo
      actualizarContadorTercera();
      intervaloTercera = setInterval(actualizarContadorTercera, 1000);

      document.getElementById("btnTerceraAsistencia").addEventListener("click", async () => {
        const ahora = new Date();

        // Verificar que est√© en el tiempo correcto para la tercera asistencia
        if (ahora < fechaFinSegunda) {
          document.getElementById("mensaje").textContent = "‚ùå A√∫n no es tiempo para la tercera asistencia";
          return;
        }

        const datos = {
          id: document.getElementById("idFormulario").value,
          visitanteId: visitanteId,
          asistenciaNumero: 3,
          fecha: new Date().toISOString()
        };

        try {
          const res = await fetch("/api/guardar", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(datos)
          });

          if (res.ok) {
            terceraAsistenciaCompletada = true;
            document.getElementById("btnTerceraAsistencia").disabled = true;
            document.getElementById("mensaje").textContent = "‚úÖ Tercera asistencia registrada. ¬°Completaste todas las asistencias!";
            clearInterval(intervaloTercera);

            // Actualizar estado local y backend
            await verificarEstadoRealAsistencias(datos.id);
            mostrarEstadoFinal();
            cargarRespuestas(datos.id);
          } else {
            const errorText = await res.text();
            document.getElementById("mensaje").textContent = "‚ùå Error al registrar tercera asistencia: " + errorText;
          }
        } catch (error) {
          document.getElementById("mensaje").textContent = "‚ùå Error de conexi√≥n al registrar tercera asistencia";
        }
      });
    }

    function actualizarContadorTercera() {
      const ahora = new Date();
      const restante = fechaFinTercera - ahora;

      if (restante <= 0) {
        clearInterval(intervaloTercera);
        document.getElementById("contadorTercera").textContent = "‚è∞ Tiempo agotado para tercera asistencia";
        document.getElementById("btnTerceraAsistencia").disabled = true;
        document.getElementById("mensaje").textContent = "‚ùå El tiempo para la tercera asistencia ha expirado";
        return;
      }

      const minutos = Math.floor((restante / 1000 / 60) % 60);
      const segundos = Math.floor((restante / 1000) % 60);
      document.getElementById("tiempoTercera").textContent =
        `${minutos}:${segundos.toString().padStart(2, "0")}`;

      // Activar el bot√≥n solo cuando haya pasado el tiempo de la segunda asistencia
      if (ahora >= fechaFinSegunda) {
        document.getElementById("btnTerceraAsistencia").disabled = false;
      }
    }

    // Mostrar respuestas del formulario en la tabla
    // Mostrar respuestas del formulario en la tabla
    async function cargarRespuestas(idFormulario) {
      const tablaBody = document.querySelector("#tablaRespuestas tbody");
      tablaBody.innerHTML = "<tr><td colspan='10'>Cargando respuestas...</td></tr>";

      try {
        const res = await fetch(`/api/verRespuestas?id=${idFormulario}`);
        if (!res.ok) {
          tablaBody.innerHTML = "<tr><td colspan='10'>No hay respuestas a√∫n.</td></tr>";
          return;
        }

        const data = await res.json();
        const respuestas = data.asistencias || [];
        const resultadosExamen = data.examenes || [];

        if (!respuestas.length) {
          tablaBody.innerHTML = "<tr><td colspan='10'>No hay respuestas a√∫n.</td></tr>";
          return;
        }

        // Agrupar respuestas por visitanteId
        const respuestasAgrupadas = {};
        respuestas.forEach(r => {
          if (!respuestasAgrupadas[r.visitanteId]) {
            respuestasAgrupadas[r.visitanteId] = {
              nombre: r.nombre || 'N/A',
              correo: r.correo || 'N/A',
              edad: r.edad || 'N/A',
              telefono: r.telefono || 'N/A',
              asociacion: r.asociacion || 'N/A',
              fecha: r.fecha,
              maxAsistencia: 0,
              asistencias: [],
              visitanteId: r.visitanteId
            };
          }

          if (r.asistenciaNumero) {
            respuestasAgrupadas[r.visitanteId].asistencias.push(r.asistenciaNumero);
            respuestasAgrupadas[r.visitanteId].maxAsistencia = Math.max(
              respuestasAgrupadas[r.visitanteId].maxAsistencia,
              r.asistenciaNumero
            );
          }
        });

        // Combinar con resultados de examen
        resultadosExamen.forEach(resultado => {
          if (respuestasAgrupadas[resultado.visitanteId]) {
            respuestasAgrupadas[resultado.visitanteId].examen = resultado;
          }
        });

        tablaBody.innerHTML = "";
        Object.values(respuestasAgrupadas).forEach((r, index) => {
          const asistioCompleto = r.maxAsistencia >= 3 ? "S√ç" : "NO";
          const puedeExamen = r.maxAsistencia >= 3;

          // VERIFICAR SI ES EL USUARIO ACTUAL
          const esUsuarioActual = r.visitanteId === visitanteId;

          // En la parte de la tabla, cambiar el bot√≥n a:
          const fila = `
  <tr>
    <td>${index + 1}</td>
    <td>${r.nombre}</td>
    <td>${r.correo}</td>
    <td>${r.edad}</td>
    <td>${r.telefono}</td>
    <td>${r.asociacion}</td>
    <td>${new Date(r.fecha).toLocaleString()}</td>
    <td>${r.maxAsistencia}</td>
    <td>${asistioCompleto}</td>
    <td>
      ${esUsuarioActual && puedeExamen
              ? (r.examen
                ? `<button onclick="verResultadosExamen()" style="background: #17a2b8; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">üìä Ver Resultados</button>`
                : `<button onclick="iniciarExamen()">üìù Hacer Examen</button>`)
              : (esUsuarioActual
                ? '‚è≥ Complete las 3 asistencias'
                : (r.examen ? '‚úÖ Examen completado' : '‚ùå Examen no realizado'))}
    </td>
  </tr>
`;
          tablaBody.insertAdjacentHTML("beforeend", fila);
        });

      } catch (error) {
        tablaBody.innerHTML = "<tr><td colspan='10'>Error al cargar respuestas.</td></tr>";
        console.error(error);
      }
    }




    document.getElementById("formulario").addEventListener("submit", async function (e) {
      e.preventDefault();

      const datos = Object.fromEntries(new FormData(this).entries());
      datos.visitanteId = visitanteId;
      datos.asistenciaNumero = 1;

      // Validar que est√© en el tiempo correcto para la primera asistencia
      const ahora = new Date();
      if (ahora > fechaFinPrimera) {
        document.getElementById("mensaje").textContent = "‚ùå El tiempo para la primera asistencia ha expirado";
        return;
      }

      try {
        const res = await fetch("/api/guardar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(datos)
        });

        const mensaje = document.getElementById("mensaje");
        if (res.ok) {
          mensaje.textContent = "‚úÖ Primera asistencia registrada. ¬°Gracias!";
          this.reset();
          this.style.display = "none";
          primeraAsistenciaCompletada = true;

          // Limpiar intervalo de primera asistencia
          if (intervaloPrimera) clearInterval(intervaloPrimera);

          // Actualizar estado en el backend y configurar siguiente asistencia
          await verificarEstadoRealAsistencias(datos.id);
          configurarSegundaAsistencia();
          cargarRespuestas(datos.id);
        } else {
          const errorText = await res.text();
          mensaje.textContent = "‚ùå Ocurri√≥ un error al guardar: " + errorText;
        }
      } catch (error) {
        document.getElementById("mensaje").textContent = "‚ùå Error de conexi√≥n al guardar";
      }
    });

    // ========== SISTEMA DE EVALUACI√ìN ==========

    let examenModal = null;
    let examenActual = null;

    // Funci√≥n mejorada para iniciar examen
    // Funci√≥n mejorada para iniciar examen
    async function iniciarExamen() {
      const idFormulario = document.getElementById("idFormulario").value;

      // VERIFICAR PRIMERO QUE EL USUARIO TENGA DERECHO AL EXAMEN
      try {
        const res = await fetch(`/api/verRespuestas?id=${idFormulario}`);
        if (res.ok) {
          const data = await res.json();
          const respuestas = data.asistencias || [];

          // Buscar las respuestas del usuario actual
          const misRespuestas = respuestas.filter(r => r.visitanteId === visitanteId);
          const maxAsistencia = Math.max(...misRespuestas.map(r => r.asistenciaNumero || 0));

          if (maxAsistencia < 3) {
            document.getElementById("mensaje").textContent = "‚ùå Debes completar las 3 asistencias antes de hacer el examen";
            return;
          }

          // Verificar si ya hizo el examen
          const resultadosExamen = data.examenes || [];
          const miExamen = resultadosExamen.find(e => e.visitanteId === visitanteId);

          if (miExamen) {
            document.getElementById("mensaje").textContent = "‚úÖ Ya completaste el examen. Puedes ver tus resultados con el bot√≥n 'Ver Resultados'.";
            return;
          }

        } else {
          document.getElementById("mensaje").textContent = "‚ùå Error al verificar estado del examen";
          return;
        }
      } catch (error) {
        document.getElementById("mensaje").textContent = "‚ùå Error de conexi√≥n al verificar examen";
        return;
      }

      // Si pasa todas las verificaciones, crear modal de examen
      if (!examenModal) {
        crearModalExamen();
      }

      // Cargar evaluaci√≥n
      cargarEvaluacion(idFormulario);
    }

    // Crear modal para el examen
    function crearModalExamen() {
      examenModal = document.createElement('div');
      examenModal.id = 'examenModal';
      examenModal.style.cssText = `
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 10000;
    overflow-y: auto;
  `;

      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
    position: relative;
    background: white;
    margin: 50px auto;
    padding: 30px;
    border-radius: 15px;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  `;

      modalContent.innerHTML = `
    <h2 style="color: #2c3e50; margin-bottom: 20px; text-align: center;">üìù Examen de Especialidad</h2>
    <div id="examenContent"></div>
    <div style="margin-top: 30px; text-align: center;">
      <button id="btnEnviarExamen" style="
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 16px;
        font-weight: bold;
        border-radius: 8px;
        cursor: pointer;
        margin: 0 10px;
      ">‚úÖ Enviar Examen</button>
      <button id="btnCerrarExamen" style="
        background: #6c757d;
        color: white;
        border: none;
        padding: 15px 30px;
        font-size: 16px;
        border-radius: 8px;
        cursor: pointer;
        margin: 0 10px;
      ">‚ùå Cancelar</button>
    </div>
    <div id="resultadoExamen" style="margin-top: 20px; display: none;"></div>
  `;

      examenModal.appendChild(modalContent);
      document.body.appendChild(examenModal);

      // Event listeners
      document.getElementById('btnCerrarExamen').addEventListener('click', cerrarExamen);
      document.getElementById('btnEnviarExamen').addEventListener('click', enviarExamen);
    }

    // Cargar evaluaci√≥n desde el backend
    async function cargarEvaluacion(idFormulario) {
      try {
        const res = await fetch(`/api/obtenerEvaluacion?id=${idFormulario}`);

        if (!res.ok) {
          throw new Error('No se pudo cargar la evaluaci√≥n');
        }

        const evaluacion = await res.json();

        // Verificar que la evaluaci√≥n tenga contenido
        if (!evaluacion || !Array.isArray(evaluacion) || evaluacion.length === 0) {
          throw new Error('No hay evaluaci√≥n disponible para este formulario');
        }

        examenActual = evaluacion;
        mostrarExamen(examenActual);
        examenModal.style.display = 'block';

      } catch (error) {
        console.error('Error al cargar evaluaci√≥n:', error);
        alert('‚ùå ' + error.message);
      }
    }

    // Mostrar examen en el modal
    function mostrarExamen(evaluacion) {
      const examenContent = document.getElementById('examenContent');
      examenContent.innerHTML = '';

      if (!evaluacion || evaluacion.length === 0) {
        examenContent.innerHTML = '<p>No hay preguntas disponibles para este examen.</p>';
        return;
      }

      evaluacion.forEach((pregunta, index) => {
        const preguntaDiv = document.createElement('div');
        preguntaDiv.className = 'pregunta-examen';
        preguntaDiv.style.cssText = `
      margin-bottom: 25px;
      padding: 20px;
      border: 2px solid #e9ecef;
      border-radius: 10px;
      background: #f8f9fa;
    `;

        preguntaDiv.innerHTML = `
      <h3 style="color: #2c3e50; margin-bottom: 15px;">Pregunta ${index + 1}: ${pregunta.text}</h3>
      <div class="opciones" data-pregunta-id="${pregunta.id}">
        ${pregunta.options.map((opcion, optIndex) => `
          <label style="display: block; margin: 10px 0; padding: 10px; background: white; border-radius: 5px; cursor: pointer;">
            <input type="radio" 
                   name="pregunta_${pregunta.id}" 
                   value="${opcion.id}"
                   style="margin-right: 10px;">
            ${String.fromCharCode(65 + optIndex)}) ${opcion.text}
          </label>
        `).join('')}
      </div>
    `;

        examenContent.appendChild(preguntaDiv);
      });
    }

    // Cerrar modal de examen
    function cerrarExamen() {
      if (examenModal) {
        examenModal.style.display = 'none';
        document.getElementById('resultadoExamen').style.display = 'none';
        document.getElementById('btnEnviarExamen').style.display = 'block';
      }
    }

    // Enviar examen y calificar
    // Enviar examen y calificar
    // Enviar examen y calificar
    async function enviarExamen() {
      if (!examenActual) return;

      const respuestas = {};
      let todasRespondidas = true;

      // Recopilar respuestas
      examenActual.forEach(pregunta => {
        const opcionSeleccionada = document.querySelector(`input[name="pregunta_${pregunta.id}"]:checked`);

        if (opcionSeleccionada) {
          respuestas[pregunta.id] = opcionSeleccionada.value;
        } else {
          todasRespondidas = false;
        }
      });

      if (!todasRespondidas) {
        alert('‚ùå Por favor responde todas las preguntas antes de enviar el examen.');
        return;
      }

      // Calificar examen
      let puntaje = 0;
      examenActual.forEach(pregunta => {
        const respuestaUsuario = respuestas[pregunta.id];
        const respuestaCorrecta = pregunta.options.find(opt => opt.correct);

        if (respuestaCorrecta && respuestaUsuario === respuestaCorrecta.id) {
          puntaje++;
        }
      });

      const porcentaje = (puntaje / examenActual.length) * 100;

      // Mostrar loading
      const btnEnviar = document.getElementById('btnEnviarExamen');
      const textoOriginal = btnEnviar.textContent;
      btnEnviar.innerHTML = 'Enviando... <div class="loading" style="display: inline-block; margin-left: 10px;"></div>';
      btnEnviar.disabled = true;

      try {
        const res = await fetch('/api/guardarResultadoExamen', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: document.getElementById("idFormulario").value,
            visitanteId: visitanteId,
            respuestas: respuestas,
            puntaje: porcentaje
          })
        });

        if (res.ok) {
          // Mostrar retroalimentaci√≥n en lugar de la nota
          mostrarResultadoExamen(porcentaje, puntaje, examenActual.length, respuestas);

          // Recargar la tabla para actualizar el estado
          setTimeout(() => {
            cargarRespuestas(document.getElementById("idFormulario").value);
          }, 2000);
        } else {
          const errorData = await res.json();
          alert('‚ùå Error al guardar el resultado: ' + (errorData.error || 'Error desconocido'));
          btnEnviar.textContent = textoOriginal;
          btnEnviar.disabled = false;
        }
      } catch (error) {
        console.error('Error al enviar examen:', error);
        alert('‚ùå Error de conexi√≥n al enviar el examen.');
        btnEnviar.textContent = textoOriginal;
        btnEnviar.disabled = false;
      }
    }

    // Mostrar resultado del examen
    // Mostrar resultado del examen despu√©s de enviarlo
    function mostrarResultadoExamen(porcentaje, correctas, total, respuestasUsuario) {
      const resultadoDiv = document.getElementById('resultadoExamen');
      const btnEnviar = document.getElementById('btnEnviarExamen');

      btnEnviar.style.display = 'none';

      let mensaje = '';
      let color = '';

      if (porcentaje >= 70) {
        mensaje = 'üéâ ¬°Felicidades! Has aprobado el examen.';
        color = '#28a745';
      } else {
        mensaje = 'üìö Necesitas estudiar m√°s. Int√©ntalo de nuevo.';
        color = '#dc3545';
      }

      resultadoDiv.innerHTML = `
    <div style="text-align: center; padding: 20px; background: ${color}15; border-radius: 10px; border-left: 5px solid ${color};">
      <h3 style="color: ${color};">${mensaje}</h3>
      <p style="font-size: 16px; margin: 10px 0;">
        <strong>Resumen:</strong> ${correctas} de ${total} preguntas correctas
      </p>
      <div style="margin-top: 20px;">
        <button onclick="cerrarExamen()" style="
          background: ${color};
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 5px;
          cursor: pointer;
          margin: 5px;
        ">Cerrar</button>
        <button onclick="verDetallesResultados()" style="
          background: #17a2b8;
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 5px;
          cursor: pointer;
          margin: 5px;
        ">üìã Ver Detalles</button>
      </div>
    </div>
  `;

      resultadoDiv.style.display = 'block';

      // Guardar datos temporalmente para ver detalles
      window.examenRecienEnviado = {
        examen: examenActual,
        respuestas: respuestasUsuario,
        correctas: correctas,
        total: total
      };

      // Deshabilitar todas las opciones
      document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.disabled = true;
      });
    }

    // Funci√≥n para ver detalles despu√©s de enviar el examen
    function verDetallesResultados() {
      if (!window.examenRecienEnviado) return;

      const { examen, respuestas, correctas, total } = window.examenRecienEnviado;

      // Crear objeto resultado simulado
      const resultado = {
        respuestas: respuestas,
        puntaje: (correctas / total) * 100
      };

      mostrarModalResultados(examen, resultado);
      cerrarExamen(); // Cerrar el modal de examen
    }

    // Funci√≥n para redirigir a la p√°gina de resultados (futura implementaci√≥n)
    // Funci√≥n para mostrar los resultados del examen en un modal
    async function verResultadosExamen() {
      const idFormulario = document.getElementById("idFormulario").value;

      try {
        // Obtener los resultados del examen del usuario
        const res = await fetch(`/api/obtenerResultadoExamen?id=${idFormulario}&visitanteId=${visitanteId}`);

        if (!res.ok) {
          throw new Error('No se pudieron cargar los resultados');
        }

        const resultado = await res.json();

        // Obtener las preguntas del examen para la retroalimentaci√≥n
        const resExamen = await fetch(`/api/obtenerEvaluacion?id=${idFormulario}`);

        if (!resExamen.ok) {
          throw new Error('No se pudo cargar la evaluaci√≥n');
        }

        const examen = await resExamen.json();

        // Mostrar modal con resultados
        mostrarModalResultados(examen, resultado);

      } catch (error) {
        console.error('Error al cargar resultados:', error);
        document.getElementById("mensaje").textContent = "‚ùå Error al cargar los resultados del examen";
      }
    }


    // Funci√≥n para mostrar el modal con los resultados del examen
    function mostrarModalResultados(examen, resultado) {
      // Crear modal si no existe
      if (!resultadosModal) {
        crearModalResultados();
      }

      const contenidoResultados = document.getElementById('contenidoResultados');
      const respuestasUsuario = resultado.respuestas;

      // Calcular estad√≠sticas
      let correctas = 0;
      examen.forEach(pregunta => {
        const respuestaUsuario = respuestasUsuario[pregunta.id];
        const respuestaCorrecta = pregunta.options.find(opt => opt.correct);
        if (respuestaCorrecta && respuestaUsuario === respuestaCorrecta.id) {
          correctas++;
        }
      });

      const total = examen.length;

      // Generar contenido de retroalimentaci√≥n
      let retroalimentacionHTML = `
    <div style="text-align: center; margin-bottom: 20px;">
      <h3 style="color: #2c3e50;">üìä Resultados de tu Examen</h3>
      <p style="font-size: 18px; margin: 10px 0;">
        <strong>Resumen:</strong> ${correctas} de ${total} preguntas correctas
      </p>
    </div>
    <div style="max-height: 400px; overflow-y: auto; padding-right: 10px;">
  `;

      // Mostrar cada pregunta con retroalimentaci√≥n
      examen.forEach((pregunta, index) => {
        const respuestaUsuario = respuestasUsuario[pregunta.id];
        const respuestaCorrecta = pregunta.options.find(opt => opt.correct);
        const opcionUsuario = pregunta.options.find(opt => opt.id === respuestaUsuario);

        const esCorrecta = respuestaCorrecta && respuestaUsuario === respuestaCorrecta.id;

        retroalimentacionHTML += `
      <div style="margin-bottom: 20px; padding: 15px; border: 2px solid ${esCorrecta ? '#28a745' : '#dc3545'}; border-radius: 8px; background: #f8f9fa;">
        <p style="margin: 0 0 10px 0; font-weight: bold; color: #2c3e50;">
          Pregunta ${index + 1}: ${pregunta.text}
        </p>
        <p style="margin: 0 0 8px 0; color: ${esCorrecta ? '#28a745' : '#dc3545'}; font-weight: bold;">
          ${esCorrecta ? '‚úÖ Correcta' : '‚ùå Incorrecta'}
        </p>
        <p style="margin: 0 0 5px 0; font-size: 14px;">
          <strong>Tu respuesta:</strong> ${opcionUsuario ? opcionUsuario.text : 'No respondida'}
        </p>
        ${!esCorrecta ? `
          <p style="margin: 0 0 5px 0; font-size: 14px; color: #28a745;">
            <strong>Respuesta correcta:</strong> ${respuestaCorrecta.text}
          </p>
        ` : ''}
      </div>
    `;
      });

      retroalimentacionHTML += '</div>';

      contenidoResultados.innerHTML = retroalimentacionHTML;
      resultadosModal.style.display = 'block';
    }


    let resultadosModal = null;

    // Crear modal para resultados
    function crearModalResultados() {
      resultadosModal = document.createElement('div');
      resultadosModal.id = 'resultadosModal';
      resultadosModal.style.cssText = `
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 10000;
    overflow-y: auto;
  `;

      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
    position: relative;
    background: white;
    margin: 50px auto;
    padding: 30px;
    border-radius: 15px;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
  `;

      modalContent.innerHTML = `
    <button id="btnCerrarResultados" style="
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6c757d;
    ">√ó</button>
    <div id="contenidoResultados"></div>
    <div style="margin-top: 20px; text-align: center;">
      <button onclick="cerrarModalResultados()" style="
        background: #6c757d;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
      ">Cerrar</button>
    </div>
  `;

      resultadosModal.appendChild(modalContent);
      document.body.appendChild(resultadosModal);

      // Event listeners para cerrar
      document.getElementById('btnCerrarResultados').addEventListener('click', cerrarModalResultados);
      resultadosModal.addEventListener('click', (e) => {
        if (e.target === resultadosModal) {
          cerrarModalResultados();
        }
      });
    }

    // Funci√≥n para cerrar el modal de resultados
    function cerrarModalResultados() {
      if (resultadosModal) {
        resultadosModal.style.display = 'none';
      }
    }
  </script>
</body>

</html>